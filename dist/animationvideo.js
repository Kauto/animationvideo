"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var i=require("@ctrl/tinycolor/dist/module/public_api.js"),s=t(require("pasition")),h=require("stackblur-canvas/dist/stackblur-es.js"),e=t(require("eases"));function r(t,i=null){return"function"==typeof t?t.apply(i,[].slice.call(arguments,2)):t}function n(t){return null==t?[]:Array.isArray(t)?t:[t]}function o(t,i,s){if(!t.s){if(s instanceof a){if(!s.s)return void(s.o=o.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(o.bind(null,t,i),o.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const a=function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{o(h,1,t(this.v))}catch(t){o(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?o(h,1,i?i(e):e):s?o(h,1,s(e)):o(h,2,e)}catch(t){o(h,2,t)}},h},t}();function c(t){return t instanceof a&&1&t.s}class u{constructor(){this.Images={},this.count=0,this.loaded=0}static add(t,i){const s=this||u;for(const h in t)if(s.Images[h])i&&"function"==typeof i[h]&&i[h](h,s.Images[h]);else{if(s.Images[h]=new window.Image,s.Images[h].onload=function(){s.loaded++,i&&"function"==typeof i?s.isLoaded()&&i():i&&"function"==typeof i[h]&&i[h](h,s.Images[h]),s.resolve&&s.isLoaded()&&(s.resolve(),s.resolve=null)},"<svg"===t[h].substr(0,4)){const i=window.URL||window.webkitURL||window,e=new window.Blob([t[h]],{type:"image/svg+xml"});s.Images[h].src=i.createObjectURL(e)}else/^(https?:)?\/\//.test(t[h])&&(s.Images[h].onerror=()=>{const i=new window.Image;i.onload=s.Images[h].onload,s.Images[h]=i,s.Images[h].src=t[h]},s.Images[h].crossOrigin="anonymous"),s.Images[h].src=t[h];s.count++}return i&&"function"==typeof i&&s.isLoaded()&&i(),s.resolve&&s.isLoaded()&&(s.resolve(),s.resolve=null),s}static reset(){const t=this||u;return t.Images={},t.count=0,t.loaded=0,t}static getLoaded(){return(this||u).loaded}static getCount(){return(this||u).count}static isLoaded(){const t=this||u;return t.loaded===t.count}static getImage(t){return"object"==typeof t?t:(this||u).Images[t]}static isLoadedPromise(){const t=this||u;return!!t.isLoaded()||new Promise((i,s)=>{t.resolve=i})}}u.Images={},u.count=0,u.loaded=0;class l{constructor(t){this.t=[],this.i=[],this.h=0,this.u=0,this.l=void 0===t?[]:Array.isArray(t)?t:[t]}addElement(t){return this.addElementForId(t),t}addElements(t){return this.addElementsForIds(t),t}addElementForId(t){let i=this.t.length,s=this.u;this.t[s]=t,this.i[s]="function"==typeof t,i===s&&i++;let h=this.u+1;for(;h!==i&&this.t[h];)h++;return this.u=h,this.h>s&&(this.h=s),s}addElementsForIds(t){let i=this.t.length;return i===this.u?(this.t=this.t.concat(t),this.u=this.t.length,t.forEach((t,s)=>{this.i[i+s]="function"==typeof t}),Array.from({length:t.length},(t,s)=>s+i)):t.map(t=>this.addElement(t))}getById(t){return this.t[t]}getIdByElement(t){return this.t.indexOf(t)}deleteByElement(t){const i=this.getIdByElement(t);i>=0&&this.deleteById(i)}deleteById(t){let i=this.t.length-1;if(i>0&&t===i){for(this.t[t]=null;i&&!this.t[i-1];)i--;this.t.length=i,this.i.length=i,this.u=Math.min(this.u,i),this.h=Math.min(this.h,i)}else this.t[t]&&(this.t[t]=null,this.u=Math.min(this.u,t),this.h===t&&(this.h=t+1))}isCanvasId(t){return void 0===t||!this.l.length||this.l.includes(t)}forEach(t,i=0){let s,h;const e=this.t.length;for(s=this.h;s<e;s++)if(h=this.t[s],h&&!1===t({elementId:s,layerId:i,element:h,isFunction:this.i[s],layer:this}))return}getElementsByTag(t){let i=[];return this.forEach(({element:s,isFunction:h})=>{if(!h){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}}),i}play(t="",i=0){this.forEach(({element:s,isFunction:h})=>!h&&s.play(t,i))}count(){let t=0;const i=this.t.length;for(let s=this.h;s<i;s++)this.t[s]&&t++;return t}clear(){this.t=[],this.i=[],this.h=0,this.u=0}}class d{constructor(){this.p=[]}addLayer(t){return this.p[this.p.length]=new l(t),this.p[this.p.length-1]}addLayers(t=1,i){let s=Array.from({length:t},t=>new l(i));return this.p=this.p.concat(s),s}addLayerForId(t){return this.p[this.p.length]=new l(t),this.p.length-1}addLayersForIds(t=1,i){const s=Array.from({length:t},(t,i)=>i+this.p.length);return this.p=this.p.concat(Array.from({length:t},t=>new l(i))),s}getById(t){return this.p[t]}forEach(t,i){let s;const h=this.p.length;for(s=0;s<h&&(!this.p[s].isCanvasId(i)||!1!==this.p[s].forEach(t,s));s++);}play(t="",i=0){this.forEach(({element:s,isFunction:h})=>!h&&s.play(t,i))}getElementsByTag(t){let i=[];return this.forEach(({element:s,isFunction:h})=>{if(!h){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}}),i}count(){return this.p.length}clear(){this.p=[]}}function f(){this.reset()}function m(t,i){return null==t||""===t?i:t}f.prototype.reset=function(){return this.m=[1,0,0,1,0,0],this},f.prototype.multiply=function(t){var i=this.m[1]*t.m[0]+this.m[3]*t.m[1],s=this.m[0]*t.m[2]+this.m[2]*t.m[3],h=this.m[1]*t.m[2]+this.m[3]*t.m[3],e=this.m[0]*t.m[4]+this.m[2]*t.m[5]+this.m[4],r=this.m[1]*t.m[4]+this.m[3]*t.m[5]+this.m[5];return this.m[0]=this.m[0]*t.m[0]+this.m[2]*t.m[1],this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this},f.prototype.invert=function(){var t=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),i=-this.m[1]*t,s=-this.m[2]*t,h=this.m[0]*t,e=t*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),r=t*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=this.m[3]*t,this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this},f.prototype.rotate=function(t){var i=Math.cos(t),s=Math.sin(t),h=this.m[1]*i+this.m[3]*s,e=this.m[0]*-s+this.m[2]*i,r=this.m[1]*-s+this.m[3]*i;return this.m[0]=this.m[0]*i+this.m[2]*s,this.m[1]=h,this.m[2]=e,this.m[3]=r,this},f.prototype.translate=function(t,i){return this.m[4]+=this.m[0]*t+this.m[2]*i,this.m[5]+=this.m[1]*t+this.m[3]*i,this},f.prototype.scale=function(t,i){return this.m[0]*=t,this.m[1]*=t,this.m[2]*=i,this.m[3]*=i,this},f.prototype.transformPoint=function(t,i){var s=t;return[t=s*this.m[0]+i*this.m[2]+this.m[4],i=s*this.m[1]+i*this.m[3]+this.m[5]]},f.prototype.clone=function(){var t=new f;return t.m=this.m.slice(0),t};class v{constructor(t={}){this.type="timing",this.M=t,this.P=m(r(this.M.tickChunk),100/6),this.C=m(r(this.M.maxSkippedTickChunk),120),this.I=m(r(this.M.tickChunkTolerance),.1),this.totalTimePassed=0}init(){}currentTime(){return window.performance?performance.now():Date.now()}clampTime({timePassed:t}){const i=this.P?this.P*this.C:2e3;return t>i?i:t}shiftTime({timePassed:t}){return this.P?-t%this.P:0}get tickChunk(){return this.P}isChunked(){return this.P}hasOneChunkedFrame({timePassed:t}){return t>=this.P-this.I}calcFrames({timePassed:t}){return Math.min(this.C,Math.floor((t+this.I)/this.P))}}const p="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function y(t,i,s){if(!t.s){if(s instanceof g){if(!s.s)return void(s.o=y.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(y.bind(null,t,i),y.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const g=function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{y(h,1,t(this.v))}catch(t){y(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?y(h,1,i?i(e):e):s?y(h,1,s(e)):y(h,2,e)}catch(t){y(h,2,t)}},h},t}();function w(t){return t instanceof g&&1&t.s}class M{constructor(t){this.duration=r(t)-0}run(t,i){return i-this.duration}}class b{constructor(){var t=[].slice.call(arguments);let i=0;"number"==typeof t[0]&&(i=t.shift()),this.sequences=t.map(t=>{Array.isArray(t)||(t=[t]);let s=i;return"number"==typeof t[0]&&(s=t.shift()),{position:0,timelapsed:-s,sequence:t.map(t=>"function"!=typeof t.run?"number"==typeof t?new M(t):{run:t}:t).filter(t=>"function"==typeof t.run),label:t.reduce((t,i,s)=>("string"==typeof i&&(t[i]=s-Object.keys(t).length),t),{}),enabled:!0}}),this.lastTimestamp=0,this.enabled=!0}reset(t=0){this.sequences.forEach(i=>{i.enabled=!0,i.position=0,i.timelapsed=t,i.sequence[0]&&i.sequence[0].reset&&i.sequence[0].reset(t)}),this.enabled=!0}play(t="",i=0){if(t){const s=this.sequences.reduce((s,h)=>(h.label.hasOwnProperty(t)?(s=!0,h.position=h.label[t],h.enabled=!0,h.timelapsed=i,h.sequence[h.position]&&h.sequence[h.position].reset&&h.sequence[h.position].reset()):s|=h.sequence.find(s=>s.play&&s.play(t,i))>=0,s),!1);return s&&(this.enabled=!0),s}return this.sequences.forEach(t=>t.enabled=!0),this.enabled=!0,!0}T(t,i,s){let h=s;for(;i.sequence[i.position]&&h>=0;){if(i.timelapsed+=h,i.timelapsed<0)return-1;if(h=i.sequence[i.position].run(t,i.timelapsed),!0===h)h=0;else{if(!1===h)return-1;if(h===b.F)return i.enabled=!1,this.enabled=!1,s;if(h===b.k)return i.enabled=!1,s;if(h===b.O)return!0}if(h>=0&&(i.position=(i.position+1)%i.sequence.length,i.sequence[i.position]&&i.sequence[i.position].reset&&i.sequence[i.position].reset(),i.timelapsed=0,0===i.position))return i.enabled=!1,h}return h}run(t,i,s){let h=i;if(s||(h=i-this.lastTimestamp,this.lastTimestamp=i),!this.enabled)return h;const e=this.sequences.length;let r=0,n=Infinity;for(let i=0;i<e;i++)if(this.sequences[i].enabled){const s=this.T(t,this.sequences[i],h);if(!0===s)return!0;n=Math.min(n,s)}else r++;return r===e?(this.enabled=!1,h):n}}b.F="F",b.k="S",b.O="R";class x{constructor(t){this.S(this,this.j(),t),this._=!0}S(t,i,s){Object.keys(i).forEach(h=>{const e=i[h];t[h]="function"==typeof e?e(s[h],s,t):m(r(s[h]),e)})}A(){return{animation:(t,i)=>{let s=r(t);return Array.isArray(s)?new b(s):s},enabled:!0,isClickable:!1,tag:t=>Array.isArray(t)?t:t?[t]:[]}}j(){return Object.assign({},this.A(),{x:0,y:0,rotation:(t,i)=>m(r(t),m(r(i.rotationInRadian),.017453292519943295*m(r(i.rotationInDegree),0))),scaleX:(t,i)=>m(r(t),m(r(i.scale),1)),scaleY:(t,i)=>m(r(t),m(r(i.scale),1)),alpha:1,compositeOperation:"source-over",color:"#fff"})}getElementsByTag(t){if("function"==typeof t){if(this.tag.filter(t).length)return[this]}else if((Array.isArray(t)?t:[t]).filter(t=>this.tag.includes(t)).length)return[this];return[]}animate(t){return!(!this.animation||!0!==this.animation.run(this,t,!0)||(this.enabled=!1,0))}play(t="",i=0){this.animation&&this.animation.play&&this.animation.play(t,i)}init(t,i){}callInit(t,i){this._&&(this.init(t,i),this._=!1)}resize(t,i){}D(t,i,s,h,e){let r=!1;if(this.enabled&&this.isClickable){const n=this.width/2,o=this.height/2;t.save(),h?t.translate(this.x+n,this.y+o):t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.beginPath(),e?r=e(n,o):(t.rect(-n,-o,this.width,this.height),t.closePath(),r=t.isPointInPath(i,s)),t.restore()}return!!r&&this}detectDraw(t,i){}detect(t,i,s){return this.D(t,i,s,!1,()=>(t.arc(0,0,1,Math.PI/2+this.rotation,2.5*Math.PI-this.rotation,!1),t.isPointInPath(i,s)))}draw(t,i){this.enabled&&(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.beginPath(),t.fillStyle=this.color,t.arc(0,0,1,Math.PI/2+this.rotation,2.5*Math.PI-this.rotation,!1),t.fill(),t.restore())}}class P extends x{constructor(t){super(t)}j(){return Object.assign({},super.j(),{sprite:[]})}getElementsByTag(t){let i=super.getElementsByTag(t);for(const s of this.sprite){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}return i}animate(t){let i=super.animate(t),s=!1;if(this.enabled)for(const i of this.sprite)s=s||!0===i.animate(t);return this.animation?i:(s&&(this.enabled=!1),s)}play(t="",i=0){this.animation&&this.animation.play&&this.animation.play(t,i);for(const s of this.sprite)s.play&&s.play(t,i)}resize(t,i){for(const s of this.sprite)s.resize(t,i)}callInit(t,i){super.callInit(t,i);for(let s of this.sprite)s.callInit(t,i)}detectImage(t,i){if(this.enabled)for(const s of this.sprite)s.detectImage(t,i)}detect(t,i,s){if(this.enabled)for(const h of this.sprite){const e=h.detect(t,i,s);if(e)return e}return!1}draw(t,i){if(this.enabled){this.alpha<1&&((i=Object.assign({},i)).alpha*=this.alpha),t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation);for(const s of this.sprite)s.draw(t,i);t.restore()}}}class C extends P{constructor(t){super(t.self||{});let i=m(r(t.count),1);this.sprite=[];const s=t.class;for(let h=0;h<i;h++){let i={};for(let s in t)["self","class","count"].includes(s)||(i[s]="function"==typeof t[s]?t[s].call(t,h):t[s]);this.sprite[h]=new s(i)}}}class I extends x{constructor(t){super(t),this.L=!1}j(){return Object.assign({},super.j(),{x:void 0,y:void 0,width:void 0,height:void 0,gridSize:void 0,darker:0,pixel:!1,clear:!1,norm:(t,i,s)=>m(r(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height)})}N(t){const i=t.widthInPixel,s=t.heightInPixel;this.B=document.createElement("canvas"),this.gridSize?(this.L=this.gridSize,this.B.width=Math.round(this.L),this.B.height=Math.round(this.L)):(this.B.width=Math.ceil(i/this.scaleX),this.B.height=Math.ceil(s/this.scaleY)),this.W=this.B.getContext("2d"),this.W.globalCompositeOperation="source-over",this.W.globalAlpha=1}normalizeFullScreen(t){(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y),(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height)}resize(t,i){if(this.B&&this.L!==this.gridSize){const t=this.B;this.N(i),this.W.globalCompositeOperation="copy",this.W.drawImage(t,0,0,t.width,t.height,0,0,this.B.width,this.B.height),this.W.globalCompositeOperation="source-over"}this.normalizeFullScreen(i)}detect(t,i,s){return this.D(t,i,s,!1)}init(t,i){this.N(i),this.normalizeFullScreen(i)}draw(t,i){if(this.enabled&&this.alpha>0){this.gridSize&&this.L!==this.gridSize&&this.resize(t,i);const s=this.alpha*i.alpha,h=this.width,e=this.height,r=this.B.width,n=this.B.height;if(s>0&&r&&n){this.W.globalCompositeOperation="copy",this.W.globalAlpha=1,this.W.drawImage(t.canvas,0,0,t.canvas.width,t.canvas.height,0,0,r,n),this.darker>0&&(this.W.globalCompositeOperation=this.clear?"source-atop":"source-over",this.W.fillStyle="rgba(0,0,0,"+this.darker+")",this.W.fillRect(0,0,r,n)),this.additionalBlur&&this.additionalBlur(r,n,i),this.clear&&(t.globalCompositeOperation="source-over",t.globalAlpha=1,t.clearRect(this.x,this.y,h,e)),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=s;const o=t.imageSmoothingEnabled;t.imageSmoothingEnabled=!this.pixel,t.drawImage(this.B,0,0,r,n,this.x,this.y,h,e),t.imageSmoothingEnabled=o}}else this.clear&&(this.x||(this.x=i.x),this.y||(this.y=i.y),this.width||(this.width=i.width),this.height||(this.height=i.height),t.clearRect(this.x,this.y,this.width,this.height))}}class T extends x{constructor(t){super(t),this.U=!1}j(){return Object.assign({},super.j(),{image:t=>u.getImage(r(t)),position:T.CENTER,frameX:0,frameY:0,frameWidth:0,frameHeight:0,width:void 0,height:void 0,norm:!1,normCover:!1,normToScreen:!1,clickExact:!1,color:"#FFF",tint:0})}resize(t,i){this._=!0}init(t,i){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height;this.X=this.normToScreen?this.normCover?Math.max(i.fullScreen.width/s,i.fullScreen.height/h):this.norm?Math.min(i.fullScreen.width/s,i.fullScreen.height/h):1:this.normCover?Math.max(i.width/s,i.height/h):this.norm?Math.min(i.width/s,i.height/h):1}Y(){return[this.tint,this.frameWidth||this.image.width,this.frameHeight||this.image.height,this.color,this.frameX,this.frameY].join(";")}q(t,i){return this.B||(this.B=document.createElement("canvas"),this.W=this.B.getContext("2d")),this.B.width=t,this.B.height=i,this.W}detectDraw(t,i){if(this.enabled&&this.isClickable&&this.clickExact){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height,e=(this.width?this.width:s)*this.X*this.scaleX,r=(this.height?this.height:h)*this.X*this.scaleY,n=this.position===T.LEFT_TOP,o=this.q(s,h);o.globalAlpha=1,o.globalCompositeOperation="source-over",o.fillStyle=i,o.fillRect(0,0,s,h),o.globalCompositeOperation="destination-atop",o.drawImage(this.image,this.frameX,this.frameY,s,h,0,0,s,h),t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.drawImage(this.B,0,0,s,h,n?0:-e/2,n?0:-r/2,e,r),t.restore(),this.U=!1}}detect(t,i,s){return this.enabled&&this.isClickable&&this.clickExact?"c":this.D(t,i,s,!1)}draw(t,i){if(this.enabled&&this.image&&this.alpha>0){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height,e=(this.width?this.width:s)*this.X*this.scaleX,r=(this.height?this.height:h)*this.X*this.scaleY;t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha;const n=this.position===T.LEFT_TOP;if(this.tint&&this.U!==this.Y()){const t=this.q(s,h);t.globalAlpha=1,t.globalCompositeOperation="source-over",t.clearRect(0,0,s,h),t.globalAlpha=this.tint,t.fillStyle=this.color,t.fillRect(0,0,s,h),t.globalAlpha=1,t.globalCompositeOperation="destination-atop",t.drawImage(this.image,this.frameX,this.frameY,s,h,0,0,s,h),this.U=this.Y()}0==this.rotation?n?t.drawImage(this.tint?this.B:this.image,this.tint?0:this.frameX,this.tint?0:this.frameY,s,h,this.x,this.y,e,r):t.drawImage(this.tint?this.B:this.image,this.tint?0:this.frameX,this.tint?0:this.frameY,s,h,this.x-e/2,this.y-r/2,e,r):(t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.drawImage(this.tint?this.B:this.image,this.tint?0:this.frameX,this.tint?0:this.frameY,s,h,n?0:-e/2,n?0:-r/2,e,r),t.restore())}}}T.LEFT_TOP=0,T.CENTER=1;class F extends x{constructor(t){super(t)}j(){return Object.assign({},super.j(),{text:void 0,font:"2em monospace",position:F.CENTER,color:void 0,borderColor:void 0,lineWidth:1})}detectDraw(t,i){this.enabled&&this.isClickable&&(t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),this.position||(t.textAlign="left",t.textBaseline="top"),t.font=this.font,t.fillStyle=i,t.fillText(this.text,0,0),t.restore())}detect(t,i){return"c"}draw(t,i){this.enabled&&(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.save(),this.position||(t.textAlign="left",t.textBaseline="top"),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.font=this.font,this.color&&(t.fillStyle=this.color,t.fillText(this.text,0,0)),this.borderColor&&(t.strokeStyle=this.borderColor,t.lineWidth=this.lineWidth,t.strokeText(this.text,0,0)),t.restore())}}F.LEFT_TOP=0,F.CENTER=1;class k extends x{constructor(t){super(t),this.R=void 0,this.H=!1}static getGradientImage(t,i,s){let h=t>>4,e=i>>4,r=s>>4;if(!k.G){const t=16;k.G=Array.from({length:t},i=>Array.from({length:t},i=>Array.from({length:t})))}return k.G[h][e][r]||(k.G[h][e][r]=k.generateGradientImage(h,e,r)),k.G[h][e][r]}static generateGradientImage(t,i,s){let h=document.createElement("canvas");h.width=h.height=64;let e=h.getContext("2d");e.globalAlpha=1,e.globalCompositeOperation="source-over",e.clearRect(0,0,64,64);let r=e.createRadialGradient(32,32,0,32,32,32);return r.addColorStop(0,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",1)"),r.addColorStop(.3,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0.4)"),r.addColorStop(1,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0)"),e.fillStyle=r,e.fillRect(0,0,64,64),h}resize(t,i){this.R=void 0}draw(t,s){if(this.enabled){this.color&&this.color.r||(this.color=new i.TinyColor(this.color).toRgb()),this.R!==this.scaleX&&(this.R=this.scaleX,this.H=this.scaleX*s.widthInPixel/s.width>64);const{r:h,g:e,b:r}=this.color;t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*s.alpha,t.imageSmoothingEnabled=this.H,t.drawImage(k.getGradientImage(h,e,r),0,0,64,64,this.x-this.scaleX/2,this.y-this.scaleY/2,this.scaleX,this.scaleY),t.imageSmoothingEnabled=!0}}}class O extends x{constructor(t){super(t)}j(){return Object.assign({},super.j(),{x:void 0,y:void 0,width:void 0,height:void 0,borderColor:void 0,color:void 0,lineWidth:1,clear:!1,norm:(t,i,s)=>m(r(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height),position:O.CENTER})}normalizeFullScreen(t){(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height),(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x,this.position===O.CENTER&&(this.x+=this.width/2)),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y,this.position===O.CENTER&&(this.y+=this.height/2))}resize(t,i){this._=!0}init(t,i){this.normalizeFullScreen(i)}detect(t,i,s){return this.D(t,i,s,this.position===O.LEFT_TOP)}draw(t,i){if(this.enabled&&this.alpha>0)if(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,0===this.rotation&&this.position===O.LEFT_TOP)this.clear?t.clearRect(this.x,this.y,this.width,this.height):this.color&&(t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)),this.borderColor&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.borderColor,t.rect(this.x,this.y,this.width,this.height),t.stroke());else{let i=this.width/2,s=this.height/2;t.save(),this.position===O.LEFT_TOP?t.translate(this.x+i,this.y+s):t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),this.clear?t.clearRect(-i,-s,this.width,this.height):this.color&&(t.fillStyle=this.color,t.fillRect(-i,-s,this.width,this.height)),this.borderColor&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.borderColor,t.rect(-i,-s,this.width,this.height),t.stroke()),t.restore()}}}O.LEFT_TOP=0,O.CENTER=1;var S={Callback:class extends x{constructor(t){"function"==typeof t&&(t={callback:t}),super(t),this.V=0,this.K=0}j(){return Object.assign({},this.A(),{callback:t=>void 0===typeof t?()=>{}:t})}animate(t){return this.enabled&&(this.V+=t,this.K+=t),super.animate(t)}detect(t,i){}draw(t,i){this.enabled&&this.callback(t,this.V,i,this),this.K=0}},Canvas:class extends P{constructor(t){super(t),this.L=!1,this.Z=2}j(){return Object.assign({},super.j(),{x:void 0,y:void 0,width:void 0,height:void 0,canvasWidth:void 0,canvasHeight:void 0,gridSize:void 0,norm:(t,i,s)=>m(r(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height),isDrawFrame:(t,i,s)=>m(t,!0)})}N(t){const i=t.widthInPixel,s=t.heightInPixel;this.B=document.createElement("canvas"),this.canvasWidth&&this.canvasHeight?(this.B.width=this.canvasWidth,this.B.height=this.canvasHeight):this.gridSize?(this.L=this.gridSize,this.B.width=Math.round(this.L),this.B.height=Math.round(this.L)):(this.B.width=Math.round(i/this.scaleX),this.B.height=Math.round(s/this.scaleY)),this.W=this.B.getContext("2d")}normalizeFullScreen(t){(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y),(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height)}resize(t,i){if(this.B&&this.L!==this.gridSize&&!this.canvasWidth){const t=this.B;this.N(i),this.W.globalCompositeOperation="copy",this.W.drawImage(t,0,0,t.width,t.height,0,0,this.B.width,this.B.height),this.W.globalCompositeOperation="source-over",this.Z=2}this.normalizeFullScreen(i),super.resize(t,i)}detect(t,i,s){return this.D(t,i,s,!1)}init(t,i){this.N(i),this.normalizeFullScreen(i)}draw(t,i){if(this.enabled){this.gridSize&&this.L!==this.gridSize&&this.resize(i),this.Z=Math.max(this.Z-1,r(this.isDrawFrame,t,i));const s=this.width,h=this.height,e=s/2,n=h/2,o=this.B.width,a=this.B.height;if(this.Z){this.W.textBaseline="middle",this.W.textAlign="center",this.W.globalAlpha=1,this.W.globalCompositeOperation="source-over",this.W.save();const t=i.cam;if(this.norm&&t){const i=Math.max(o,a)/2;this.W.translate(o/2,a/2),this.W.scale(i,i),this.W.scale(t.zoom,t.zoom),this.W.translate(-t.x,-t.y)}for(const t of this.sprite)t.draw(this.W,this.norm?Object.assign({},i,{alpha:1,widthInPixel:o,heightInPixel:a}):{alpha:1,x:0,y:0,width:o,height:a,widthInPixel:o,heightInPixel:a,visibleScreen:{x:0,y:0,width:o,height:a}});this.W.restore()}t.save(),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.translate(this.x+e,this.y+n),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.drawImage(this.B,0,0,o,a,-e,-n,s,h),t.restore()}}},Circle:x,Emitter:C,FastBlur:I,Group:P,Image:T,Text:F,Particle:k,Path:class extends P{constructor(t){if(super(t),this.oldPath=void 0,this.path2D=new Path2D,this.polyfill)if("function"!=typeof Path2D){let t=document.getElementsByTagName("head")[0],i=document.createElement("script");i.type="text/javascript",i.src="https://cdn.jsdelivr.net/npm/canvas-5-polyfill@0.1.5/canvas.min.js",t.appendChild(i)}else{let t=document.createElement("canvas").getContext("2d");t.stroke(new Path2D("M0,0H1")),t.getImageData(0,0,1,1).data[3]&&(this.polyfill=!1)}}j(){return Object.assign({},super.j(),{path:void 0,color:void 0,borderColor:void 0,lineWidth:1,clip:!1,fixed:!1,polyfill:!0})}changeToPathInit(t,i){return s.J("string"==typeof t?s.path2shapes(t):t,"string"==typeof i?s.path2shapes(i):i)}changeToPath(t,i,h){return s.$(i.pathFrom,i.pathTo,t)}detect(t,i,s){return this.D(t,i,s,!1,()=>t.isPath(this.path2D,i,s))}draw(t,i){if(this.enabled){const h=this.alpha*i.alpha;this.oldPath!==this.path&&(this.polyfill&&"string"==typeof this.path&&(this.path=s.path2shapes(this.path)),Array.isArray(this.path)?(this.path2D=new Path2D,this.path.forEach(t=>{this.path2D.moveTo(t[0][0],t[0][1]),t.forEach(t=>{this.path2D.bezierCurveTo(t[2],t[3],t[4],t[5],t[6],t[7])}),this.path2D.closePath()})):this.path2D=this.path instanceof Path2D?this.path:new Path2D(this.path),this.oldPath=this.path);let e=this.scaleX,r=this.scaleY;this.fixed&&(0==e&&(e=Number.EPSILON),0==r&&(r=Number.EPSILON)),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=h,t.save(),t.translate(this.x,this.y),t.scale(e,r),t.rotate(this.rotation),this.color&&(t.fillStyle=this.color,t.fill(this.path2D)),t.save(),this.clip&&(t.clip(this.path2D),this.fixed&&(t.rotate(-this.rotation),t.scale(1/e,1/r),t.translate(-this.x,-this.y)));for(const s of this.sprite)s.draw(t,i);t.restore(),this.borderColor&&(t.strokeStyle=this.borderColor,t.lineWidth=this.lineWidth,t.stroke(this.path2D)),t.restore()}}},Rect:O,Scroller:class extends C{constructor(t){let i=r(t.text),s=Array.isArray(i)?i:[...i];super(Object.assign({},t,{class:F,count:s.length,text:t=>s[t],enabled:i=>" "!==s[i]&&r(t.enabled,i)}))}},StackBlur:class extends I{constructor(t){super(t),this.L=!1,this.tt=void 0}j(){return Object.assign({},super.j(),{onCanvas:!1,radius:void 0,radiusPart:void 0,radiusScale:!0})}normalizeFullScreen(t){this.norm&&this.onCanvas?(this.x=0,this.y=0,this.width=t.widthInPixel,this.height=t.heightInPixel):super.normalizeFullScreen(t)}resize(t,i){super.resize(t,i),this.radiusPart&&(this.radius=void 0)}additionalBlur(t,i,s){const e=this.W.getImageData(0,0,t,i);h.imageDataRGBA(e,0,0,t,i,s.radius),this.W.putImageData(e,0,0)}detect(t,i,s){return this.D(t,i,s,!1)}draw(t,i){if(this.enabled){void 0!==this.radius&&this.tt===this.radiusPart||(this.radius=Math.round((i.widthInPixel+i.heightInPixel)/2/this.radiusPart),this.tt=this.radiusPart);const s=Math.round(this.radius*(this.radiusScale&&(i.cam?i.cam.zoom:1)/i.scaleCanvas));if(s)if(this.onCanvas){void 0!==this.width&&void 0!==this.height||this.normalizeFullScreen(i);const e=Math.round(this.x),r=Math.round(this.y),n=Math.round(this.width),o=Math.round(this.height);this.imageData=t.getImageData(e,r,n,o),h.imageDataRGBA(this.imageData,0,0,n-e,o-r,s),t.putImageData(this.imageData,e,r,0,0,n,o)}else i.radius=s,super.draw(t,i)}else super.draw(t,i)}},StarField:class extends O{constructor(t){super(t),this.it=[],this.st=[],this.ht=[],this.et=[],this.rt=[],this.nt=[],this.ot=[],this.at=[],this.ct=[]}j(){return Object.assign({},super.j(),{count:40,moveX:0,moveY:0,moveZ:0,lineWidth:void 0,highScale:!0,color:"#FFF"})}init(t,i){function s(t,i,s=-i){return void 0===t||t<i||t>=s?Math.random()*(s-i)+i:t}this.width=this.width||i.width,this.height=this.height||i.height,this.x=void 0===this.x?i.x:this.x,this.y=void 0===this.y?i.y:this.y,this.lineWidth=this.lineWidth||Math.min(i.height/i.heightInPixel,i.width/i.widthInPixel)/2,this.ut=this.width/2+this.x,this.lt=this.height/2+this.y,this.dt=Math.max(this.width,this.height)/2;for(let t=0;t<this.count;t++)this.it[t]=s(this.it[t],-this.width/2),this.st[t]=s(this.st[t],-this.height/2),this.ht[t]=s(this.ht[t],0,this.dt)}moveStar(t,i,s){s&&(this.at[t]=!0);const h=this.width/2,e=this.height/2;let r=this.it[t]+this.moveX*i,n=this.st[t]+this.moveY*i,o=this.ht[t]+this.moveZ*i;for(;r<-h;)r+=this.width,n=Math.random()*this.height-e,this.at[t]=!1;for(;r>h;)r-=this.width,n=Math.random()*this.height-e,this.at[t]=!1;for(;n<-e;)n+=this.height,r=Math.random()*this.width-h,this.at[t]=!1;for(;n>e;)n-=this.height,r=Math.random()*this.width-h,this.at[t]=!1;for(;o<=0;)o+=this.dt,r=Math.random()*this.width-h,n=Math.random()*this.height-e,this.at[t]=!1;for(;o>this.dt;)o-=this.dt,r=Math.random()*this.width-h,n=Math.random()*this.height-e,this.at[t]=!1;const a=this.ut+r/o*h,c=this.lt+n/o*e;if(this.at[t]=this.at[t]&&a>=this.x&&c>=this.y&&a<this.x+this.width&&c<this.y+this.height,s)this.it[t]=r,this.st[t]=n,this.ht[t]=o,this.nt[t]=a,this.ot[t]=c;else{this.et[t]=a,this.rt[t]=c;let i=4*(1-this.ht[t]/this.dt);this.highScale||(i=Math.ceil(i)),this.ct[t]=i}}animate(t){let i=super.animate(t);if(this.enabled&&void 0!==this.ut){let i=this.count;for(;i--;)this.moveStar(i,t/16,!0),this.at[i]&&this.moveStar(i,-5,!1)}return i}resize(t,i){this._=!0}detect(t,i,s){return this.D(t,i,s,!1)}draw(t,i){if(this.enabled)if(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,0==this.moveY&&0==this.moveZ&&this.moveX<0){t.fillStyle=this.color;let i=this.count;for(;i--;)this.at[i]&&t.fillRect(this.nt[i],this.ot[i]-this.ct[i]*this.lineWidth/2,this.et[i]-this.nt[i],this.ct[i]*this.lineWidth)}else if(t.strokeStyle=this.color,this.highScale){let i=this.count;for(;i--;)this.at[i]&&(t.beginPath(),t.lineWidth=this.ct[i]*this.lineWidth,t.moveTo(this.et[i],this.rt[i]),t.lineTo(this.nt[i],this.ot[i]),t.stroke(),t.closePath())}else{let i,s=5;for(;--s;){for(t.beginPath(),t.lineWidth=s*this.lineWidth,i=this.count;i--;)this.at[i]&&this.ct[i]===s&&(t.moveTo(this.et[i],this.rt[i]),t.lineTo(this.nt[i],this.ot[i]));t.stroke(),t.closePath()}}}}};function E(t,i){return i.from+t*i.delta}function j(t,i){for(var s,h=[...i.values],e=h.length;e>1;)for(e--,s=0;s<e;s++)h[s]=h[s]+t*(h[s+1]-h[s]);return h[0]}function z(t,i,s){return i.colorFrom.mix(i.colorTo,100*t).toString()}function _(t,i,s){return s.changeToPath(t,i,s)}class A{constructor(t,i,s){this.initialized=!1,this.changeValues=[];for(let i in t){const s=t[i],h="rotationInDegree"===i?.017453292519943295*s:s,e="color"===i||"borderColor"===i,n="path"===i,o="function"==typeof h,a=!e&&Array.isArray(h),c="scale"===i?["scaleX","scaleY"]:"rotationInRadian"===i||"rotationInDegree"===i?["rotation"]:[i];for(const t of c)this.changeValues.push({name:t,to:a?h[h.length-1]:r(h,1,{}),bezier:!!a&&h,isColor:e,isPath:n,isFunction:!!o&&h,moveAlgorithm:e?z:n?_:a?j:E})}this.duration=m(r(i),0),this.ease=m(s,t=>t)}reset(){this.initialized=!1}init(t,s){for(var h,e=this.changeValues.length;e--;)(h=this.changeValues[e]).isFunction?(h.from=t[h.name],h.to=h.isFunction(h.from),h.isColor?(h.colorFrom=new i.TinyColor(h.from),h.colorTo=new i.TinyColor(h.to),h.moveAlgorithm=z):h.isPath?([h.pathFrom,h.pathTo]=t.changeToPathInit(h.from,h.to),h.moveAlgorithm=_):Array.isArray(h.to)?(h.values=[t[h.name],...h.to],h.moveAlgorithm=j):(h.delta=h.to-h.from,h.moveAlgorithm=E)):h.isColor?(h.colorFrom=new i.TinyColor(t[h.name]),h.colorTo=new i.TinyColor(h.to)):h.isPath?[h.pathFrom,h.pathTo]=t.changeToPathInit(t[h.name],h.to):h.bezier?h.values=[t[h.name],...h.bezier]:(h.from=t[h.name],h.delta=h.to-h.from)}run(t,i){if(this.initialized||(this.initialized=!0,this.init(t,i)),this.duration<=i){let i,s=this.changeValues.length;for(;s--;)i=this.changeValues[s],t[i.name]=i.to}else{let s,h=this.changeValues.length;const e=this.ease(i/this.duration);for(;h--;)s=this.changeValues[h],t[s.name]=s.moveAlgorithm(e,s,t)}return i-this.duration}}var D={Callback:class{constructor(t,i){this.callback=t,this.duration=m(r(i),void 0),this.initialized=!1}reset(){this.initialized=!1}run(t,i){let s;return void 0!==this.duration?(this.callback(t,Math.min(i,this.duration),!this.initialized),this.initialized=!0,i-this.duration):(s=this.callback(t,i,!this.initialized),this.initialized=!0,s)}},ChangeTo:A,End:class{constructor(){}run(t,i){return b.F}},EndDisabled:class{constructor(){}run(t,i){return t.enabled=!1,b.F}},Forever:class{constructor(){var t=[].slice.call(arguments);this.Aniobject=t[0]instanceof b?t[0]:new b(...t)}reset(t=0){this.Aniobject.reset&&this.Aniobject.reset(t)}play(t="",i=0){this.Aniobject.play&&this.Aniobject.play(t,i)}run(t,i,s){let h=i;for(;h>=0;){if(h=this.Aniobject.run(t,h,s),s=!0,!0===h)return!0;h>=0&&this.Aniobject.reset&&this.Aniobject.reset()}return h}},If:class{constructor(t,i,s){this.ifCallback=t,this.Aniobject=i,this.AniobjectElse=m(s,()=>0)}run(t,i){const s=r(this.ifCallback)?this.Aniobject:this.AniobjectElse;return s.run?s.run(t,i):s(t,i)}},Image:class{constructor(t,i){this.initialized=!1,this.image=r(t),this.durationBetweenFrames=m(r(i),0),Array.isArray(this.image)?this.count=this.image.length:(this.image=[this.image],this.count=1),this.duration=this.count*this.durationBetweenFrames}reset(){this.initialized=!1}run(t,i){if(this.initialized||(this.initialized=!0,this.current=-1),i>=this.duration)t.image=u.getImage(this.image[this.image.length-1]);else{let s=Math.floor(i/this.durationBetweenFrames);s!==this.current&&(this.current=s,t.image=u.getImage(this.image[this.current]))}return i-this.duration}},ImageFrame:class{constructor(t,i,s){this.initialized=!1,this.frameNumber=r(t),this.framesToRight=m(r(i),!0),this.durationBetweenFrames=m(r(s),0),Array.isArray(this.frameNumber)||(this.frameNumber=[this.frameNumber]),this.duration=this.frameNumber.length*this.durationBetweenFrames}run(t,i){let s=0;return s=i>=this.duration?this.frameNumber[this.frameNumber.length-1]:this.frameNumber[Math.floor(i/this.durationBetweenFrames)],this.framesToRight?t.frameX=t.frameWidth*s:t.frameY=t.frameHeight*s,i-this.duration}},Loop:class{constructor(t){var i=[].slice.call(arguments,1);this.Aniobject=i[0]instanceof b?i[0]:new b(...i),this.times=this.timesOrg=m(r(t),1)}reset(t=0){this.times=this.timesOrg,this.Aniobject.reset&&this.Aniobject.reset(t)}play(t="",i=0){this.times=this.timesOrg,this.Aniobject.play&&this.Aniobject.play(t,i)}run(t,i,s){let h=i;for(;h>=0&&this.times>0;){if(h=this.Aniobject.run(t,h,s),s=!0,!0===h)return!0;h>=0&&(this.times--,this.Aniobject.reset&&this.Aniobject.reset())}return h}},Move:class extends A{constructor(t,i,s,h){super({x:t,y:i},0,h),this.speed=r(s)||1}init(t,i){if(0==this.speed||this.targetX===t.x&&this.targetY===t.y)this.duration=0;else{let i=this.changeValues[0],s=this.changeValues[1];i.from=t.x,s.from=t.y,i.delta=i.to-i.from,s.delta=s.to-s.from;const h=Math.sqrt(i.delta*i.delta+s.delta*s.delta);this.duration=10*h/this.speed}super.init(t,i)}},Once:class{constructor(t,i){this.Aniobject=t,this.times=m(r(i),1)}run(t,i){if(this.times<=0)return i;{let s=this.Aniobject.run(t,i);return s>=0&&this.times--,s}}},Remove:class{constructor(){}run(t,i){return b.O}},Sequence:b,Shake:class{constructor(t,i){this.initialized=!1,this.duration=r(i),this.shakeDiff=r(t),this.shakeDiffHalf=this.shakeDiff/2}reset(){this.initialized=!1}run(t,i){return this.initialized||(this.initialized=!0,this.x=t.x,this.y=t.y),i>=this.duration?(t.x=this.x,t.y=this.y):(t.x=this.x+Math.random()*this.shakeDiff-this.shakeDiffHalf,t.y=this.y+Math.random()*this.shakeDiff-this.shakeDiffHalf),i-this.duration}},ShowOnce:class{constructor(){this.showOnce=!0}run(t,i){return t.enabled=t.enabled&&this.showOnce,this.showOnce=!1,0}},State:class{constructor({states:t={},transitions:i={},default:s,delegateTo:h}={}){this.states=t,Object.keys(this.states).forEach(t=>{Array.isArray(this.states[t])&&(this.states[t]=new b(this.states[t]))}),this.transitions=i,this.delegateTo=h,this.currentStateName=s,this.currentState=this.states[s],this.isTransitioningToStateName=void 0}setState(t,i){if(t!==this.currentStateName){this.isTransitioningToStateName=t;const i=""+t.charAt(0).toUpperCase()+t.slice(1),s=[this.currentStateName+"To"+i,this.currentStateName+"To","to"+i].find(t=>this.transitions[t]);s?(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.transitions[s],this.currentState&&this.currentState.reset&&this.currentState.reset()):(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.states[this.currentStateName],this.currentState&&this.currentState.reset&&this.currentState.reset(),this.isTransitioningToStateName=void 0)}}play(t="",i=0){this.currentState.play&&this.currentState.play(t,i)}run(t,i,s){let h=i,e=s;if(this.currentState){if(h=this.currentState.run(t,h,e),!0===h)return!0;e=!0}if(h>=0||!this.currentState)if(this.isTransitioningToStateName){if(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.states[this.currentStateName],this.currentState&&this.currentState.reset&&this.currentState.reset(),this.isTransitioningToStateName=void 0,h=this.currentState.run(t,h,e),!0===h)return!0}else this.currentState=void 0;return-1}},Stop:class{constructor(){}run(t,i){return b.k}},StopDisabled:class{constructor(){}run(t,i){return t.enabled=!1,b.k}},Wait:M,WaitDisabled:class{constructor(t){this.duration=m(r(t),0)}run(t,i){return t.enabled=i>=this.duration,i-this.duration}}};class L{constructor(t={}){this.type="camera",this.cam=Object.assign({zoom:1,x:0,y:0},t)}viewport({},t){return t.scale(this.cam.zoom,this.cam.zoom).translate(-this.cam.x,-this.cam.y)}viewportByCam({engine:t},i){const s=t.getWidth()/2,h=t.getHeight()/2,e=t.getRatio()>1?s:h;return(new f).translate(s,h).scale(e,e).scale(i.zoom,i.zoom).translate(-i.x,-i.y)}additionalModifier({},t){return t.cam=Object.assign({},this.cam),t}clampView({engine:t,scene:i,clampLimits:s},h){const e=s||{x1:i.additionalModifier.x,y1:i.additionalModifier.y,x2:i.additionalModifier.x+i.additionalModifier.width,y2:i.additionalModifier.y+i.additionalModifier.height},r=this.viewportByCam({engine:t},h).invert(),[n,o]=r.transformPoint(0,0),[a,c]=r.transformPoint(t.getWidth(),t.getHeight());return a-n<=e.x2-e.x1?n<e.x1?a<=e.x2&&(h.x+=e.x1-n):a>e.x2&&(h.x+=e.x2-a):n>e.x1?h.x+=e.x1-n:a<e.x2&&(h.x+=e.x2-a),c-o<=e.y2-e.y1?o<e.y1?c<=e.y2&&(h.y+=e.y1-o):c>e.y2&&(h.y+=e.y2-c):o>e.y1?h.y+=e.y1-o:c<e.y2&&(h.y+=e.y2-c),h}set zoom(t){this.cam.zoom=t}set camX(t){this.cam.x=t}set camY(t){this.cam.y=t}get zoom(){return this.cam.zoom}get camX(){return this.cam.x}get camY(){return this.cam.y}zoomToFullScreen({scene:t}){return Math.min(t.additionalModifier.fullScreen.width/t.additionalModifier.width,t.additionalModifier.fullScreen.height/t.additionalModifier.height)}zoomTo({scene:t,engine:i,cam:s,x1:h,y1:e,x2:r,y2:n}){const o=t.additionalModifier.scaleCanvas,a=this.viewportByCam({engine:i},s||this.cam).invert(),[c,u]=a.transformPoint(0,0),[l,d]=a.transformPoint(i.getWidth()*o,i.getHeight()*o),f=r-h,m=n-e,v={x:h+f/2,y:e+m/2,zoom:s.zoom*Math.max(Math.min((l-c)/f,(d-u)/m),Number.MIN_VALUE)};s?(s.x=v.x,s.y=v.y,s.zoom=v.zoom):this.cam=v}}class N{constructor(t={}){this.type="control",this.ft={},this.toCam={},this.config=Object.assign({zoomMax:10,zoomMin:.5,zoomFactor:1.2,tween:2,callResize:!0},t)}init({scene:t}){this.vt=t,this.toCam=Object.assign({},t.camera.cam)}mouseDown({event:t,position:[i,s],button:h}){this.ft[h]=Object.assign({},this.ft[h],{x:i,y:s,pt:this.toCam.x,yt:this.toCam.y,gt:!0,wt:t.touches&&t.touches.length||1,Mt:void 0,bt:Date.now()})}mouseUp({event:t,position:[i,s],button:h,scene:e}){this.ft[h]||(this.ft[h]={});const r=this.ft[h].gt,n=t.changedTouches&&t.changedTouches.length||1,o=Math.max(this.ft[h].wt,n);this.ft[h].gt=!1,this.ft[h].wt-=n,!r||o>1?e.stopPropagation():Date.now()-this.ft[h].bt<300&&Math.abs(this.ft[h].x-i)<5&&Math.abs(this.ft[h].y-s)<5&&1===h||e.stopPropagation()}mouseOut({button:t}){this.ft[t]&&(this.ft[t].gt=!1)}mouseMove({event:t,position:[i,s],button:h,scene:e}){if(!this.ft[h]||!this.ft[h].gt||0===t.which&&!t.touches)return;const r=e.additionalModifier.scaleCanvas;if(t.touches&&t.touches.length>=2){const i=t.touches,s=Math.sqrt((i[0].pageX-i[1].pageX)*(i[0].pageX-i[1].pageX)+(i[0].pageY-i[1].pageY)*(i[0].pageY-i[1].pageY));void 0===this.ft[h].Mt?s>0&&(this.ft[h].Mt=s,this.ft[h].xt=this.toCam.zoom):(this.toCam.zoom=Math.max(this.config.zoomMin,Math.min(this.config.zoomMax,this.ft[h].xt*s/this.ft[h].Mt)),this.toCam=e.camera.clampView(arguments[0],this.toCam))}else{this.ft[h].Mt=void 0;const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,o]=t.transformPoint(this.ft[h].x*r,this.ft[h].y*r),[a,c]=t.transformPoint(i*r,s*r);this.toCam.x=this.ft[h].pt+n-a,this.toCam.y=this.ft[h].yt+o-c,this.toCam=e.camera.clampView(arguments[0],this.toCam)}}mouseWheel({event:t,position:[i,s],scene:h}){const e=h.additionalModifier.scaleCanvas,[r,n]=h.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(i*e,s*e);if((t.wheelDelta||-1*t.deltaY)/120>0){this.zoomIn();const[t,o]=h.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(i*e,s*e);this.toCam.x-=t-r,this.toCam.y-=o-n,this.toCam=h.camera.clampView(arguments[0],this.toCam)}else this.zoomOut(arguments[0])}hasCamChanged(){const t=this.config.tween||1;return Math.abs(this.toCam.x-this.vt.camera.cam.x)>=Number.EPSILON*t||Math.abs(this.toCam.y-this.vt.camera.cam.y)>=Number.EPSILON*t||Math.abs(this.toCam.zoom-this.vt.camera.cam.zoom)>=Number.EPSILON*t}fixedUpdate({scene:t,lastCall:i}){this.config.tween&&!this.Pt&&this.hasCamChanged()&&(t.camera.cam.x+=(this.toCam.x-t.camera.cam.x)/this.config.tween,t.camera.cam.y+=(this.toCam.y-t.camera.cam.y)/this.config.tween,t.camera.cam.zoom+=(this.toCam.zoom-t.camera.cam.zoom)/this.config.tween,i&&(t.additionalModifier.cam=this.cam,this.config.callResize?t.resize():t.cacheClear()))}update({scene:t}){this.config.tween&&!this.Pt||!this.hasCamChanged()||(this.Pt=!1,t.camera.cam=Object.assign({},this.toCam),this.config.callResize?t.resize():t.cacheClear())}camInstant(){this.Pt=!0}resize(t){this.toCam=t.scene.camera.clampView(t,this.toCam)}zoomToNorm(){return this.toCam.zoom=1,this}zoomIn(){return this.toCam.zoom=Math.min(this.config.zoomMax,this.toCam.zoom*this.config.zoomFactor),this}zoomOut(t){return this.toCam.zoom=Math.max(this.config.zoomMin,this.toCam.zoom/this.config.zoomFactor),t&&(this.toCam=this.vt.camera.clampView(t,this.toCam)),this}zoomTo(t){t.cam=this.toCam,t.scene.camera.zoomTo(t)}}var B={Callback:L,Camera:L,CameraControl:N,CameraControlSecondButton:class extends N{mouseUp({event:t,position:[i,s],button:h,scene:e}){this.ft[h]||(this.ft[h]={});const r=this.ft[h].gt,n=t.changedTouches&&t.changedTouches.length||1,o=Math.max(this.ft[h].wt,n);if(this.ft[h].gt=!1,this.ft[h].wt-=n,!r||o>1)e.stopPropagation();else if((Date.now()-this.ft[h].bt>300||Math.abs(this.ft[h].x-i)>=5||Math.abs(this.ft[h].y-s)>=5)&&1===h){e.stopPropagation();const[r,n]=e.transformPoint(i,s),[o,a]=e.transformPoint(this.ft[h].x,this.ft[h].y);e.map("region",{event:t,x1:Math.min(o,r),y1:Math.min(a,n),x2:Math.max(o,r),y2:Math.max(a,n),fromX:o,fromY:a,toX:r,toY:n})}}mouseMove({event:t,position:[i,s],button:h,scene:e}){if(!this.ft[h]||!this.ft[h].gt||0===t.which&&!t.touches)return;const r=e.additionalModifier.scaleCanvas;if(t.touches&&t.touches.length>=2){const n=t.touches,o=Math.sqrt((n[0].pageX-n[1].pageX)*(n[0].pageX-n[1].pageX)+(n[0].pageY-n[1].pageY)*(n[0].pageY-n[1].pageY));if(void 0===this.ft[h].Mt)o>0&&(this.ft[h].Mt=o,this.ft[h].xt=this.toCam.zoom);else{this.toCam.zoom=Math.max(this.config.zoomMin,Math.min(this.config.zoomMax,this.ft[h].xt*o/this.ft[h].Mt));const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,a]=t.transformPoint(this.ft[h].x*r,this.ft[h].y*r),[c,u]=t.transformPoint(i*r,s*r);this.toCam.x=this.ft[h].pt+n-c,this.toCam.y=this.ft[h].yt+a-u,this.toCam=e.camera.clampView(arguments[0],this.toCam)}}else{if(this.ft[h].Mt=void 0,2===h){const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,o]=t.transformPoint(this.ft[h].x*r,this.ft[h].y*r),[a,c]=t.transformPoint(i*r,s*r);this.toCam.x=this.ft[h].pt+n-a,this.toCam.y=this.ft[h].yt+o-c,this.toCam=e.camera.clampView(arguments[0],this.toCam)}if(1===h&&e.has("regionMove")&&!(Date.now()-this.ft[h].bt<300&&Math.abs(this.ft[h].x-i)<5&&Math.abs(this.ft[h].y-s)<5)&&(!t.touches||1===t.touches.length)){const[r,n]=e.transformPoint(i,s),[o,a]=e.transformPoint(this.ft[h].x,this.ft[h].y);e.map("regionMove",{event:t,x1:Math.min(o,r),y1:Math.min(a,n),x2:Math.max(o,r),y2:Math.max(a,n),fromX:o,fromY:a,toX:r,toY:n})}}}},Click:class{constructor({doubleClickDetectInterval:t=350}={}){this.Ct=t}mouseUp(t){const{scene:i,button:s}=t;1===s&&(i.has("doubleClick")?this.It?(clearTimeout(this.It),this.It=0,i.map("doubleClick",t)):this.It=setTimeout(()=>{this.It=0,i.map("click",t)},this.Ct):i.map("click",t))}},Element:class{constructor({doubleClickDetectInterval:t=350}={}){this.Ct=t}isDrawFrame(){return this.Tt?1:0}Ft(t,i,s){i?t.has("doubleClickElement")?this.It?(clearTimeout(this.It),this.It=0,t.map("doubleClickElement",s)):this.It=setTimeout(()=>{this.It=0,t.map("clickElement",s)},this.Ct):t.map("clickElement",s):t.map("hoverElement",s)}kt(t,i,s){i?t.has("doubleClickNonElement")?this.It?(clearTimeout(this.It),this.It=void 0,t.map("doubleClickNonElement",s)):this.It=setTimeout(()=>{this.It=void 0,t.map("clickNonElement",s)},this.Ct):t.map("clickNonElement",s):t.map("hoverNonElement",s)}initSprites({scene:t,output:i,layerManager:s,canvasId:h}){if(this.Tt=!1,this.Ot||this.St){const e=!!this.Ot,{mx:r,my:n}=this.Ot||this.St,o=t.additionalModifier.scaleCanvas,a=i.context[h],c=Math.round(r/o),u=Math.round(n/o),[l,d]=t.transformPoint(r,n);a.save(),a.setTransform(...t.viewport().m);let f=0;if(s.forEach(({layerId:t,element:i,isFunction:s,elementId:h})=>{if(!s){const s=i.detect(a,c,u);if("c"===s)f="c";else if(s)return f={layerId:t,element:s,elementId:h},!1}}),a.restore(),"c"===f)this.Tt=!0;else{this.Ot=!1,this.St=!1;const i={mx:r,my:n,x:l,y:d};f?(Object.assign(i,f),this.Ft(t,e,i)):this.kt(t,e,i)}}}draw({engine:t,scene:i,layerManager:s,output:h,canvasId:e}){if(!e&&this.Tt){const r=!!this.Ot,{mx:n,my:o}=this.Ot||this.St,a=i.additionalModifier.scaleCanvas,c=h.context[e],u=Math.round(n/a),l=Math.round(o/a),[d,f]=i.transformPoint(n,o),m={mx:n,my:o,x:d,y:f},v=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!1,c.clearRect(0,0,c.canvas.width,c.canvas.height),c.save(),c.setTransform(...i.viewport().m),s.forEach(({layerId:t,element:i,isFunction:s,elementId:h})=>{s||i.detectDraw(c,"rgb("+(255&h)+", "+((65280&h)>>8)+", "+(255&t)+")")},0),c.restore(),c.imageSmoothingEnabled=v,t.normContext(c),this.Ot=!1,this.St=!1;const p=c.getImageData(u,l,1,1).data;p[3]?(m.layerId=p[2],m.elementId=p[0]+(p[1]<<8),m.element=s.getById(m.layerId).getById(m.elementId),this.Ft(i,r,m)):this.kt(i,r,m)}}mouseUp({scene:t,position:[i,s],button:h}){this.Ot=1===h&&t.has("clickElement")&&{mx:i,my:s}}mouseMove({scene:t,position:[i,s]}){this.St=t.has("hoverElement")&&{mx:i,my:s}}},Event:class{constructor(){this.type="events"}Et(t,i,s){m(s.value("preventDefault"),!0)&&i.preventDefault();const[h,e]=this.getMousePosition({event:i}),[r,n]=s.transformPoint(h,e);s.pipeBack(t,{event:i,position:[h,e],x:r,y:n,button:this.getMouseButton({event:i})})}init({output:t,scene:i}){const s=t.canvas[0],h=i.map("events");h.push([i.has("mouseDown")&&[["touchstart","mousedown"],t=>this.Et("mouseDown",t,i)],i.has("mouseUp")&&[["touchend","mouseup"],t=>this.Et("mouseUp",t,i)],i.has("mouseOut")&&[["touchendoutside","mouseout"],t=>this.Et("mouseOut",t,i)],i.has("mouseMove")&&[["touchmove","mousemove"],t=>this.Et("mouseMove",t,i)],i.has("mouseWheel")&&[["wheel"],t=>this.Et("mouseWheel",t,i)],m(i.value("preventDefault"),!0)&&[["contextmenu"],t=>t.preventDefault()]].filter(t=>t)),this.jt=h.filter(Array.isArray).reduce((t,i)=>(t.push.apply(t,i),t),[]).map(([t,i])=>t.map(t=>({n:s,e:t,f:i}))).reduce((t,i)=>(Array.isArray(i)?t.push.apply(t,i):t.push(i),t),[]),this.jt.forEach(t=>{t.n.addEventListener(t.e,t.f,!0)})}destroy(){this.jt.forEach(t=>{t.n.removeEventListener(t.e,t.f,!0)}),this.jt=[]}getMousePosition({event:t}){let i;if(t.touches&&t.touches.length>0?i=t.targetTouches:t.changedTouches&&t.changedTouches.length>0&&(i=t.changedTouches),i){const s=t.target.getBoundingClientRect(),h=i.length;return i=Array.from(i),[i.reduce((t,i)=>t+i.pageX,0)/h-s.left,i.reduce((t,i)=>t+i.pageY,0)/h-s.top]}if(void 0===t.offsetX){const i=t.target.getBoundingClientRect();return[t.clientX-i.left,t.clientY-i.top]}return[t.offsetX,t.offsetY]}getMouseButton({event:t}){return t.touches?t.touches.length||t.changedTouches.length:m(t.buttons?t.buttons:[0,1,4,2][t.which],1)}},LoadingScreen:class{loading({output:t,progress:i}){const s=t.context[0],h="number"==typeof i?Math.max(1,i*t.height):t.height;s.globalCompositeOperation="source-over",s.globalAlpha=1,s.clearRect(0,0,t.width,t.height),s.fillStyle="#aaa",s.fillRect(0,t.height/2-h/2,t.width,h),s.font="20px Georgia",s.fillStyle="#fff",s.textAlign="left",s.textBaseline="bottom",s.fillText(isNaN(parseFloat(i))?i:"Loading "+Math.round(100*i)+"%",10+3*Math.random(),t.height-10+3*Math.random())}},Norm:class{viewport({engine:t},i){const s=t.getWidth()/2,h=t.getHeight()/2,e=t.getRatio()>1?s:h;return i.translate(s,h).scale(e,e)}additionalModifier({engine:t,output:i,scene:s}){s.cacheClear();const h={alpha:1,x:-1,y:-1,width:2,height:2,widthInPixel:i.width,heightInPixel:i.height,scaleCanvas:i.width/i.canvas[0].clientWidth},[e,r]=s.transformPoint(0,0,1),[n,o]=s.transformPoint(i.width,i.height,1);h.visibleScreen={x:e,y:r,width:n-e,height:o-r};const a=t.getWidth()/2,c=t.getHeight()/2,u=t.getRatio()>1?a:c,l=(new f).translate(a,c).scale(u,u).invert(),[d,m]=l.transformPoint(0,0,1),[v,p]=l.transformPoint(i.width,i.height,1);return h.fullScreen={x:d,y:m,width:v-d,height:p-m},h}},TimingAudio:class extends v{constructor(t={}){super(t),this.C=Number.POSITIVE_INFINITY,this.zt=null,this._t=null,this.At=!1,this.Dt=this.M.audioElement}get audioElement(){return this.Dt}init(){if(this.Dt)return"function"==typeof MediaController&&(this.Dt.controller=new MediaController,this.At=!0),this.Dt.preload="auto",new Promise(t=>{let i=()=>{this.Dt.removeEventListener("canplaythrough",i);let s=this.Dt.play();s&&s.catch(t=>{}),t()};this.Dt.addEventListener("canplaythrough",i),this.Dt.load()})}endTime(){return 1e3*this.Dt.duration}currentTime(){let t=super.currentTime();if(this.Dt){const i=1e3*(this.Dt.ended?this.Dt.duration:this.Dt.currentTime);if(this.At){if(null===this.zt)return this.zt=t,this._t=i,i;if("playing"===this.Dt.controller.playbackState){if(i===this._t)return this._t+Math.min(260,t-this.zt);if(i-this._t<500&&i>this._t&&t-this.zt<350)return this.zt=this.zt+(i-this._t),this._t=i,this._t+t-this.zt}return this.zt=t,this._t=i,this._t}return i}return t}clampTime({timePassed:t}){return t}shiftTime(){return 0}},TimingDefault:v};exports.Easing=e,exports.Animations=D,exports.Engine=class{constructor(t){let i=t;if("object"!=typeof t)throw new Error("No canvas given for Engine constructor");if(t.getContext)i={canvas:t};else if(!t.canvas)throw new Error("No canvas given for Engine constructor");let s=Object.assign({},i);if(this.Lt={canvas:[],context:[],width:0,height:0,ratio:1},this.jt=[],this.vt=null,this.Nt=!1,this.Bt=0,this.Wt=!1,this.Ut=null,this.Lt.canvas=n(s.canvas),s.autoSize){const t={enabled:!0,scaleLimitMin:1,scaleLimitMax:2.5,scaleFactor:1.07,referenceWidth:()=>this.Lt.canvas[0].clientWidth,referenceHeight:()=>this.Lt.canvas[0].clientHeight,currentScale:1,waitTime:100,currentWaitedTime:0,currentOffsetTime:0,offsetTimeLimitUp:300,offsetTimeLimitDown:300,registerResizeEvents:!0,registerVisibilityEvents:!0,setCanvasStyle:!1};this.Xt="object"==typeof s.autoSize?Object.assign({},t,s.autoSize):t,this.Xt.registerResizeEvents&&(this.jt=["resize","orientationchange"].map(t=>({n:window,e:t,f:this.recalculateCanvas.bind(this)}))),this.Xt.registerVisibilityEvents&&this.jt.push({n:document,e:"visibilitychange",f:this.handleVisibilityChange.bind(this)}),this.Yt()}else this.Lt.width=this.Lt.canvas[0].width,this.Lt.height=this.Lt.canvas[0].height,this.Lt.ratio=this.Lt.width/this.Lt.height;this.Lt.canvas.forEach((t,i)=>{this.Lt.context[i]=t.getContext("2d")}),this.qt=this.Lt.canvas.length,this.Z=Array.from({length:this.qt},t=>0),s.clickToPlayAudio&&this.jt.push({n:this.Lt.canvas[0],e:"click",f:this.playAudioOfScene.bind(this)}),this.Rt=s.reduceFramerate,this.jt.forEach(t=>{t.n.addEventListener(t.e,t.f)}),this.switchScene(s.scene,s.sceneParameter||{})}handleVisibilityChange(){this.Xt.enabled=!("hidden"==document.visibilityState)}playAudioOfScene(){this.Nt&&this.vt&&this.vt.timing.audioElement&&this.vt.timing.audioElement.play()}normContext(t){t.textBaseline="middle",t.textAlign="center",t.globalAlpha=1,t.globalCompositeOperation="source-over"}getWidth(){return this.Lt.width}getHeight(){return this.Lt.height}getRatio(){return this.Lt.ratio}getOutput(){return this.Lt}recalculateCanvas(){return this.Wt=!0,this}Yt(){if(this.Xt){const t=r(this.Xt.referenceWidth),i=r(this.Xt.referenceHeight);if(t<=0||i<=0)return;this.Lt.canvas.forEach(s=>{s.width=Math.round(t/this.Xt.currentScale),s.height=Math.round(i/this.Xt.currentScale),this.Xt.setCanvasStyle&&(s.style.width=t+"px",s.style.height=i+"px")}),this.Xt.currentWaitedTime=0,this.Xt.currentOffsetTime=0}this.Lt.width=this.Lt.canvas[0].width,this.Lt.height=this.Lt.canvas[0].height,this.Lt.ratio=this.Lt.width/this.Lt.height,this.resize()}recalculateFPS(){try{const t=this;return t.Ut&&(window.cancelAnimationFrame(t.Ut),t.Ut=!1),Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){function i(){const i=(t.Ht()-s)/h;t.Xt.offsetTimeTarget=i,t.Xt.offsetTimeDelta=i/3,!1===t.Ut&&(t.Gt=!1,t.Ut=window.requestAnimationFrame(t.Vt.bind(t)))}const s=t.Ht(),h=3;let e=h;const r=function(t,i,s){for(var h;;){var e=t();if(c(e)&&(e=e.v),!e)return r;if(e.then){h=0;break}var r=s();if(r&&r.then){if(!c(r)){h=1;break}r=r.s}}var n=new a,u=o.bind(null,n,2);return(0===h?e.then(d):1===h?r.then(l):(void 0).then(function(){(e=t())?e.then?e.then(d).then(void 0,u):d(e):o(n,1,r)})).then(void 0,u),n;function l(i){r=i;do{if(!(e=t())||c(e)&&!e.v)return void o(n,1,r);if(e.then)return void e.then(d).then(void 0,u);c(r=s())&&(r=r.v)}while(!r||!r.then);r.then(l).then(void 0,u)}function d(t){t?(r=s())&&r.then?r.then(l).then(void 0,u):l(r):o(n,1,r)}}(function(){return e--},0,function(){return Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){})});return r&&r.then?r.then(i):i()})}catch(t){return Promise.reject(t)}}resize(){return this.vt&&this.vt.resize&&this.vt.resize(),this}switchScene(t,i){return t&&(this.Kt=t,this.Zt=i),this}Ht(){return window.performance?performance.now():Date.now()}Vt(t){if(!this.Ut)return;this.Ut=window.requestAnimationFrame(this.Vt.bind(this));let i=this.Wt&&(!this.Rt||!this.Jt);i&&(this.Yt(),this.Wt=!1);for(let t=0;t<this.qt;t++)this.Z[t]=Math.max(this.Z[t]-1,i?1:0);if(this.Gt||(this.Gt=t),this.Qt||(this.Qt=t),this.Kt&&!this.$t&&(this.$t=Promise.resolve(this.vt?this.vt.destroy():{}),this.$t.then(i=>{this.Kt.callInit({run:this.ti,scene:this.Zt,destroy:i},this),this.vt=this.Kt,this.Kt=void 0,this.$t=void 0,this.Nt=!1,this.Bt=this.vt.currentTime(),this.Qt=t})),this.vt&&(this.Rt&&(this.Jt=!this.Jt),!this.Rt||this.Jt)){let i=this.vt.currentTime(),s=this.vt.clampTime(i-this.Bt);const h=this.vt.shiftTime(s);if(s+=h,this.Bt=i+h,this.Nt){const i=0!==s||this.ii;this.ii=!1;const h=this.Ht();if(this.Lt.canvas[0].width)for(let t=0;t<this.qt;t++)this.normContext(this.Lt.context[t]),this.vt.initSprites(t);const e=this.vt.isDrawFrame(s);if(Array.isArray(e))for(let t=0;t<this.qt;t++)this.Z[t]=Math.max(this.Z[t],e[t],0);else for(let t=0;t<this.qt;t++)this.Z[t]=Math.max(this.Z[t],e,0);if(i&&this.vt.move(s),this.Lt.canvas[0].width)for(let t=0;t<this.qt;t++)this.Z[t]&&this.vt.draw(t);if(this.Xt&&this.Xt.enabled){const s=t-this.Gt;if(this.Xt.currentWaitedTime<this.Xt.waitTime)this.Xt.currentWaitedTime+=s;else if(i){const t=this.Xt.offsetTimeTarget*(this.Rt?2:1),i=this.Ht()-h,e=(Math.abs(s-t)>Math.abs(i-t)?s:i)-t;Math.abs(e)<=this.Xt.offsetTimeDelta?this.Xt.currentOffsetTime=this.Xt.currentOffsetTime>=0?Math.max(0,this.Xt.currentOffsetTime-this.Xt.offsetTimeDelta):Math.min(0,this.Xt.currentOffsetTime+this.Xt.offsetTimeDelta):e<0&&this.Xt.currentScale>this.Xt.scaleLimitMin?(this.Xt.currentOffsetTime+=e,this.Xt.currentOffsetTime<=-this.Xt.offsetTimeLimitDown&&(this.Xt.currentScale=Math.max(this.Xt.scaleLimitMin,this.Xt.currentScale/this.Xt.scaleFactor),this.Wt=!0)):e>0&&this.Xt.currentScale<this.Xt.scaleLimitMax&&(this.Xt.currentOffsetTime+=e,this.Xt.currentOffsetTime>=this.Xt.offsetTimeLimitUp&&(this.Xt.currentScale=Math.min(this.Xt.scaleLimitMax,this.Xt.currentScale*this.Xt.scaleFactor),this.Wt=!0))}}}else{for(let t=0;t<this.qt;t++)this.normContext(this.Lt.context[t]);this.Nt=this.vt.callLoading({timePassed:t-this.Gt,totalTimePassed:t-this.Qt}),this.Nt&&(this.vt.reset(),this.Bt=this.vt.currentTime(),this.ii=!0,this.Xt&&(this.Xt.currentWaitedTime=0))}}this.Gt=t}run(t){try{const i=this;return i.ti=t||{},Promise.resolve(i.stop()).then(function(){function t(){return i.Ut=window.requestAnimationFrame(i.Vt.bind(i)),i}i.Gt=i.Qt=!1;const s=function(){if(i.Xt&&!i.Xt.offsetTimeTarget)return Promise.resolve(i.recalculateFPS()).then(function(){})}();return s&&s.then?s.then(t):t()})}catch(t){return Promise.reject(t)}}stop(){try{const t=this;return window.cancelAnimationFrame(t.Ut),t.Ut=null,Promise.resolve(t.vt?Promise.resolve(t.vt.destroy()).then(function(t){}):void 0)}catch(t){return Promise.reject(t)}}destroy(){try{const t=this;return Promise.resolve(t.stop()).then(function(){return t.jt.forEach(t=>{t.n.removeEventListener(t.e,t.f)}),t.jt=[],t})}catch(t){return Promise.reject(t)}}},exports.ImageManager=u,exports.Middleware=B,exports.Scene=class{constructor(){this.si=new d,this.hi=0,this.ei=u,this.middlewares=[].slice.call(arguments),this.middlewareByType("timing")||(this.middlewares=[v,...this.middlewares])}Lt(){return this.ri.getOutput()}set middlewares(t){this.ni=n(t).map(t=>"function"==typeof t?new t:t).reduce((t,i)=>{for(let s of Object.keys(t))s in i&&t[s].push(i);return t.oi.push(i),"enabled"in i||(i.enabled=!0),i.type&&(t["t_"+i.type]=i),t},{oi:[],init:[],isDrawFrame:[],initSprites:[],fixedUpdate:[],update:[],draw:[],destroy:[],reset:[],resize:[],currentTime:[],clampTime:[],shiftTime:[],isChunked:[],hasOneChunkedFrame:[],calcFrames:[],tickChunk:[],additionalModifier:[]})}get middlewares(){return this.ni.oi}middlewareByType(t){const i=this.ni.oi.filter(i=>i.type==t);if(i.length)return i[i.length-1]}has(t){return t in this.ni||this.ni.oi.filter(i=>t in i).length>0}do(t,i,s,h){let e=this.ni[t]||this.ni.oi.filter(i=>t in i);return e=e.filter(t=>t.enabled),e.length?h(e,this.ai(i),s):s}map(t,i={}){return this.do(t,i,[],(i,s)=>i.map(i=>i[t](s)))}pipe(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.ci=!1;for(let s of i)if(e=s[t](h,e),this.ci)break;return e})}pipeBack(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.ci=!1;for(let s=i.length-1;s>=0&&(e=i[s][t](h,e),!this.ci);s--);return e})}pipeMax(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.ci=!1;for(let s of i){let i=s[t](h,e);if(e=Array.isArray(i)?Array.isArray(e)?e.map((t,s)=>Math.max(t,i[s])):i.map(t=>Math.max(t,e)):Array.isArray(e)?e.map((t,s)=>Math.max(t,i)):Math.max(i,e),this.ci)break}return e})}pipeAsync(t,i={},s){const h=this;return this.do(t,i,s,function(i,e){try{let r,n=s;h.ci=!1;const o=function(t,i,s){if("function"==typeof t[p]){var h,e,r,n=t[p]();if(function t(o){try{for(;!((h=n.next()).done||s&&s());)if((o=i(h.value))&&o.then){if(!w(o))return void o.then(t,r||(r=y.bind(null,e=new g,2)));o=o.v}e?y(e,1,o):e=o}catch(t){y(e||(e=new g),2,t)}}(),n.return){var o=function(t){try{h.done||n.return()}catch(t){}return t};if(e&&e.then)return e.then(o,function(t){throw o(t)});o()}return e}if(!("length"in t))throw new TypeError("Object is not iterable");for(var a=[],c=0;c<t.length;c++)a.push(t[c]);return function(t,i,s){var h,e,r=-1;return function n(o){try{for(;++r<t.length&&(!s||!s());)if((o=i(r))&&o.then){if(!w(o))return void o.then(n,e||(e=y.bind(null,h=new g,2)));o=o.v}h?y(h,1,o):h=o}catch(t){y(h||(h=new g),2,t)}}(),h}(a,function(t){return i(a[t])},s)}(i,function(i){return Promise.resolve(i[t](e,n)).then(function(t){n=t,h.ci&&(r=1)})},function(){return r});return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(t){return Promise.reject(t)}})}value(t,i={}){let s=this.ni[t]||this.ni.oi.filter(i=>t in i);if(s.filter(t=>t.enabled),!s.length)return;const h=s[s.length-1];return r(h[t],h,this.ai(i))}stopPropagation(){this.ci=!0}currentTime(){return this.pipe("currentTime")}clampTime(t){return this.pipe("clampTime",{timePassed:t})}shiftTime(t){return this.pipe("shiftTime",{timePassed:t})}cacheClear(){this.ui=0,this.li=0}viewport(){return this.ri?(this.ui||(this.ui=this.pipe("viewport",{},new f),this.li=null),this.ui):new f}transformPoint(t,i,s=this.di.scaleCanvas){return this.li||(this.li=this.viewport().clone().invert()),this.li.transformPoint(t*s,i*s)}callInit(t,i){this.ri=i,this.resize();const s=this.value("images");s&&this.ei.add(s),Promise.all(this.map("init",{parameter:t})).then(t=>this.fi=!0)}get additionalModifier(){return this.di}updateAdditionalModifier(){const t=this.Lt();this.di=this.pipe("additionalModifier",{},{alpha:1,x:0,y:0,width:t.width,height:t.height,widthInPixel:t.width,heightInPixel:t.height,scaleCanvas:1,visibleScreen:{x:0,y:0,width:t.width,height:t.height},fullScreen:{x:0,y:0,width:t.width,height:t.height}})}resize(){const t=this.Lt();this.updateAdditionalModifier(),this.pipe("resize"),this.si.forEach(({element:i,isFunction:s})=>{s||i.resize(t,this.di)})}destroy(){try{const t=this;return Promise.resolve(t.pipeAsync("destroy")).then(function(i){return t.fi=!1,i})}catch(t){return Promise.reject(t)}}get timing(){return this.ni.t_timing}get camera(){return this.ni.t_camera}get control(){return this.ni.t_control}get totalTimePassed(){return this.hi}ai(t){return Object.assign({engine:this.ri,scene:this,imageManager:this.ei,layerManager:this.si,totalTimePassed:this.hi,output:this.ri&&this.Lt()},t)}callLoading(t){return this.ei.isLoaded()&&this.fi?(this.mi=this.value("endTime"),t.progress="Click to play",this.value("loading",t),!0):(t.progress=this.ei.getCount()?this.ei.getLoaded()/this.ei.getCount():"Loading...",this.value("loading",t),!1)}fixedUpdate(t,i){this.map("fixedUpdate",{timePassed:t,lastCall:i})}isDrawFrame(t){return this.pipeMax("isDrawFrame",{timePassed:t},0!==t)}move(t){if(this.hi+=t,this.vi?this.reset():t<0?(t=this.hi,this.reset(),this.initSprites(),this.hi=t):this.mi&&this.mi<=this.hi&&(t-=this.hi-this.mi,this.hi=this.mi,this.map("end",{timePassed:t})),this.value("isChunked")){if(this.value("hasOneChunkedFrame",{timePassed:t})){const i=this.value("calcFrames",{timePassed:t})-1;for(let t=0;t<=i;t++)this.fixedUpdate(this.value("tickChunk"),t===i)}}else this.fixedUpdate(t,!0);this.map("update",{timePassed:t}),this.si.forEach(({element:i,isFunction:s,layer:h,elementId:e})=>{s||i.animate(t)&&h.deleteById(e)})}draw(t){this.map("draw",{canvasId:t});const i=this.Lt().context[t];i.save(),i.setTransform(...this.viewport().m),this.si.forEach(({layer:t,layerId:s,element:h,isFunction:e,elementId:r})=>{e?h(this.ai({layerId:s,elementId:r,layer:t,context:i}))&&t.deleteById(r):h.draw(i,this.di)},t),i.restore()}initSprites(t){const i=this.Lt().context[t];this.si.forEach(({element:t,isFunction:s})=>{s||t.callInit(i,this.di)},t),this.map("initSprites",{canvasId:t})}resetIntend(){this.vi=!0}reset(){this.hi=0,this.vi=!1;let t=this.pipe("reset",{engine:this.ri,scene:this,layerManager:this.si,imageManager:this.ei},new d);if(Array.isArray(t)){const i=t;t=new d,i.forEach(i=>{t.addLayer().addElements(i)})}t&&(this.si=t)}},exports.Sprites=S;
