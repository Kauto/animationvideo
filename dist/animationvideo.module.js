import{TinyColor as t}from"@ctrl/tinycolor";import i from"pasition";import{imageDataRGBA as s}from"stackblur-canvas";export{default as Easing}from"eases";function h(t){return"function"==typeof t?t(...[].slice.call(arguments,1)):t}function e(t){return null==t?[]:Array.isArray(t)?t:[t]}function r(t,i,s){if(!t.s){if(s instanceof n){if(!s.s)return void(s.o=r.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(r.bind(null,t,i),r.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const n=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{r(h,1,t(this.v))}catch(t){r(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?r(h,1,i?i(e):e):s?r(h,1,s(e)):r(h,2,e)}catch(t){r(h,2,t)}},h},t}();function o(t){return t instanceof n&&1&t.s}class a{constructor(t){this.t=void 0,this.i=void 0,this.h=void 0,this.u=void 0,this.l=void 0,this.M=void 0,this.P=void 0,this.C=void 0,this.I=void 0,this.O=void 0,this.F=void 0,this.T=void 0,this.k=void 0,this.S=void 0,this._=!1,this.j=void 0,this.A=void 0,this.D=void 0,this.L=!1;let i=t;if("object"!=typeof t)throw new Error("No canvas given for Engine constructor");if(t.getContext)i={canvas:t};else if(!t.canvas)throw new Error("No canvas given for Engine constructor");let s=Object.assign({},i);if(this.t={canvas:[],context:[],width:0,height:0,ratio:1},this.i=[],this.h=null,this.M=!1,this.C=0,this.P=!1,this.I=void 0,this.t.canvas=e(s.canvas),s.autoSize){const t={enabled:!0,scaleLimitMin:1,scaleLimitMax:2.5,scaleFactor:1.07,referenceWidth:()=>this.t.canvas[0].clientWidth,referenceHeight:()=>this.t.canvas[0].clientHeight,currentScale:1,waitTime:100,currentWaitedTime:0,currentOffsetTime:0,offsetTimeLimitUp:300,offsetTimeLimitDown:300,registerResizeEvents:!0,registerVisibilityEvents:!0,setCanvasStyle:!1};this.O="object"==typeof s.autoSize?Object.assign({},t,s.autoSize):t,this.O.registerResizeEvents&&(this.i=["resize","orientationchange"].map(t=>({n:window,e:t,f:this.recalculateCanvas.bind(this)}))),this.O.registerVisibilityEvents&&this.i.push({n:document,e:"visibilitychange",f:this.handleVisibilityChange.bind(this)}),this.N()}else this.t.width=this.t.canvas[0].width,this.t.height=this.t.canvas[0].height,this.t.ratio=this.t.width/this.t.height;this.t.canvas.forEach((t,i)=>{this.t.context[i]=t.getContext("2d")}),this.F=this.t.canvas.length,this.T=Array.from({length:this.F},t=>0),s.clickToPlayAudio&&this.i.push({n:this.t.canvas[0],e:"click",f:this.playAudioOfScene.bind(this)}),this.k=!!s.reduceFramerate,this.i.forEach(t=>{t.n.addEventListener(t.e,t.f)}),this.switchScene(s.scene,s.sceneParameter||{})}handleVisibilityChange(){this.O&&(this.O.enabled=!("hidden"==document.visibilityState))}playAudioOfScene(){this.M&&this.h&&this.h.timing.audioElement&&this.h.timing.audioElement.play()}normContext(t){t.textBaseline="middle",t.textAlign="center",t.globalAlpha=1,t.globalCompositeOperation="source-over"}getWidth(){return this.t.width}getHeight(){return this.t.height}getRatio(){return this.t.ratio}getOutput(){return this.t}recalculateCanvas(){return this.P=!0,this}N(){if(this.O){const t=h(this.O.referenceWidth),i=h(this.O.referenceHeight);if(t<=0||i<=0)return;this.t.canvas.forEach(s=>{s.width=Math.round(t/this.O.currentScale),s.height=Math.round(i/this.O.currentScale),this.O.setCanvasStyle&&(s.style.width=t+"px",s.style.height=i+"px")}),this.O.currentWaitedTime=0,this.O.currentOffsetTime=0}this.t.width=this.t.canvas[0].width,this.t.height=this.t.canvas[0].height,this.t.ratio=this.t.width/this.t.height,this.resize()}recalculateFPS(){try{const t=this;return t.I&&(window.cancelAnimationFrame(t.I),t.I=void 0),Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){function i(){const i=(t.B()-s)/h;t.O.offsetTimeTarget=i,t.O.offsetTimeDelta=i/3,void 0===t.I&&(t.S=void 0,t.I=window.requestAnimationFrame(t.W.bind(t)))}const s=t.B(),h=3;let e=h;const a=function(t,i,s){for(var h;;){var e=t();if(o(e)&&(e=e.v),!e)return a;if(e.then){h=0;break}var a=s();if(a&&a.then){if(!o(a)){h=1;break}a=a.s}}var c=new n,u=r.bind(null,c,2);return(0===h?e.then(d):1===h?a.then(l):(void 0).then(function(){(e=t())?e.then?e.then(d).then(void 0,u):d(e):r(c,1,a)})).then(void 0,u),c;function l(i){a=i;do{if(!(e=t())||o(e)&&!e.v)return void r(c,1,a);if(e.then)return void e.then(d).then(void 0,u);o(a=s())&&(a=a.v)}while(!a||!a.then);a.then(l).then(void 0,u)}function d(t){t?(a=s())&&a.then?a.then(l).then(void 0,u):l(a):r(c,1,a)}}(function(){return e--},0,function(){return Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){})});return a&&a.then?a.then(i):i()})}catch(t){return Promise.reject(t)}}resize(){return this.h&&this.h.resize&&this.h.resize(),this}switchScene(t,i){return void 0===i&&(i=void 0),t&&(this.u=t,this.l=i),this}B(){return window.performance?performance.now():Date.now()}W(t){if(!this.I)return;this.I=window.requestAnimationFrame(this.W.bind(this));let i=this.P&&(!this.k||!this._);i&&(this.N(),this.P=!1);for(let t=0;t<this.F;t++)this.T[t]=Math.max(this.T[t]-1,i?1:0);if(this.S||(this.S=t),this.j||(this.j=t),this.u&&!this.A&&(this.A=Promise.resolve(this.h?this.h.destroy():void 0),this.A.then(i=>{this.u.callInit({run:this.D,scene:this.l,destroy:i},this),this.h=this.u,this.u=void 0,this.A=void 0,this.M=!1,this.C=this.h.currentTime(),this.j=t})),this.h&&(this.k&&(this._=!this._),!this.k||this._)){let i=this.h.currentTime(),s=this.h.clampTime(i-this.C);const h=this.h.shiftTime(s);if(s+=h,this.C=i+h,this.M){const i=0!==s||this.L;this.L=!1;const h=this.B();if(this.t.canvas[0].width)for(let t=0;t<this.F;t++)this.normContext(this.t.context[t]),this.h.initSprites(t);const e=this.h.isDrawFrame(s);if(Array.isArray(e))for(let t=0;t<this.F;t++)this.T[t]=Math.max(this.T[t],e[t],0);else for(let t=0;t<this.F;t++)this.T[t]=Math.max(this.T[t],e,0);if(i&&this.h.move(s),this.t.canvas[0].width)for(let t=0;t<this.F;t++)this.T[t]&&this.h.draw(t);if(this.O&&this.O.enabled){const s=t-this.S;if(this.O.currentWaitedTime<this.O.waitTime)this.O.currentWaitedTime+=s;else if(i){const t=this.O.offsetTimeTarget*(this.k?2:1),i=this.B()-h,e=(Math.abs(s-t)>Math.abs(i-t)?s:i)-t;Math.abs(e)<=this.O.offsetTimeDelta?this.O.currentOffsetTime=this.O.currentOffsetTime>=0?Math.max(0,this.O.currentOffsetTime-this.O.offsetTimeDelta):Math.min(0,this.O.currentOffsetTime+this.O.offsetTimeDelta):e<0&&this.O.currentScale>this.O.scaleLimitMin?(this.O.currentOffsetTime+=e,this.O.currentOffsetTime<=-this.O.offsetTimeLimitDown&&(this.O.currentScale=Math.max(this.O.scaleLimitMin,this.O.currentScale/this.O.scaleFactor),this.P=!0)):e>0&&this.O.currentScale<this.O.scaleLimitMax&&(this.O.currentOffsetTime+=e,this.O.currentOffsetTime>=this.O.offsetTimeLimitUp&&(this.O.currentScale=Math.min(this.O.scaleLimitMax,this.O.currentScale*this.O.scaleFactor),this.P=!0))}}}else{for(let t=0;t<this.F;t++)this.normContext(this.t.context[t]);this.M=this.h.callLoading({timePassed:t-this.S,totalTimePassed:t-this.j}),this.M&&(this.h.reset(),this.C=this.h.currentTime(),this.L=!0,this.O&&(this.O.currentWaitedTime=0))}}this.S=t}run(t){try{const i=this;return i.D=t||{},Promise.resolve(i.stop()).then(function(){function t(){return i.I=window.requestAnimationFrame(i.W.bind(i)),i}i.S=i.j=void 0;const s=function(){if(i.O&&!i.O.offsetTimeTarget)return Promise.resolve(i.recalculateFPS()).then(function(){})}();return s&&s.then?s.then(t):t()})}catch(t){return Promise.reject(t)}}stop(){try{const t=this;function i(t){}return t.I&&window.cancelAnimationFrame(t.I),t.I=void 0,Promise.resolve(t.h?Promise.resolve(t.h.destroy()).then(i):void 0)}catch(s){return Promise.reject(s)}}destroy(){try{const t=this;return Promise.resolve(t.stop()).then(function(){return t.i.forEach(t=>{t.n.removeEventListener(t.e,t.f)}),t.i=[],t})}catch(t){return Promise.reject(t)}}}var c=new class{constructor(){this.Images=void 0,this.count=void 0,this.loaded=void 0,this.X=[],this.Images={},this.count=0,this.loaded=0}add(t,i){void 0===i&&(i=void 0);const s=this;for(const h in t)if(s.Images[h])i&&"function"==typeof i[h]&&i[h](h,s.Images[h]);else{const e=t[h];if(s.Images[h]=new window.Image,s.Images[h].onload=function(){s.loaded++,i&&"function"==typeof i?s.isLoaded()&&i():i&&"function"==typeof i[h]&&i[h](h,s.Images[h]),s.X&&s.isLoaded()&&(s.X.forEach(t=>t(void 0)),s.X=[])},"<svg"===e.substr(0,4)){const t=window.URL||window.webkitURL,i=new window.Blob([e],{type:"image/svg+xml"});s.Images[h].src=t.createObjectURL(i)}else/^(https?:)?\/\//.test(e)&&(s.Images[h].onerror=()=>{const t=new window.Image;t.onload=s.Images[h].onload,s.Images[h]=t,s.Images[h].src=e},s.Images[h].crossOrigin="anonymous"),s.Images[h].src=e;s.count++}return i&&"function"==typeof i&&s.isLoaded()&&i(),s.X&&s.isLoaded()&&(s.X.forEach(t=>t(void 0)),s.X=[]),s}reset(){return this.Images={},this.count=0,this.loaded=0,this}isLoaded(){return this.loaded===this.count}getImage(t){return"object"==typeof t?t:this.Images[t]}isLoadedPromise(){return!!this.isLoaded()||new Promise((t,i)=>{this.X.push(t)})}};class u{constructor(t){this.Y=void 0,this.U=void 0,this.R=void 0,this.H=void 0,this.q=void 0,this.Y=[],this.U=[],this.R=0,this.H=0,this.q=void 0===t?[]:Array.isArray(t)?t:[t]}addElement(t){return this.addElementForId(t),t}addElements(t){return this.addElementsForIds(t),t}addElementForId(t){let i=this.Y.length,s=this.H;this.Y[s]=t,this.U[s]="function"==typeof t,i===s&&i++;let h=this.H+1;for(;h!==i&&this.Y[h];)h++;return this.H=h,this.R>s&&(this.R=s),s}addElementsForIds(t){let i=this.Y.length;return i===this.H?(this.Y=this.Y.concat(t),this.H=this.Y.length,t.forEach((t,s)=>{this.U[i+s]="function"==typeof t}),Array.from({length:t.length},(t,s)=>s+i)):t.map(t=>this.addElement(t))}getById(t){return this.Y[t]}getIdByElement(t){return this.Y.indexOf(t)}deleteByElement(t){const i=this.getIdByElement(t);i>=0&&this.deleteById(i)}deleteById(t){let i=this.Y.length-1;if(i>0&&t===i){for(this.Y[t]=void 0;i&&!this.Y[i-1];)i--;this.Y.length=i,this.U.length=i,this.H=Math.min(this.H,i),this.R=Math.min(this.R,i)}else this.Y[t]&&(this.Y[t]=void 0,this.H=Math.min(this.H,t),this.R===t&&(this.R=t+1))}isCanvasId(t){return void 0===t||!this.q.length||this.q.includes(t)}forEach(t,i){let s,h;void 0===i&&(i=0);const e=this.Y.length;for(s=this.R;s<e;s++)if(h=this.Y[s],h&&!1===t({elementId:s,layerId:i,element:h,isFunction:this.U[s],layer:this}))return}getElementsByTag(t){let i=[];return this.forEach(s=>{let{element:h,isFunction:e}=s;if(!e){const s=h.getElementsByTag(t);s&&(i=i.concat(s))}}),i}play(t,i){void 0===t&&(t=""),void 0===i&&(i=0),this.forEach(s=>{let{element:h,isFunction:e}=s;return!e&&h.play(t,i)})}count(){let t=0;const i=this.Y.length;for(let s=this.R;s<i;s++)this.Y[s]&&t++;return t}clear(){this.Y=[],this.U=[],this.R=0,this.H=0}}class l{constructor(){this.G=void 0,this.G=[]}addLayer(t){return void 0===t&&(t=void 0),this.G[this.G.length]=new u(t),this.G[this.G.length-1]}addLayers(t,i){void 0===t&&(t=1),void 0===i&&(i=void 0);let s=Array.from({length:t},t=>new u(i));return this.G=this.G.concat(s),s}addLayerForId(t){return void 0===t&&(t=void 0),this.G[this.G.length]=new u(t),this.G.length-1}addLayersForIds(t,i){void 0===t&&(t=1),void 0===i&&(i=void 0);const s=Array.from({length:t},(t,i)=>i+this.G.length);return this.G=this.G.concat(Array.from({length:t},t=>new u(i))),s}getById(t){return this.G[t]}forEach(t,i){let s;const h=this.G.length;for(s=0;s<h;s++)this.G[s].isCanvasId(i)&&this.G[s].forEach(t,s)}play(t,i){void 0===t&&(t=""),void 0===i&&(i=0),this.forEach(s=>{let{element:h,isFunction:e}=s;return!e&&h.play(t,i)})}getElementsByTag(t){let i=[];return this.forEach(s=>{let{element:h,isFunction:e}=s;if(!e){const s=h.getElementsByTag(t);s&&(i=i.concat(s))}}),i}count(){return this.G.length}clear(){this.G=[]}}class d{constructor(){this.m=[1,0,0,1,0,0]}V(){this.reset()}reset(){return this.m=[1,0,0,1,0,0],this}multiply(t){const i=this.m[1]*t.m[0]+this.m[3]*t.m[1],s=this.m[0]*t.m[2]+this.m[2]*t.m[3],h=this.m[1]*t.m[2]+this.m[3]*t.m[3],e=this.m[0]*t.m[4]+this.m[2]*t.m[5]+this.m[4],r=this.m[1]*t.m[4]+this.m[3]*t.m[5]+this.m[5];return this.m[0]=this.m[0]*t.m[0]+this.m[2]*t.m[1],this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this}invert(){const t=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),i=-this.m[1]*t,s=-this.m[2]*t,h=this.m[0]*t,e=t*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),r=t*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=this.m[3]*t,this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this}rotate(t){const i=Math.cos(t),s=Math.sin(t),h=this.m[1]*i+this.m[3]*s,e=this.m[0]*-s+this.m[2]*i,r=this.m[1]*-s+this.m[3]*i;return this.m[0]=this.m[0]*i+this.m[2]*s,this.m[1]=h,this.m[2]=e,this.m[3]=r,this}translate(t,i){return this.m[4]+=this.m[0]*t+this.m[2]*i,this.m[5]+=this.m[1]*t+this.m[3]*i,this}scale(t,i){return this.m[0]*=t,this.m[1]*=t,this.m[2]*=i,this.m[3]*=i,this}transformPoint(t,i){const s=t;return[t=s*this.m[0]+i*this.m[2]+this.m[4],i=s*this.m[1]+i*this.m[3]+this.m[5]]}clone(){const t=new d;return t.m=this.m.slice(0),t}}function v(t,i){return null==t||""===t?i:t}class f{constructor(t){void 0===t&&(t={}),this.K=void 0,this.Z=void 0,this.J=void 0,this.$=void 0,this.type="timing",this.totalTimePassed=0,this.K=t,this.Z=v(h(this.K.tickChunk),120),this.J=v(h(this.K.maxSkippedTickChunk),120),this.$=v(h(this.K.tickChunkTolerance),.1)}init(t){}currentTime(){return window.performance?performance.now():Date.now()}clampTime(t){let{timePassed:i}=t;const s=this.Z?this.Z*this.J:2e3;return i>s?s:i}shiftTime(t){let{timePassed:i}=t;return this.Z?-i%this.Z:0}get tickChunk(){return this.Z}isChunked(){return!!this.Z}hasOneChunkedFrame(t){let{timePassed:i}=t;return i>=this.Z-this.$}calcFrames(t){let{timePassed:i}=t;return Math.min(this.J,Math.floor((i+this.$)/this.Z))}}const m="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function p(t,i,s){if(!t.s){if(s instanceof y){if(!s.s)return void(s.o=p.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(p.bind(null,t,i),p.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const y=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{p(h,1,t(this.v))}catch(t){p(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?p(h,1,i?i(e):e):s?p(h,1,s(e)):p(h,2,e)}catch(t){p(h,2,t)}},h},t}();function g(t){return t instanceof y&&1&t.s}const w={tt:[],init:[],isDrawFrame:[],initSprites:[],fixedUpdate:[],update:[],draw:[],destroy:[],reset:[],resize:[],currentTime:[],clampTime:[],shiftTime:[],isChunked:[],hasOneChunkedFrame:[],calcFrames:[],tickChunk:[],additionalModifier:[]};class M{constructor(){this.it=void 0,this.st=void 0,this.ht=void 0,this.et=void 0,this.rt=w,this.nt=!1,this.ot=void 0,this.ct=void 0,this.ut=void 0,this.lt=!1,this.dt=void 0,this.vt=!1,this.it=new l,this.ht=0,this.st=c,this.middlewares=[].slice.call(arguments),this.middlewareByType("timing")||(this.middlewares=[f,...this.middlewares])}t(){var t;return null==(t=this.et)?void 0:t.getOutput()}set middlewares(t){this.rt=e(t).map(t=>"function"==typeof t?new t:t).reduce((t,i)=>{for(let s of Object.keys(t))s in i&&t[s].push(i);return t.tt.push(i),"enabled"in i||(i.enabled=!0),i.type&&(t["t_"+i.type]=[i]),t},w)}get middlewares(){return this.rt.tt}middlewareByType(t){const i=this.rt.tt.filter(i=>i.type===t);if(i.length)return i[i.length-1]}has(t){return t in this.rt||this.rt.tt.some(i=>t in i)}do(t,i,s,h){let e=this.rt[t]||this.rt.tt.filter(i=>t in i);return e=e.filter(t=>t.enabled),e.length?h(e,this.ft(i),s):s}map(t,i){return this.do(t,i,[],(i,s)=>i.map(i=>i[t](s)))}pipe(t,i,s){return void 0===s&&(s=void 0),this.do(t,i,s,(i,h)=>{let e=s;this.nt=!1;for(let s of i)if(e=s[t](h,e),this.nt)break;return e})}pipeBack(t,i,s){return void 0===s&&(s=void 0),this.do(t,i,s,(i,h)=>{let e=s;this.nt=!1;for(let s=i.length-1;s>=0&&(e=i[s][t](h,e),!this.nt);s--);return e})}pipeMax(t,i,s){return void 0===s&&(s=void 0),this.do(t,i,Array.isArray(s)?s.map(t=>t-0):s-0,(i,s,h)=>{let e=h;if(this.nt=!1,Array.isArray(e))for(let h of i){let i=h[t](s,e);if(e=Array.isArray(i)?e.map((t,s)=>Math.max(t,i[s])):e.map((t,s)=>Math.max(t,i)),this.nt)break}else for(let h of i){let i=h[t](s,e);if(e=Array.isArray(i)?i.map(t=>Math.max(t,e)):Math.max(i,e),this.nt)break}return e})}pipeAsync(t,i,s){void 0===s&&(s=void 0);try{const h=this;return Promise.resolve(h.do(t,i,s,function(i,e){try{let r,n=s;h.nt=!1;const o=function(t,i,s){if("function"==typeof t[m]){var h,e,r,n=t[m]();if(function t(o){try{for(;!((h=n.next()).done||s&&s());)if((o=i(h.value))&&o.then){if(!g(o))return void o.then(t,r||(r=p.bind(null,e=new y,2)));o=o.v}e?p(e,1,o):e=o}catch(t){p(e||(e=new y),2,t)}}(),n.return){var o=function(t){try{h.done||n.return()}catch(t){}return t};if(e&&e.then)return e.then(o,function(t){throw o(t)});o()}return e}if(!("length"in t))throw new TypeError("Object is not iterable");for(var a=[],c=0;c<t.length;c++)a.push(t[c]);return function(t,i,s){var h,e,r=-1;return function n(o){try{for(;++r<t.length&&(!s||!s());)if((o=i(r))&&o.then){if(!g(o))return void o.then(n,e||(e=p.bind(null,h=new y,2)));o=o.v}h?p(h,1,o):h=o}catch(t){p(h||(h=new y),2,t)}}(),h}(a,function(t){return i(a[t])},s)}(i,function(i){return Promise.resolve(i[t](e,n)).then(function(t){n=t,h.nt&&(r=1)})},function(){return r});return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(t){return Promise.reject(t)}}))}catch(t){return Promise.reject(t)}}value(t,i){void 0===i&&(i=void 0);let s=this.rt[t]||this.rt.tt.filter(i=>t in i);if(s.filter(t=>t.enabled),!s.length)return;const h=s[s.length-1];return"function"==typeof h[t]?h[t].call(h,this.ft(i||{})):h[t]}stopPropagation(){this.nt=!0}currentTime(){return this.pipe("currentTime",{})}clampTime(t){return this.pipe("clampTime",{timePassed:t})}shiftTime(t){return this.pipe("shiftTime",{timePassed:t})}cacheClear(){this.ot=void 0,this.ct=void 0}viewport(){return this.et?(this.ot||(this.ot=this.pipe("viewport",{},new d),this.ct=void 0),this.ot):new d}transformPoint(t,i,s){return void 0===s&&(s=this.ut.scaleCanvas),this.ct||(this.ct=this.viewport().clone().invert()),this.ct.transformPoint(t*s,i*s)}callInit(t,i){this.et=i,this.resize();const s=this.value("images");s&&this.st.add(s),Promise.all(this.map("init",{parameter:t})).then(t=>{this.lt=!0})}get additionalModifier(){return this.ut}updateAdditionalModifier(){const t=this.t();this.ut=this.pipe("additionalModifier",{},{alpha:1,x:0,y:0,width:t.width,height:t.height,widthInPixel:t.width,heightInPixel:t.height,scaleCanvas:1,visibleScreen:{x:0,y:0,width:t.width,height:t.height},fullScreen:{x:0,y:0,width:t.width,height:t.height}})}resize(){const t=this.t();this.updateAdditionalModifier(),this.pipe("resize",{}),this.it.forEach(i=>{let{element:s,isFunction:h}=i;h||s.resize(t,this.ut)})}destroy(){try{const t=this;return Promise.resolve(t.pipeAsync("destroy",{})).then(function(i){return t.lt=!1,i})}catch(t){return Promise.reject(t)}}get timing(){return this.rt.t_timing[0]}get camera(){return this.rt.t_camera[0]}get control(){return this.rt.t_control[0]}get totalTimePassed(){return this.ht}ft(t){return void 0===t&&(t=void 0),Object.assign({engine:this.et,scene:this,imageManager:this.st,layerManager:this.it,totalTimePassed:this.ht,output:this.t()},t)}callLoading(t){if(this.st.isLoaded()&&this.lt){this.dt=this.value("endTime");const i="Click to play";return this.value("loading",{...t,progress:i}),!0}const i=this.st.count?this.st.loaded/this.st.count:"Loading...";return this.value("loading",{...t,progress:i}),!1}fixedUpdate(t,i){this.map("fixedUpdate",{timePassed:t,lastCall:i})}isDrawFrame(t){return this.pipeMax("isDrawFrame",{timePassed:t},0!==t)}move(t){if(this.ht+=t,this.vt?this.reset():t<0?(t=this.ht,this.reset(),this.initSprites(),this.ht=t):this.dt&&this.dt<=this.ht&&(t-=this.ht-this.dt,this.ht=this.dt,this.map("end",{timePassed:t})),this.value("isChunked")){if(this.value("hasOneChunkedFrame",{timePassed:t})){const i=this.value("calcFrames",{timePassed:t})-1;for(let t=0;t<=i;t++)this.fixedUpdate(this.value("tickChunk",{}),t===i)}}else this.fixedUpdate(t,!0);this.map("update",{timePassed:t}),this.it.forEach(i=>{let{element:s,isFunction:h,layer:e,elementId:r}=i;h||s.animate(t)&&e.deleteById(r)})}draw(t){this.map("draw",{canvasId:t});const i=this.t().context[t];i.save(),i.setTransform(...this.viewport().m),this.it.forEach(t=>{let{layer:s,layerId:h,element:e,isFunction:r,elementId:n}=t;r?e(this.ft({layerId:h,elementId:n,layer:s,context:i}))&&s.deleteById(n):e.draw(i,this.ut)},t),i.restore()}initSprites(t){void 0===t&&(t=void 0);const i=this.t().context[t||0];this.it.forEach(t=>{let{element:s,isFunction:h}=t;h||s.callInit(i,this.ut)},t),this.map("initSprites",{canvasId:t})}resetIntend(){this.vt=!0}reset(){this.ht=0,this.vt=!1;let t=this.pipe("reset",{},new l);if(Array.isArray(t)){const i=t;t=new l,i.forEach(i=>{t.addLayer().addElements(i)})}t&&(this.it=t)}}class b{constructor(t){this.yt=void 0,this.yt=h(t)-0}run(t,i){return i-this.yt}}var x;!function(t){t.FORCE_DISABLE="F",t.STOP="S",t.REMOVE="R"}(x||(x={}));class P{constructor(){this.sequences=[],this.lastTimestamp=0,this.enabled=!0;var t=[].slice.call(arguments);let i=0;"number"==typeof t[0]&&(i=t.shift()),this.sequences=t.map(t=>{Array.isArray(t)||(t=[t]);let s=i;return"number"==typeof t[0]&&(s=t.shift()),{position:0,timelapsed:-s,sequence:t.map(t=>"function"!=typeof t.run?"number"==typeof t?new b(t):{run:t}:t).filter(t=>"function"==typeof t.run),label:t.reduce((t,i,s)=>("string"==typeof i&&(t[i]=s-Object.keys(t).length),t),{}),enabled:!0}})}reset(t){void 0===t&&(t=0),this.sequences.forEach(i=>{var s;i.enabled=!0,i.position=0,i.timelapsed=t,null==(s=i.sequence[0])||null==s.reset||s.reset(t)}),this.enabled=!0}play(t,i){if(void 0===t&&(t=""),void 0===i&&(i=0),t){const s=this.sequences.reduce((s,h)=>{var e;return t in h.label?(s=!0,h.position=h.label[t],h.enabled=!0,h.timelapsed=i,null==(e=h.sequence[h.position])||null==e.reset||e.reset()):s=s||h.sequence.some(s=>null==s.play?void 0:s.play(t,i)),s},!1);return s&&(this.enabled=!0),s}return this.sequences.forEach(t=>t.enabled=!0),this.enabled=!0,!0}gt(t,i,s){let h=s;for(;i.sequence[i.position]&&h>=0;){if(i.timelapsed+=h,i.timelapsed<0)return-1;const r=i.sequence[i.position].run(t,i.timelapsed);if(!0===r)h=0;else{if(!1===r)return-1;if(r===x.FORCE_DISABLE)return i.enabled=!1,this.enabled=!1,s;if(r===x.STOP)return i.enabled=!1,s;if(r===x.REMOVE)return!0}var e;if(h=r,h>=0&&(i.position=(i.position+1)%i.sequence.length,null==(e=i.sequence[i.position])||null==e.reset||e.reset(),i.timelapsed=0,0===i.position))return i.enabled=!1,h}return h}run(t,i,s){void 0===s&&(s=!1);let h=i;if(s||(h=i-this.lastTimestamp,this.lastTimestamp=i),!this.enabled)return h;const e=this.sequences.length;let r=0,n=Infinity;for(let i=0;i<e;i++)if(this.sequences[i].enabled){const s=this.gt(t,this.sequences[i],h);if(!0===s)return!0;n=Math.min(n,s)}else r++;return r===e?(this.enabled=!1,h):n}}class C{constructor(t){this.wt=!0,this.p=void 0,this.p=this.Mt(this.bt(),t)}Mt(t,i){const s=Object.entries(t).map(t=>{let[s,e]=t;const r=i[s];return[s,"function"==typeof e?e(r,i):v(h(r),e)]});return Object.fromEntries(s)}xt(){return{animation:(t,i)=>{const s=h(t);return Array.isArray(s)?new P(s):s},enabled:!0,isClickable:!1,tag:(t,i)=>{const s=h(t);return Array.isArray(s)?s:s?[s]:[]}}}bt(){return this.xt()}getElementsByTag(t){if("function"==typeof t){if(this.p.tag.filter(t).length)return[this]}else if((Array.isArray(t)?t:[t]).filter(t=>this.p.tag.includes(t)).length)return[this];return[]}animate(t){return!(!this.p.animation||!0!==this.p.animation.run(this,t,!0)||(this.p.enabled=!1,0))}play(t,i){var s,h;void 0===t&&(t=""),void 0===i&&(i=0),this.p.animation&&(null==(s=(h=this.p.animation).play)||s.call(h,t,i))}init(t,i){}callInit(t,i){this.wt&&(this.init(t,i),this.wt=!1)}resize(t,i){}Pt(t,i,s,h,e){let r=!1;return t.enabled&&t.isClickable&&(i.save(),i.translate(t.x,t.y),i.scale(t.scaleX,t.scaleY),i.rotate(t.rotation),i.beginPath(),r=e(),i.restore()),r?this:void 0}Ct(t,i,s,h,e,r){let{enabled:n,isClickable:o,x:a=0,y:c=0,width:u=0,height:l=0,scaleX:d=1,scaleY:v=1,rotation:f=0}=t,m=!1;if(n&&o){const t=u/2,n=l/2;i.save(),e?i.translate(a+t,c+n):i.translate(a,c),i.scale(d,v),i.rotate(f),i.beginPath(),r?m=r(t,n):(i.rect(-t,-n,u,l),i.closePath(),m=i.isPointInPath(s,h)),i.restore()}return m?this:void 0}detectDraw(t,i){}detect(t,i,s){}draw(t,i){}}const I=Math.PI/180,O={x:0,y:0,rotation:(t,i)=>v(h(t),v(h(i.rotationInRadian),v(h(i.rotationInDegree),0)*I)),scaleX:(t,i)=>v(h(t),v(h(i.scale),1)),scaleY:(t,i)=>v(h(t),v(h(i.scale),1)),alpha:1,compositeOperation:"source-over",color:"#fff"};class F extends C{constructor(t){super(t)}bt(){return Object.assign({},super.bt(),O,{sprite:[]})}getElementsByTag(t){let i=super.getElementsByTag(t);for(const s of this.p.sprite){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}return i}animate(t){let i=super.animate(t),s=!1;if(this.p.enabled)for(const i of this.p.sprite)s=s||!0===i.animate(t);return this.p.animation?i:(s&&(this.p.enabled=!1),s)}play(t,i){var s,h;void 0===t&&(t=""),void 0===i&&(i=0),this.p.animation&&(null==(s=(h=this.p.animation).play)||s.call(h,t,i));for(const s of this.p.sprite)null==s.play||s.play(t,i)}resize(t,i){for(const s of this.p.sprite)s.resize(t,i)}callInit(t,i){super.callInit(t,i);for(let s of this.p.sprite)s.callInit(t,i)}detectDraw(t,i){if(this.p.enabled)for(const s of this.p.sprite)s.detectDraw(t,i)}detect(t,i,s){if(this.p.enabled)for(const h of this.p.sprite){const e=h.detect(t,i,s);if(e)return e}}draw(t,i){if(this.p.enabled){this.p.alpha<1&&((i=Object.assign({},i)).alpha*=this.p.alpha),t.save(),t.translate(this.p.x,this.p.y),t.scale(this.p.scaleX,this.p.scaleY),t.rotate(this.p.rotation);for(const s of this.p.sprite)s.draw(t,i);t.restore()}}}class T extends F{constructor(t){super(t.self||{});let i=v(h(t.count),1);this.p.sprite=[];const s=t.class;for(let e=0;e<i;e++){const i=Object.entries(t).reduce((t,i)=>{let[s,r]=i;return["self","class","count"].includes(s)||(t[s]=h(r,e)),t},{});this.p.sprite[e]=new s(i)}}}class k extends C{constructor(t){super(t),this.It=void 0,this.Ot=void 0,this.Ft=void 0}bt(){return Object.assign({},super.bt(),{x:void 0,y:void 0,width:void 0,height:void 0,gridSize:void 0,darker:0,pixel:!1,clear:!1,norm:(t,i)=>v(h(t),void 0===h(i.x)&&void 0===h(i.y)&&void 0===h(i.width)&&void 0===h(i.height)),scaleX:(t,i)=>v(h(t),v(h(i.scale),1)),scaleY:(t,i)=>v(h(t),v(h(i.scale),1)),alpha:1,compositeOperation:"source-over"})}Tt(t){const i=t.widthInPixel,s=t.heightInPixel,h=this.p;this.It=document.createElement("canvas"),h.gridSize?(this.Ot=h.gridSize,this.It.width=Math.round(this.Ot),this.It.height=Math.round(this.Ot)):(this.It.width=Math.ceil(i/h.scaleX),this.It.height=Math.ceil(s/h.scaleY)),this.Ft=this.It.getContext("2d"),this.Ft.globalCompositeOperation="source-over",this.Ft.globalAlpha=1}normalizeFullScreen(t){const i=this.p;(i.norm||void 0===i.x)&&(i.x=t.visibleScreen.x),(i.norm||void 0===i.y)&&(i.y=t.visibleScreen.y),(i.norm||void 0===i.width)&&(i.width=t.visibleScreen.width),(i.norm||void 0===i.height)&&(i.height=t.visibleScreen.height)}resize(t,i){if(this.It&&this.Ot!==this.p.gridSize){const t=this.It;this.Tt(i),this.Ft.globalCompositeOperation="copy",this.Ft.drawImage(t,0,0,t.width,t.height,0,0,this.It.width,this.It.height),this.Ft.globalCompositeOperation="source-over"}this.normalizeFullScreen(i)}detect(t,i,s){return this.Ct(this.p,t,i,s,!1)}init(t,i){this.Tt(i),this.normalizeFullScreen(i)}draw(t,i){const s=this.p;if(s.enabled&&s.alpha>0){s.gridSize&&this.Ot!==s.gridSize&&this.resize(void 0,i);const e=s.alpha*i.alpha,r=s.width,n=s.height,o=this.It.width,a=this.It.height;if(e>0&&o&&a){var h;this.Ft.globalCompositeOperation="copy",this.Ft.globalAlpha=1,this.Ft.drawImage(t.canvas,0,0,t.canvas.width,t.canvas.height,0,0,o,a),s.darker>0&&(this.Ft.globalCompositeOperation=s.clear?"source-atop":"source-over",this.Ft.fillStyle="rgba(0,0,0,"+s.darker+")",this.Ft.fillRect(0,0,o,a)),null==(h=this.additionalBlur)||h.call(this,o,a,i),s.clear&&(t.globalCompositeOperation="source-over",t.globalAlpha=1,t.clearRect(s.x,s.y,r,n)),t.globalCompositeOperation=s.compositeOperation,t.globalAlpha=e;const c=t.imageSmoothingEnabled;t.imageSmoothingEnabled=!s.pixel,t.drawImage(this.It,0,0,o,a,s.x,s.y,r,n),t.imageSmoothingEnabled=c}}else s.clear&&(s.x||(s.x=i.x),s.y||(s.y=i.y),s.width||(s.width=i.width),s.height||(s.height=i.height),t.clearRect(s.x,s.y,s.width,s.height))}}var S;!function(t){t[t.LEFT_TOP=0]="LEFT_TOP",t[t.CENTER=1]="CENTER"}(S||(S={}));class _ extends C{constructor(t){super(t)}bt(){return Object.assign({},this.xt(),O,{text:t=>{const i=h(t);return(Array.isArray(i)?i.join(""):i)||""},font:"2em monospace",position:S.CENTER,color:void 0,borderColor:void 0,lineWidth:1})}detectDraw(t,i){this.p.enabled&&this.p.isClickable&&(t.save(),t.translate(this.p.x,this.p.y),t.scale(this.p.scaleX,this.p.scaleY),t.rotate(this.p.rotation),this.p.position||(t.textAlign="left",t.textBaseline="top"),t.font=this.p.font,t.fillStyle=i,t.fillText(this.p.text,0,0),t.restore())}detect(t,i,s){return"c"}draw(t,i){this.p.enabled&&(t.globalCompositeOperation=this.p.compositeOperation,t.globalAlpha=this.p.alpha*i.alpha,t.save(),this.p.position||(t.textAlign="left",t.textBaseline="top"),t.translate(this.p.x,this.p.y),t.scale(this.p.scaleX,this.p.scaleY),t.rotate(this.p.rotation),t.font=this.p.font,this.p.color&&(t.fillStyle=this.p.color,t.fillText(this.p.text,0,0)),this.p.borderColor&&(t.strokeStyle=this.p.borderColor,t.lineWidth=this.p.lineWidth,t.strokeText(this.p.text,0,0)),t.restore())}}class j extends C{constructor(t){super(t),this.kt=void 0,this.St=!1}bt(){return Object.assign({},super.bt(),{x:0,y:0,scaleX:(t,i)=>v(h(t),v(h(i.scale),1)),scaleY:(t,i)=>v(h(t),v(h(i.scale),1)),color:"#FFF",alpha:1,compositeOperation:"source-over"})}static getGradientImage(t,i,s){let h=t>>4,e=i>>4,r=s>>4;if(!j._t){const t=16;j._t=Array.from({length:t},i=>Array.from({length:t},i=>Array.from({length:t})))}return j._t[h][e][r]||(j._t[h][e][r]=j.generateGradientImage(h,e,r)),j._t[h][e][r]}static generateGradientImage(t,i,s){let h=document.createElement("canvas");h.width=h.height=64;let e=h.getContext("2d");e.globalAlpha=1,e.globalCompositeOperation="source-over",e.clearRect(0,0,64,64);let r=e.createRadialGradient(32,32,0,32,32,32);return r.addColorStop(0,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",1)"),r.addColorStop(.3,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0.4)"),r.addColorStop(1,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0)"),e.fillStyle=r,e.fillRect(0,0,64,64),h}resize(t,i){this.kt=void 0}draw(i,s){const h=this.p;if(h.enabled&&h.alpha>0){h.color&&h.color.r||(h.color=new t(h.color).toRgb()),this.kt!==h.scaleX&&(this.kt=h.scaleX,this.St=h.scaleX*s.widthInPixel/s.width>64);const{r:e,g:r,b:n}=h.color;i.globalCompositeOperation=h.compositeOperation,i.globalAlpha=h.alpha*s.alpha,i.imageSmoothingEnabled=this.St,i.drawImage(j.getGradientImage(e,r,n),0,0,64,64,h.x-h.scaleX/2,h.y-h.scaleY/2,h.scaleX,h.scaleY),i.imageSmoothingEnabled=!0}}}j._t=void 0;var E={Callback:class extends C{constructor(t){"function"==typeof t&&(t={callback:t}),super(t),this.jt=0}bt(){return Object.assign({},this.xt(),{callback:t=>void 0===typeof t?()=>{}:t})}animate(t){return this.p.enabled&&(this.jt+=t),super.animate(t)}draw(t,i){this.p.enabled&&this.p.callback(t,this.jt,i,this)}},Canvas:class extends F{constructor(t){super(t),this.Ot=void 0,this.T=2,this.It=void 0,this.Ft=void 0}bt(){return Object.assign({},super.bt(),{x:void 0,y:void 0,width:void 0,height:void 0,canvasWidth:void 0,canvasHeight:void 0,gridSize:void 0,compositeOperation:"source-over",norm:(t,i)=>v(h(t),void 0===h(i.x)&&void 0===h(i.y)&&void 0===h(i.width)&&void 0===h(i.height)),isDrawFrame:(t,i)=>v(t,1)})}Tt(t){const i=t.widthInPixel,s=t.heightInPixel,h=this.p;this.It=document.createElement("canvas"),h.canvasWidth&&h.canvasHeight?(this.It.width=h.canvasWidth,this.It.height=h.canvasHeight):h.gridSize?(this.Ot=h.gridSize,this.It.width=Math.round(this.Ot),this.It.height=Math.round(this.Ot)):(this.It.width=Math.round(i/h.scaleX),this.It.height=Math.round(s/h.scaleY)),this.Ft=this.It.getContext("2d")}Et(t){const i=this.p;(i.norm||void 0===i.x)&&(i.x=t.visibleScreen.x),(i.norm||void 0===i.y)&&(i.y=t.visibleScreen.y),(i.norm||void 0===i.width)&&(i.width=t.visibleScreen.width),(i.norm||void 0===i.height)&&(i.height=t.visibleScreen.height)}At(t){const i=this.p;if(this.It&&this.Ot!==i.gridSize&&!i.canvasWidth){const i=this.It;this.Tt(t),this.Ft.globalCompositeOperation="copy",this.Ft.drawImage(i,0,0,i.width,i.height,0,0,this.It.width,this.It.height),this.Ft.globalCompositeOperation="source-over",this.T=2}this.Et(t)}resize(t,i){this.At(i),super.resize(t,i)}detect(t,i,s){return this.Ct(this.p,t,i,s,!1)}init(t,i){this.Tt(i),this.Et(i)}draw(t,i){const s=this.p;if(s.enabled){s.gridSize&&this.Ot!==s.gridSize&&this.At(i),this.T=Math.max(this.T-1,h(s.isDrawFrame,t,i));const e=s.width,r=s.height,n=e/2,o=r/2,a=this.It.width,c=this.It.height;if(this.T){this.Ft.textBaseline="middle",this.Ft.textAlign="center",this.Ft.globalAlpha=1,this.Ft.globalCompositeOperation="source-over",this.Ft.save();const t=i.cam;if(s.norm&&t){const i=Math.max(a,c)/2;this.Ft.translate(a/2,c/2),this.Ft.scale(i,i),this.Ft.scale(t.zoom,t.zoom),this.Ft.translate(-t.x,-t.y)}for(const t of s.sprite)t.draw(this.Ft,s.norm?Object.assign({},i,{alpha:1,widthInPixel:a,heightInPixel:c}):{alpha:1,x:0,y:0,width:a,height:c,widthInPixel:a,heightInPixel:c,scaleCanvas:1,visibleScreen:{x:0,y:0,width:a,height:c},fullScreen:{x:0,y:0,width:a,height:c}});this.Ft.restore()}t.save(),t.globalCompositeOperation=s.compositeOperation,t.globalAlpha=s.alpha*i.alpha,t.translate(s.x+n,s.y+o),t.scale(s.scaleX,s.scaleY),t.rotate(s.rotation),t.drawImage(this.It,0,0,a,c,-n,-o,e,r),t.restore()}}},Circle:class extends C{constructor(t){super(t)}bt(){return Object.assign({},this.xt(),O)}detect(t,i,s){return this.Pt(this.p,t,i,s,()=>(t.arc(0,0,1,Math.PI/2+this.p.rotation,2.5*Math.PI-this.p.rotation,!1),t.isPointInPath(i,s)))}draw(t,i){this.p.enabled&&(t.globalCompositeOperation=this.p.compositeOperation,t.globalAlpha=this.p.alpha*i.alpha,t.save(),t.translate(this.p.x,this.p.y),t.scale(this.p.scaleX,this.p.scaleY),t.beginPath(),t.fillStyle=this.p.color,t.arc(0,0,1,Math.PI/2+this.p.rotation,2.5*Math.PI-this.p.rotation,!1),t.fill(),t.restore())}},Emitter:T,FastBlur:k,Group:F,Image:class extends C{constructor(t){super(t),this.zt=void 0,this.Dt=void 0,this.It=void 0,this.Ft=void 0}bt(){return Object.assign({},super.bt(),O,{image:t=>c.getImage(h(t)),position:S.CENTER,frameX:0,frameY:0,frameWidth:0,frameHeight:0,width:void 0,height:void 0,norm:!1,normCover:!1,normToScreen:!1,clickExact:!1,color:"#FFF",tint:0})}resize(t,i){this.wt=!0}init(t,i){const s=this.p,h=s.frameWidth||s.image.width,e=s.frameHeight||s.image.height;this.Dt=s.normToScreen?s.normCover?Math.max(i.fullScreen.width/h,i.fullScreen.height/e):s.norm?Math.min(i.fullScreen.width/h,i.fullScreen.height/e):1:s.normCover?Math.max(i.width/h,i.height/e):s.norm?Math.min(i.width/h,i.height/e):1}Lt(){return[this.p.tint,this.p.frameWidth||this.p.image.width,this.p.frameHeight||this.p.image.height,this.p.color,this.p.frameX,this.p.frameY].join(";")}Nt(t,i){return this.It||(this.It=document.createElement("canvas"),this.Ft=this.It.getContext("2d")),this.It.width=t,this.It.height=i,this.Ft}detectDraw(t,i){const s=this.p;if(s.enabled&&s.isClickable&&s.clickExact){const h=s.frameWidth||s.image.width,e=s.frameHeight||s.image.height,r=(s.width?s.width:h)*this.Dt*s.scaleX,n=(s.height?s.height:e)*this.Dt*s.scaleY,o=s.position===S.LEFT_TOP,a=this.Nt(h,e);a.globalAlpha=1,a.globalCompositeOperation="source-over",a.fillStyle=i,a.fillRect(0,0,h,e),a.globalCompositeOperation="destination-atop",a.drawImage(s.image,s.frameX,s.frameY,h,e,0,0,h,e),t.save(),t.translate(s.x,s.y),t.scale(s.scaleX,s.scaleY),t.rotate(s.rotation),t.drawImage(this.It,0,0,h,e,o?0:-r/2,o?0:-n/2,r,n),t.restore(),this.zt=void 0}}detect(t,i,s){return this.p.enabled&&this.p.isClickable&&this.p.clickExact?"c":this.Ct(this.p,t,i,s,!1)}draw(t,i){const s=this.p;if(s.enabled&&s.image&&s.alpha>0){const h=s.frameWidth||s.image.width,e=s.frameHeight||s.image.height,r=(s.width?s.width:h)*this.Dt*s.scaleX,n=(s.height?s.height:e)*this.Dt*s.scaleY;t.globalCompositeOperation=s.compositeOperation,t.globalAlpha=s.alpha*i.alpha;const o=s.position!==S.LEFT_TOP;let a=s.image,c=s.frameX,u=s.frameY;if(s.tint){const t=this.Lt();if(this.zt!==t){const i=this.Nt(h,e);i.globalAlpha=1,i.globalCompositeOperation="source-over",i.clearRect(0,0,h,e),i.globalAlpha=s.tint,i.fillStyle=s.color,i.fillRect(0,0,h,e),i.globalAlpha=1,i.globalCompositeOperation="destination-atop",i.drawImage(s.image,s.frameX,s.frameY,h,e,0,0,h,e),this.zt=t}a=this.It,c=0,u=0}let l=0,d=0;o&&(l=-r/2,d=-n/2),0==s.rotation?t.drawImage(a,c,u,h,e,s.x+l,s.y+d,r,n):(t.save(),t.translate(s.x,s.y),t.rotate(s.rotation),t.drawImage(a,c,u,h,e,l,d,r,n),t.restore())}}},Text:_,Particle:j,Path:class extends F{constructor(t){if(super(t),this.Bt=void 0,this.Wt=new Path2D,this.p.polyfill)if("function"!=typeof Path2D){let t=document.getElementsByTagName("head")[0],i=document.createElement("script");i.type="text/javascript",i.src="https://cdn.jsdelivr.net/npm/canvas-5-polyfill@0.1.5/canvas.min.js",t.appendChild(i)}else{let t=document.createElement("canvas").getContext("2d");t.stroke(new Path2D("M0,0H1")),t.getImageData(0,0,1,1).data[3]&&(this.p.polyfill=!1)}}bt(){return Object.assign({},super.bt(),{path:void 0,color:void 0,borderColor:void 0,lineWidth:1,clip:!1,fixed:!1,polyfill:!0})}changeToPathInit(t,s){return i.Xt("string"==typeof t?i.path2shapes(t):t,"string"==typeof s?i.path2shapes(s):s)}changeToPath(t,s){return i.Yt(s.pathFrom,s.pathTo,t)}detect(t,i,s){return this.Ct(this.p,t,i,s,!1,()=>t.isPointInPath(this.Wt,i,s))}draw(t,s){const h=this.p;if(h.enabled){const e=h.alpha*s.alpha;this.Bt!==h.path&&(h.polyfill&&"string"==typeof h.path&&(h.path=i.path2shapes(h.path)),Array.isArray(h.path)?(this.Wt=new Path2D,h.path.forEach(t=>{this.Wt.moveTo(t[0][0],t[0][1]),t.forEach(t=>{this.Wt.bezierCurveTo(t[2],t[3],t[4],t[5],t[6],t[7])}),this.Wt.closePath()})):this.Wt=h.path instanceof Path2D?h.path:new Path2D(h.path),this.Bt=h.path);let r=h.scaleX,n=h.scaleY;h.fixed&&(0==r&&(r=Number.EPSILON),0==n&&(n=Number.EPSILON)),t.globalCompositeOperation=h.compositeOperation,t.globalAlpha=e,t.save(),t.translate(h.x,h.y),t.scale(r,n),t.rotate(h.rotation),h.color&&(t.fillStyle=h.color,t.fill(this.Wt)),t.save(),h.clip&&(t.clip(this.Wt),h.fixed&&(t.rotate(-h.rotation),t.scale(1/r,1/n),t.translate(-h.x,-h.y)));for(const i of h.sprite)i.draw(t,s);t.restore(),h.borderColor&&(t.strokeStyle=h.borderColor,t.lineWidth=h.lineWidth,t.stroke(this.Wt)),t.restore()}}},Rect:class extends C{constructor(t){super(t)}bt(){return Object.assign({},super.bt(),O,{x:void 0,y:void 0,width:void 0,height:void 0,borderColor:void 0,color:void 0,lineWidth:1,clear:!1,norm:(t,i)=>v(h(t),void 0===h(i.x)&&void 0===h(i.y)&&void 0===h(i.width)&&void 0===h(i.height)),position:S.CENTER})}Et(t){(this.p.norm||void 0===this.p.width)&&(this.p.width=t.visibleScreen.width),(this.p.norm||void 0===this.p.height)&&(this.p.height=t.visibleScreen.height),(this.p.norm||void 0===this.p.x)&&(this.p.x=t.visibleScreen.x,this.p.position===S.CENTER&&(this.p.x+=this.p.width/2)),(this.p.norm||void 0===this.p.y)&&(this.p.y=t.visibleScreen.y,this.p.position===S.CENTER&&(this.p.y+=this.p.height/2))}resize(t,i){this.wt=!0}init(t,i){this.Et(i)}detect(t,i,s){return this.Ct(this.p,t,i,s,this.p.position===S.LEFT_TOP)}draw(t,i){const s=this.p;if(s.enabled&&s.alpha>0)if(t.globalCompositeOperation=s.compositeOperation,t.globalAlpha=s.alpha*i.alpha,0===s.rotation&&s.position===S.LEFT_TOP)s.clear?t.clearRect(s.x,s.y,s.width,s.height):s.color&&(t.fillStyle=s.color,t.fillRect(s.x,s.y,s.width,s.height)),s.borderColor&&(t.beginPath(),t.lineWidth=s.lineWidth,t.strokeStyle=s.borderColor,t.rect(s.x,s.y,s.width,s.height),t.stroke());else{let i=s.width/2,h=s.height/2;t.save(),s.position===S.LEFT_TOP?t.translate(s.x+i,s.y+h):t.translate(s.x,s.y),t.scale(s.scaleX,s.scaleY),t.rotate(s.rotation),s.clear?t.clearRect(-i,-h,s.width,s.height):s.color&&(t.fillStyle=s.color,t.fillRect(-i,-h,s.width,s.height)),s.borderColor&&(t.beginPath(),t.lineWidth=s.lineWidth,t.strokeStyle=s.borderColor,t.rect(-i,-h,s.width,s.height),t.stroke()),t.restore()}}},Scroller:class extends T{constructor(t){let i=h(t.text),s=Array.isArray(i)?i:[...i];super(Object.assign({},t,{class:_,count:s.length,text:t=>s[t],enabled:i=>" "!==s[i]&&h(t.enabled)}))}},StackBlur:class extends k{constructor(t){super(t),this.Ut=void 0}bt(){return Object.assign({},super.bt(),{onCanvas:!1,radius:void 0,radiusPart:void 0,radiusScale:!0})}normalizeFullScreen(t){const i=this.p;i.norm&&i.onCanvas?(i.x=0,i.y=0,i.width=t.widthInPixel,i.height=t.heightInPixel):super.normalizeFullScreen(t)}resize(t,i){super.resize(t,i),this.p.radiusPart&&(this.p.radius=void 0)}additionalBlur(t,i,h){const e=this.Ft.getImageData(0,0,t,i);s(e,0,0,t,i,h.radius||1),this.Ft.putImageData(e,0,0)}draw(t,i){const h=this.p;if(h.enabled){void 0!==h.radius&&this.Ut===h.radiusPart||(h.radius=Math.round((i.widthInPixel+i.heightInPixel)/2/h.radiusPart),this.Ut=h.radiusPart);const e=Math.round(h.radius*(h.radiusScale&&i.cam?i.cam.zoom:1)/i.scaleCanvas);if(e)if(h.onCanvas){void 0!==h.width&&void 0!==h.height||this.normalizeFullScreen(i);const r=Math.round(h.x),n=Math.round(h.y),o=Math.round(h.width),a=Math.round(h.height),c=t.getImageData(r,n,o,a);s(c,0,0,o-r,a-n,e),t.putImageData(c,r,n,0,0,o,a)}else i.radius=e,super.draw(t,i)}else super.draw(t,i)}},StarField:class extends C{constructor(t){super(t),this.Rt=[],this.Ht=[],this.qt=[],this.Gt=[],this.Vt=[],this.Kt=[],this.Zt=[],this.Jt=[],this.Qt=[],this.$t=0,this.ti=0,this.ii=0}bt(){return Object.assign({},super.bt(),{count:40,moveX:0,moveY:0,moveZ:0,lineWidth:void 0,highScale:!0,color:"#FFF"})}init(t,i){const s=this.p;function h(t,i,s){return void 0===s&&(s=-i),void 0===t||t<i||t>=s?Math.random()*(s-i)+i:t}s.width=s.width||i.width,s.height=s.height||i.height,s.x=void 0===s.x?i.x:s.x,s.y=void 0===s.y?i.y:s.y,s.lineWidth=s.lineWidth||Math.min(i.height/i.heightInPixel,i.width/i.widthInPixel)/2,this.$t=s.width/2+s.x,this.ti=s.height/2+s.y,this.ii=Math.max(s.width,s.height)/2;for(let t=0;t<s.count;t++)this.Rt[t]=h(this.Rt[t],-s.width/2),this.Ht[t]=h(this.Ht[t],-s.height/2),this.qt[t]=h(this.qt[t],0,this.ii)}si(t,i,s){const h=this.p,e=h.width/2,r=h.height/2;s&&(this.Jt[t]=!0);let n=this.Rt[t]+h.moveX*i,o=this.Ht[t]+h.moveY*i,a=this.qt[t]+h.moveZ*i;for(;n<-e;)n+=h.width,o=Math.random()*h.height-r,this.Jt[t]=!1;for(;n>e;)n-=h.width,o=Math.random()*h.height-r,this.Jt[t]=!1;for(;o<-r;)o+=h.height,n=Math.random()*h.width-e,this.Jt[t]=!1;for(;o>r;)o-=h.height,n=Math.random()*h.width-e,this.Jt[t]=!1;for(;a<=0;)a+=this.ii,n=Math.random()*h.width-e,o=Math.random()*h.height-r,this.Jt[t]=!1;for(;a>this.ii;)a-=this.ii,n=Math.random()*h.width-e,o=Math.random()*h.height-r,this.Jt[t]=!1;const c=this.$t+n/a*e,u=this.ti+o/a*r;if(this.Jt[t]=this.Jt[t]&&c>=h.x&&u>=h.y&&c<h.x+h.width&&u<h.y+h.height,s)this.Rt[t]=n,this.Ht[t]=o,this.qt[t]=a,this.Kt[t]=c,this.Zt[t]=u;else{this.Gt[t]=c,this.Vt[t]=u;let i=4*(1-this.qt[t]/this.ii);h.highScale||(i=Math.ceil(i)),this.Qt[t]=i}}animate(t){let i=super.animate(t);if(this.p.enabled&&void 0!==this.$t){let i=this.p.count;for(;i--;)this.si(i,t/16,!0),this.Jt[i]&&this.si(i,-5,!1)}return i}resize(t,i){this.wt=!0}detect(t,i,s){return this.Ct(this.p,t,i,s,!1)}draw(t,i){if(this.p.enabled){const s=this.p;if(t.globalCompositeOperation=s.compositeOperation,t.globalAlpha=s.alpha*i.alpha,0==s.moveY&&0==s.moveZ&&s.moveX<0){t.fillStyle=s.color;let i=s.count;for(;i--;)this.Jt[i]&&t.fillRect(this.Kt[i],this.Zt[i]-this.Qt[i]*s.lineWidth/2,this.Gt[i]-this.Kt[i],this.Qt[i]*s.lineWidth)}else if(t.strokeStyle=s.color,s.highScale){let i=s.count;for(;i--;)this.Jt[i]&&(t.beginPath(),t.lineWidth=this.Qt[i]*s.lineWidth,t.moveTo(this.Gt[i],this.Vt[i]),t.lineTo(this.Kt[i],this.Zt[i]),t.stroke(),t.closePath())}else{let i,h=5;for(;--h;){for(t.beginPath(),t.lineWidth=h*s.lineWidth,i=s.count;i--;)this.Jt[i]&&this.Qt[i]===h&&(t.moveTo(this.Gt[i],this.Vt[i]),t.lineTo(this.Kt[i],this.Zt[i]));t.stroke(),t.closePath()}}}}}};const A=Math.PI/180;function z(t,i){return i.from+t*i.delta}function D(t,i){return t>=.5?i.to:i.from}function L(t,i){for(var s,h=[...i.values],e=h.length;e>1;)for(e--,s=0;s<e;s++)h[s]=h[s]+t*(h[s+1]-h[s]);return h[0]}function N(t,i){return i.colorFrom.mix(i.colorTo,100*t).toString()}function B(t,i,s){let{pathFrom:h,pathTo:e}=i;return s.changeToPath(t,{pathFrom:h,pathTo:e})}var W={Callback:class{constructor(t,i){this.hi=void 0,this.yt=void 0,this.ei=!1,this.hi=t,this.yt=v(h(i),void 0)}reset(){this.ei=!1}run(t,i){let s;return void 0!==this.yt?(this.hi(t,Math.min(i,this.yt),!this.ei),this.ei=!0,i-this.yt):(s=this.hi(t,i,!this.ei),this.ei=!0,s)}},ChangeTo:class{constructor(t,i,s){this.ei=!1,this.ri=void 0,this.yt=void 0,this.ni=void 0,this.ri=[];for(let i in t){const s=t[i],e="rotationInDegree"===i?s*A:s,r="color"===i||"borderColor"===i,n="path"===i,o="text"===i,a="function"==typeof e,c=!r&&Array.isArray(e),u="scale"===i?["scaleX","scaleY"]:"rotationInRadian"===i||"rotationInDegree"===i?["rotation"]:[i];for(const t of u)this.ri.push({name:t,to:c?e[e.length-1]:h(e),bezier:c?e:void 0,isColor:r,isPath:n,isStatic:o,isFunction:a?e:void 0,moveAlgorithm:r?N:n?B:c?L:o?D:z})}this.yt=v(h(i),0),this.ni=v(s,t=>t)}reset(){this.ei=!1}oi(i,s){let h=this.ri.length;for(;h--;){const s=this.ri[h],e=i.p[s.name];s.isFunction?(s.from=e,s.to=s.isFunction(s.from),s.isColor?(s.colorFrom=new t(s.from),s.colorTo=new t(s.to),s.moveAlgorithm=N):s.isPath?([s.pathFrom,s.pathTo]=i.changeToPathInit(s.from,s.to),s.moveAlgorithm=B):Array.isArray(s.to)?(s.values=[e,...s.to],s.moveAlgorithm=L):s.isStatic||(s.delta=s.to-s.from,s.moveAlgorithm=z)):s.isColor?(s.colorFrom=new t(e),s.colorTo=new t(s.to)):s.isPath?[s.pathFrom,s.pathTo]=i.changeToPathInit(e,s.to):s.bezier?s.values=[e,...s.bezier]:(s.from=e,s.delta=s.to-s.from)}}run(t,i){if(this.ei||(this.ei=!0,this.oi(t,i)),this.yt<=i){let i,s=this.ri.length;for(;s--;)i=this.ri[s],t.p[i.name]=i.to}else{let s,h=this.ri.length;const e=this.ni(i/this.yt);for(;h--;)s=this.ri[h],t.p[s.name]=s.moveAlgorithm(e,s,t)}return i-this.yt}},End:class{constructor(){}run(t,i){return x.FORCE_DISABLE}},EndDisabled:class{constructor(){}run(t,i){return t.p.enabled=!1,x.FORCE_DISABLE}},Forever:class{constructor(){this.ai=void 0;var t=[].slice.call(arguments);this.ai=t[0]instanceof P?t[0]:new P(...t)}reset(t){var i,s;void 0===t&&(t=0),null==(i=(s=this.ai).reset)||i.call(s,t)}play(t,i){var s,h;return void 0===t&&(t=""),void 0===i&&(i=0),null==(s=(h=this.ai).play)?void 0:s.call(h,t,i)}run(t,i,s){let h=i;for(;h>=0;){if(h=this.ai.run(t,h,s),s=!0,!0===h)return!0;var e,r;h>=0&&(null==(e=(r=this.ai).reset)||e.call(r))}return h}},If:class{constructor(t,i,s){this.ci=void 0,this.ai=void 0,this.ui=void 0,this.ci=t,this.ai=i,this.ui=v(s,()=>0)}play(t,i){var s,h,e,r;return void 0===t&&(t=""),void 0===i&&(i=0),(null==(s=(h=this.ai).play)?void 0:s.call(h,t,i))||(null==(e=(r=this.ui).play)?void 0:e.call(r,t,i))}run(t,i){const s=h(this.ci)?this.ai:this.ui;return s.run?s.run(t,i):s(t,i)}},Image:class{constructor(t,i){this.ei=!1,this.li=void 0,this.di=void 0,this.vi=void 0,this.yt=void 0,this.fi=-1;const s=h(t);this.vi=v(h(i),0),Array.isArray(s)?(this.li=s,this.di=s.length):(this.li=[s],this.di=1),this.yt=this.di*this.vi}reset(){this.ei=!1}run(t,i){if(this.ei||(this.ei=!0,this.fi=-1),i>=this.yt)t.p.image=c.getImage(this.li[this.li.length-1]);else{let s=Math.floor(i/this.vi);s!==this.fi&&(this.fi=s,t.p.image=c.getImage(this.li[this.fi]))}return i-this.yt}},ImageFrame:class{constructor(t,i,s){this.mi=void 0,this.vi=void 0,this.yt=void 0,this.pi=void 0;const e=h(t);this.pi=v(h(i),!0),this.vi=v(h(s),0),this.mi=Array.isArray(e)?e:[e],this.yt=this.mi.length*this.vi}run(t,i){let s=0;return s=i>=this.yt?this.mi[this.mi.length-1]:this.mi[Math.floor(i/this.vi)],this.pi?t.p.frameX=t.p.frameWidth*s:t.p.frameY=t.p.frameHeight*s,i-this.yt}},Loop:class{constructor(t){this.ai=void 0,this.yi=void 0,this.gi=void 0;var i=[].slice.call(arguments,1);this.ai=i[0]instanceof P?i[0]:new P(...i),this.yi=this.gi=v(h(t),1)}reset(t){var i,s;void 0===t&&(t=0),this.yi=this.gi,null==(i=(s=this.ai).reset)||i.call(s,t)}play(t,i){var s,h;void 0===t&&(t=""),void 0===i&&(i=0),this.yi=this.gi;const e=null==(s=(h=this.ai).play)?void 0:s.call(h,t,i);return e&&(this.yi=this.gi),e}run(t,i,s){let h=i;for(;h>=0&&this.yi>0;){if(h=this.ai.run(t,h,s),s=!0,!0===h)return!0;var e,r;h>=0&&(this.yi--,null==(e=(r=this.ai).reset)||e.call(r))}return h}},Once:class{constructor(t,i){this.ai=void 0,this.yi=void 0,this.ai=t,this.yi=v(h(i),1)}run(t,i){if(this.yi<=0)return i;{let s=this.ai.run(t,i);return s>=0&&this.yi--,s}}},Remove:class{constructor(){}run(t,i){return x.REMOVE}},Sequence:P,Shake:class{constructor(t,i){this.ei=!1,this.yt=void 0,this.wi=void 0,this.Mi=void 0,this.bi=0,this.xi=0,this.yt=h(i),this.wi=h(t),this.Mi=this.wi/2}reset(){this.ei=!1}run(t,i){return this.ei||(this.ei=!0,this.bi=t.p.x,this.xi=t.p.y),i>=this.yt?(t.p.x=this.bi,t.p.y=this.xi):(t.p.x=this.bi+Math.random()*this.wi-this.Mi,t.p.y=this.xi+Math.random()*this.wi-this.Mi),i-this.yt}},ShowOnce:class{constructor(){this.Pi=!0}run(t,i){return t.p.enabled=t.p.enabled&&this.Pi,this.Pi=!1,0}},State:class{constructor(t){let{states:i={},transitions:s={},defaultState:h}=t;this.Ci=void 0,this.Ii=void 0,this.Oi=void 0,this.Fi=void 0,this.Ti=void 0,this.Ci=Object.fromEntries(Object.entries(i).map(t=>{let[i,s]=t;return[i,Array.isArray(s)?new P(s):s]})),this.Ii=Object.fromEntries(Object.entries(s).map(t=>{let[i,s]=t;return[i,Array.isArray(s)?new P(s):s]})),this.Oi=h,this.Fi=this.Ci[h]}setState(t){if(t!==this.Oi){this.Ti=t;const h=""+t.charAt(0).toUpperCase()+t.slice(1),e=[this.Oi+"To"+h,this.Oi+"To","to"+h].find(t=>t in this.Ii);var i,s;e?(this.Oi=this.Ti,this.Fi=this.Ii[e],null==(i=this.Fi)||null==i.reset||i.reset()):(this.Oi=this.Ti,this.Fi=this.Ci[this.Oi],null==(s=this.Fi)||null==s.reset||s.reset(),this.Ti=void 0)}}play(t,i){var s;return void 0===t&&(t=""),void 0===i&&(i=0),null==(s=this.Fi)||null==s.play?void 0:s.play(t,i)}run(t,i,s){let h=i,e=s;if(this.Fi){if(h=this.Fi.run(t,h,e),!0===h)return!0;e=!0}var r;if(h>=0||!this.Fi)if(this.Ti){if(this.Oi=this.Ti,this.Fi=this.Ci[this.Oi],null==(r=this.Fi)||null==r.reset||r.reset(),this.Ti=void 0,h=this.Fi.run(t,h,e),!0===h)return!0}else this.Fi=void 0;return-1}},Stop:class{constructor(){}run(t,i){return x.STOP}},StopDisabled:class{constructor(){}run(t,i){return t.p.enabled=!1,x.STOP}},Wait:b,WaitDisabled:class{constructor(t){this.duration=void 0,this.duration=v(h(t),0)}run(t,i){return t.p.enabled=i>=this.duration,i-this.duration}}};class X{constructor(t){void 0===t&&(t={}),this.type="camera",this.cam=void 0,this.type="camera",this.cam=Object.assign({zoom:1,x:0,y:0},t)}viewport(t,i){return i.scale(this.cam.zoom,this.cam.zoom).translate(-this.cam.x,-this.cam.y)}viewportByCam(t,i){let{engine:s}=t;const h=s.getWidth()/2,e=s.getHeight()/2,r=s.getRatio()>1?h:e;return(new d).translate(h,e).scale(r,r).scale(i.zoom,i.zoom).translate(-i.x,-i.y)}additionalModifier(t,i){return i.cam=Object.assign({},this.cam),i}clampView(t,i){const{engine:s,scene:h,clampLimits:e}=t,r=e||{x1:h.additionalModifier.x,y1:h.additionalModifier.y,x2:h.additionalModifier.x+h.additionalModifier.width,y2:h.additionalModifier.y+h.additionalModifier.height},n=this.viewportByCam(t,i).invert(),[o,a]=n.transformPoint(0,0),[c,u]=n.transformPoint(s.getWidth(),s.getHeight());return c-o<=r.x2-r.x1?o<r.x1?c<=r.x2&&(i.x+=r.x1-o):c>r.x2&&(i.x+=r.x2-c):o>r.x1?i.x+=r.x1-o:c<r.x2&&(i.x+=r.x2-c),u-a<=r.y2-r.y1?a<r.y1?u<=r.y2&&(i.y+=r.y1-a):u>r.y2&&(i.y+=r.y2-u):a>r.y1?i.y+=r.y1-a:u<r.y2&&(i.y+=r.y2-u),i}set zoom(t){this.cam.zoom=t}set camX(t){this.cam.x=t}set camY(t){this.cam.y=t}get zoom(){return this.cam.zoom}get camX(){return this.cam.x}get camY(){return this.cam.y}zoomToFullScreen(t){let{scene:i}=t;return Math.min(i.additionalModifier.fullScreen.width/i.additionalModifier.width,i.additionalModifier.fullScreen.height/i.additionalModifier.height)}zoomTo(t){const{scene:i,engine:s,cam:h,x1:e,y1:r,x2:n,y2:o}=t,a=i.additionalModifier.scaleCanvas,c=this.viewportByCam(t,h||this.cam).invert(),[u,l]=c.transformPoint(0,0),[d,v]=c.transformPoint(s.getWidth()*a,s.getHeight()*a),f=n-e,m=o-r,p={x:e+f/2,y:r+m/2,zoom:(h||this.cam).zoom*Math.max(Math.min((d-u)/f,(v-l)/m),Number.MIN_VALUE)};h?(h.x=p.x,h.y=p.y,h.zoom=p.zoom):this.cam=p}}class Y{constructor(t){void 0===t&&(t={}),this.type="control",this.ki={},this.toCam={zoom:1,x:0,y:0},this.Si=void 0,this.h=void 0,this._i=!1,this.Si=Object.assign({zoomMax:10,zoomMin:.5,zoomFactor:1.2,tween:2,callResize:!0},t)}init(t){let{scene:i}=t;this.h=i,this.toCam=Object.assign({},i.camera.cam)}mouseDown(t){var i;let{event:s,position:[h,e],button:r}=t;this.ki[r]=Object.assign({},this.ki[r],{x:h,y:e,ji:this.toCam.x,Ei:this.toCam.y,Ai:!0,zi:(null==(i=s.touches)?void 0:i.length)||1,Di:void 0,Li:Date.now()})}mouseUp(t){var i;let{event:s,position:[h,e],button:r,scene:n}=t;this.ki[r]||delete this.ki[r];const o=this.ki[r].Ai,a=(null==(i=s.changedTouches)?void 0:i.length)||1,c=Math.max(this.ki[r].zi,a);this.ki[r].Ai=!1,this.ki[r].zi-=a,!o||c>1?n.stopPropagation():Date.now()-this.ki[r].Li<300&&Math.abs(this.ki[r].x-h)<5&&Math.abs(this.ki[r].y-e)<5&&1===r||n.stopPropagation()}mouseOut(t){let{button:i}=t;this.ki[i]&&(this.ki[i].Ai=!1)}mouseMove(t){var i;let{event:s,position:[h,e],button:r,scene:n}=t;if(!this.ki[r]||!this.ki[r].Ai||0===s.which&&!s.touches)return;const o=n.additionalModifier.scaleCanvas;if((null==(i=s.touches)?void 0:i.length)>=2){const t=s.touches,i=Math.sqrt((t[0].pageX-t[1].pageX)*(t[0].pageX-t[1].pageX)+(t[0].pageY-t[1].pageY)*(t[0].pageY-t[1].pageY));void 0===this.ki[r].Di?i>0&&(this.ki[r].Di=i,this.ki[r].Ni=this.toCam.zoom):(this.toCam.zoom=Math.max(this.Si.zoomMin,Math.min(this.Si.zoomMax,this.ki[r].Ni*i/this.ki[r].Di)),this.toCam=n.camera.clampView(arguments[0],this.toCam))}else{this.ki[r].Di=void 0;const t=n.camera.viewportByCam(arguments[0],this.toCam).invert(),[i,s]=t.transformPoint(this.ki[r].x*o,this.ki[r].y*o),[a,c]=t.transformPoint(h*o,e*o);this.toCam.x=this.ki[r].ji+i-a,this.toCam.y=this.ki[r].Ei+s-c,this.toCam=n.camera.clampView(arguments[0],this.toCam)}}mouseWheel(t){let{event:i,position:[s,h],scene:e}=t;const r=e.additionalModifier.scaleCanvas,[n,o]=e.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(s*r,h*r);if((i.wheelDelta||-1*i.deltaY)/120>0){this.zoomIn();const[t,i]=e.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(s*r,h*r);this.toCam.x-=t-n,this.toCam.y-=i-o,this.toCam=e.camera.clampView(arguments[0],this.toCam)}else this.zoomOut(arguments[0])}hasCamChanged(){const t=this.Si.tween||1;return Math.abs(this.toCam.x-this.h.camera.cam.x)>=Number.EPSILON*t||Math.abs(this.toCam.y-this.h.camera.cam.y)>=Number.EPSILON*t||Math.abs(this.toCam.zoom-this.h.camera.cam.zoom)>=Number.EPSILON*t}fixedUpdate(t){let{scene:i,lastCall:s}=t;this.Si.tween&&!this._i&&this.hasCamChanged()&&(i.camera.cam.x+=(this.toCam.x-i.camera.cam.x)/this.Si.tween,i.camera.cam.y+=(this.toCam.y-i.camera.cam.y)/this.Si.tween,i.camera.cam.zoom+=(this.toCam.zoom-i.camera.cam.zoom)/this.Si.tween,s&&(i.additionalModifier.cam=i.camera.cam,this.Si.callResize?i.resize():i.cacheClear()))}update(t){let{scene:i}=t;this.Si.tween&&!this._i||!this.hasCamChanged()||(this._i=!1,i.camera.cam=Object.assign({},this.toCam),this.Si.callResize?i.resize():i.cacheClear())}camInstant(){this._i=!0}resize(t){this.toCam=t.scene.camera.clampView(t,this.toCam)}zoomToNorm(){return this.toCam.zoom=1,this}zoomIn(){return this.toCam.zoom=Math.min(this.Si.zoomMax,this.toCam.zoom*this.Si.zoomFactor),this}zoomOut(t){return this.toCam.zoom=Math.max(this.Si.zoomMin,this.toCam.zoom/this.Si.zoomFactor),this.toCam=t.scene.camera.clampView(t,this.toCam),this}zoomTo(t){t.scene.camera.zoomTo(Object.assign(t,{cam:this.toCam}))}}var U={Callback:X,Camera:X,CameraControl:Y,CameraControlSecondButton:class extends Y{mouseUp(t){var i;let{event:s,position:[h,e],button:r,scene:n}=t;this.ki[r]||delete this.ki[r];const o=this.ki[r].Ai,a=(null==(i=s.changedTouches)?void 0:i.length)||1,c=Math.max(this.ki[r].zi,a);if(this.ki[r].Ai=!1,this.ki[r].zi-=a,!o||c>1)n.stopPropagation();else if((Date.now()-this.ki[r].Li>300||Math.abs(this.ki[r].x-h)>=5||Math.abs(this.ki[r].y-e)>=5)&&1===r){n.stopPropagation();const[t,i]=n.transformPoint(h,e),[o,a]=n.transformPoint(this.ki[r].x,this.ki[r].y);n.map("region",{event:s,x1:Math.min(o,t),y1:Math.min(a,i),x2:Math.max(o,t),y2:Math.max(a,i),fromX:o,fromY:a,toX:t,toY:i})}}mouseMove(t){var i;let{event:s,position:[h,e],button:r,scene:n}=t;if(!this.ki[r]||!this.ki[r].Ai||0===s.which&&!s.touches)return;const o=n.additionalModifier.scaleCanvas;if((null==(i=s.touches)?void 0:i.length)>=2){const t=s.touches,i=Math.sqrt((t[0].pageX-t[1].pageX)*(t[0].pageX-t[1].pageX)+(t[0].pageY-t[1].pageY)*(t[0].pageY-t[1].pageY));if(void 0===this.ki[r].Di)i>0&&(this.ki[r].Di=i,this.ki[r].Ni=this.toCam.zoom);else{this.toCam.zoom=Math.max(this.Si.zoomMin,Math.min(this.Si.zoomMax,this.ki[r].Ni*i/this.ki[r].Di));const t=n.camera.viewportByCam(arguments[0],this.toCam).invert(),[s,a]=t.transformPoint(this.ki[r].x*o,this.ki[r].y*o),[c,u]=t.transformPoint(h*o,e*o);this.toCam.x=this.ki[r].ji+s-c,this.toCam.y=this.ki[r].Ei+a-u,this.toCam=n.camera.clampView(arguments[0],this.toCam)}}else{if(this.ki[r].Di=void 0,2===r){const t=n.camera.viewportByCam(arguments[0],this.toCam).invert(),[i,s]=t.transformPoint(this.ki[r].x*o,this.ki[r].y*o),[a,c]=t.transformPoint(h*o,e*o);this.toCam.x=this.ki[r].ji+i-a,this.toCam.y=this.ki[r].Ei+s-c,this.toCam=n.camera.clampView(arguments[0],this.toCam)}if(1===r&&n.has("regionMove")&&!(Date.now()-this.ki[r].Li<300&&Math.abs(this.ki[r].x-h)<5&&Math.abs(this.ki[r].y-e)<5)&&(!s.touches||1===s.touches.length)){const[t,i]=n.transformPoint(h,e),[o,a]=n.transformPoint(this.ki[r].x,this.ki[r].y);n.map("regionMove",{event:s,x1:Math.min(o,t),y1:Math.min(a,i),x2:Math.max(o,t),y2:Math.max(a,i),fromX:o,fromY:a,toX:t,toY:i})}}}},Click:class{constructor(t){let{doubleClickDetectInterval:i=350}=void 0===t?{}:t;this.Bi=void 0,this.Wi=void 0,this.Wi=i}mouseUp(t){const{scene:i,button:s}=t;1===s&&(i.has("doubleClick")?this.Bi?(clearTimeout(this.Bi),this.Bi=0,i.map("doubleClick",t)):this.Bi=window.setTimeout(()=>{this.Bi=0,i.map("click",t)},this.Wi):i.map("click",t))}},Element:class{constructor(t){let{doubleClickDetectInterval:i=350}=void 0===t?{}:t;this.Xi=void 0,this.Yi=void 0,this.Ui=!1,this.Bi=void 0,this.Wi=void 0,this.Wi=i}isDrawFrame(){return this.Ui?1:0}Ri(t,i,s){i?t.has("doubleClickElement")?this.Bi?(window.clearTimeout(this.Bi),this.Bi=0,t.map("doubleClickElement",s)):this.Bi=window.setTimeout(()=>{this.Bi=0,t.map("clickElement",s)},this.Wi):t.map("clickElement",s):t.map("hoverElement",s)}Hi(t,i,s){i?t.has("doubleClickNonElement")?this.Bi?(clearTimeout(this.Bi),this.Bi=void 0,t.map("doubleClickNonElement",s)):this.Bi=window.setTimeout(()=>{this.Bi=void 0,t.map("clickNonElement",s)},this.Wi):t.map("clickNonElement",s):t.map("hoverNonElement",s)}initSprites(t){const{scene:i,output:s,layerManager:h,canvasId:e}=t;if(this.Ui=!1,this.Xi||this.Yi){const r=!!this.Xi,{mx:n,my:o}=this.Xi||this.Yi,a=i.additionalModifier.scaleCanvas,c=s.context[e||0],u=Math.round(n/a),l=Math.round(o/a),[d,v]=i.transformPoint(n,o);let f;if(c.save(),c.setTransform(...i.viewport().m),h.forEach(t=>{let{layerId:i,element:s,isFunction:h,elementId:e}=t;if(!h){const t=s.detect(c,u,l);if("c"===t)f="c";else if(t)return f={layerId:i,element:t,elementId:e},!1}}),c.restore(),"c"===f)this.Ui=!0;else{this.Xi=void 0,this.Yi=void 0;const s=Object.assign({mx:n,my:o,x:d,y:v},t);f?(Object.assign(s,f),this.Ri(i,r,s)):this.Hi(i,r,s)}}}draw(t){const{engine:i,scene:s,layerManager:h,output:e,canvasId:r}=t;if(!r&&this.Ui){const r=!!this.Xi,{mx:n,my:o}=this.Xi||this.Yi,a=s.additionalModifier.scaleCanvas,c=e.context[0],u=Math.round(n/a),l=Math.round(o/a),[d,v]=s.transformPoint(n,o),f=Object.assign({mx:n,my:o,x:d,y:v},t),m=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!1,c.clearRect(0,0,c.canvas.width,c.canvas.height),c.save(),c.setTransform(...s.viewport().m),h.forEach(t=>{let{layerId:i,element:s,isFunction:h,elementId:e}=t;h||s.detectDraw(c,"rgb("+(255&e)+", "+((65280&e)>>8)+", "+(255&i)+")")},0),c.restore(),c.imageSmoothingEnabled=m,i.normContext(c),this.Xi=void 0,this.Yi=void 0;const p=c.getImageData(u,l,1,1).data;p[3]?(Object.assign(f,{layerId:p[2],elementId:p[0]+(p[1]<<8),element:h.getById(f.layerId).getById(f.elementId)}),this.Ri(s,r,f)):this.Hi(s,r,f)}}mouseUp(t){let{scene:i,position:[s,h],button:e}=t;this.Xi=1===e&&i.has("clickElement")?{mx:s,my:h}:void 0}mouseMove(t){let{scene:i,position:[s,h]}=t;this.Yi=i.has("hoverElement")?{mx:s,my:h}:void 0}},Event:class{constructor(){this.type="events",this.qi=!1,this.i=[]}Gi(t,i,s){if(v(s.value("preventDefault"),!0)&&i.preventDefault(),!this.qi)return;const[h,e]=this.getMousePosition({event:i}),[r,n]=s.transformPoint(h,e);s.pipeBack(t,{event:i,position:[h,e],x:r,y:n,button:this.getMouseButton({event:i})})}events(t){let{scene:i}=t;return[i.has("mouseDown")&&[["touchstart","mousedown"],t=>this.Gi("mouseDown",t,i)],i.has("mouseUp")&&[["touchend","mouseup"],t=>this.Gi("mouseUp",t,i)],i.has("mouseOut")&&[["touchendoutside","mouseout"],t=>this.Gi("mouseOut",t,i)],i.has("mouseMove")&&[["touchmove","mousemove"],t=>this.Gi("mouseMove",t,i)],i.has("mouseWheel")&&[["wheel"],t=>this.Gi("mouseWheel",t,i)],v(i.value("preventDefault"),!0)&&[["contextmenu"],t=>t.preventDefault()]].filter(t=>t)}init(t){let{output:i,scene:s}=t;const h=i.canvas[0],e=s.map("events",{});this.i=e.filter(Array.isArray).reduce((t,i)=>(t.push.apply(t,i),t),[]).map(t=>Array.isArray(t)?t:[[t],i=>{v(s.value("preventDefault"),!0)&&i.preventDefault(),s.pipeBack(t,{event:i})}]).map(t=>{let[i,s]=t;return i.map(t=>({n:h,e:t,f:s}))}).reduce((t,i)=>(Array.isArray(i)?t.push.apply(t,i):t.push(i),t),[]),this.i.forEach(t=>{t.n.addEventListener(t.e,t.f,!0)})}destroy(){this.i.forEach(t=>{t.n.removeEventListener(t.e,t.f,!0)}),this.i=[]}reset(t,i){return i}getMousePosition(t){let i,{event:s}=t;if(s.touches&&s.touches.length>0?i=s.targetTouches:s.changedTouches&&s.changedTouches.length>0&&(i=s.changedTouches),i){const t=s.target.getBoundingClientRect(),h=i.length;return i=Array.from(i),[i.reduce((t,i)=>t+i.pageX,0)/h-t.left,i.reduce((t,i)=>t+i.pageY,0)/h-t.top]}if(void 0===s.offsetX){const t=s.target.getBoundingClientRect();return[s.clientX-t.left,s.clientY-t.top]}return[s.offsetX,s.offsetY]}getMouseButton(t){let{event:i}=t;return i.touches?i.touches.length||i.changedTouches.length:v(i.buttons?i.buttons:[0,1,4,2][i.which],1)}},LoadingScreen:class{loading(t){let{output:i,progress:s}=t;const h=i.context[0],e="number"==typeof s,r=e?Math.max(1,s*i.height):i.height;h.globalCompositeOperation="source-over",h.globalAlpha=1,h.clearRect(0,0,i.width,i.height),h.fillStyle="_aaa",h.fillRect(0,i.height/2-r/2,i.width,r),h.font="20px Georgia",h.fillStyle="#fff",h.textAlign="left",h.textBaseline="bottom",h.fillText(e?"Loading "+Math.round(100*s)+"%":s,10+3*Math.random(),i.height-10+3*Math.random())}},Norm:class{viewport(t,i){let{engine:s}=t;const h=s.getWidth()/2,e=s.getHeight()/2,r=s.getRatio()>1?h:e;return i.translate(h,e).scale(r,r)}additionalModifier(t){let{engine:i,output:s,scene:h}=t;h.cacheClear();const[e,r]=h.transformPoint(0,0,1),[n,o]=h.transformPoint(s.width,s.height,1),a=i.getWidth()/2,c=i.getHeight()/2,u=i.getRatio()>1?a:c,l=(new d).translate(a,c).scale(u,u).invert(),[v,f]=l.transformPoint(0,0),[m,p]=l.transformPoint(s.width,s.height);return{alpha:1,x:-1,y:-1,width:2,height:2,widthInPixel:s.width,heightInPixel:s.height,scaleCanvas:s.width/s.canvas[0].clientWidth,visibleScreen:{x:e,y:r,width:n-e,height:o-r},fullScreen:{x:v,y:f,width:m-v,height:p-f}}}},TimingAudio:class extends f{constructor(t){super({...t,maxSkippedTickChunk:Number.POSITIVE_INFINITY}),this.J=Number.POSITIVE_INFINITY,this.Vi=void 0,this.Ki=void 0,this.Zi=!1,this.Ji=void 0,this.Ji=t.audioElement}get audioElement(){return this.Ji}init(t){if(this.Ji)return"function"==typeof MediaController&&(this.Ji.controller=new MediaController,this.Zi=!0),this.Ji.preload="auto",new Promise((t,i)=>{const s=()=>{this.Ji.removeEventListener("canplaythrough",s);const i=this.Ji.play();i&&i.catch(t=>{}),t(void 0)};this.Ji.addEventListener("canplaythrough",s),this.Ji.onerror=()=>{this.Ji=void 0,t(void 0)},this.Ji.load()})}endTime(){return this.Ji?1e3*this.Ji.duration:Number.POSITIVE_INFINITY}currentTime(){let t=super.currentTime();if(this.Ji){if(this.Ji.ended&&this.Ji.duration)return 1e3*this.Ji.duration;const i=1e3*this.Ji.currentTime;if(this.Zi){if(void 0===this.Vi)return this.Vi=t,this.Ki=i,i;if("playing"===this.Ji.controller.playbackState){if(i===this.Ki)return this.Ki+Math.min(260,t-this.Vi);if(i-this.Ki<500&&i>this.Ki&&t-this.Vi<350)return this.Vi=this.Vi+(i-this.Ki),this.Ki=i,this.Ki+t-this.Vi}return this.Vi=t,this.Ki=i,this.Ki}return i}return t}clampTime(t){let{timePassed:i}=t;return i}shiftTime(){return 0}},TimingDefault:f};export{W as Animations,a as Engine,c as ImageManager,U as Middleware,S as Position,M as Scene,E as Sprites};
//# sourceMappingURL=animationvideo.module.js.map
