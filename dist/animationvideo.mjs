import{TinyColor as t}from"@ctrl/tinycolor/dist/module/public_api.js";import i from"pasition";import{imageDataRGBA as s}from"stackblur-canvas/dist/stackblur-es.js";export{default as Easing}from"eases";function h(t,i=null){return"function"==typeof t?t.apply(i,[].slice.call(arguments,2)):t}function e(t){return null==t?[]:Array.isArray(t)?t:[t]}function r(t,i,s){if(!t.s){if(s instanceof n){if(!s.s)return void(s.o=r.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(r.bind(null,t,i),r.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const n=function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{r(h,1,t(this.v))}catch(t){r(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?r(h,1,i?i(e):e):s?r(h,1,s(e)):r(h,2,e)}catch(t){r(h,2,t)}},h},t}();function o(t){return t instanceof n&&1&t.s}class a{constructor(t){let i=t;if("object"!=typeof t)throw new Error("No canvas given for Engine constructor");if(t.getContext)i={canvas:t};else if(!t.canvas)throw new Error("No canvas given for Engine constructor");let s=Object.assign({},i);if(this.t={canvas:[],context:[],width:0,height:0,ratio:1},this.i=[],this.h=null,this.u=!1,this.l=0,this.p=!1,this.M=null,this.t.canvas=e(s.canvas),s.autoSize){const t={enabled:!0,scaleLimitMin:1,scaleLimitMax:2.5,scaleFactor:1.07,referenceWidth:()=>this.t.canvas[0].clientWidth,referenceHeight:()=>this.t.canvas[0].clientHeight,currentScale:1,waitTime:100,currentWaitedTime:0,currentOffsetTime:0,offsetTimeLimitUp:300,offsetTimeLimitDown:300,registerResizeEvents:!0,registerVisibilityEvents:!0,setCanvasStyle:!1};this.P="object"==typeof s.autoSize?Object.assign({},t,s.autoSize):t,this.P.registerResizeEvents&&(this.i=["resize","orientationchange"].map(t=>({n:window,e:t,f:this.recalculateCanvas.bind(this)}))),this.P.registerVisibilityEvents&&this.i.push({n:document,e:"visibilitychange",f:this.handleVisibilityChange.bind(this)}),this.C()}else this.t.width=this.t.canvas[0].width,this.t.height=this.t.canvas[0].height,this.t.ratio=this.t.width/this.t.height;this.t.canvas.forEach((t,i)=>{this.t.context[i]=t.getContext("2d")}),this.I=this.t.canvas.length,this.T=Array.from({length:this.I},t=>0),s.clickToPlayAudio&&this.i.push({n:this.t.canvas[0],e:"click",f:this.playAudioOfScene.bind(this)}),this.F=s.reduceFramerate,this.i.forEach(t=>{t.n.addEventListener(t.e,t.f)}),this.switchScene(s.scene,s.sceneParameter||{})}handleVisibilityChange(){this.P.enabled=!("hidden"==document.visibilityState)}playAudioOfScene(){this.u&&this.h&&this.h.timing.audioElement&&this.h.timing.audioElement.play()}normContext(t){t.textBaseline="middle",t.textAlign="center",t.globalAlpha=1,t.globalCompositeOperation="source-over"}getWidth(){return this.t.width}getHeight(){return this.t.height}getRatio(){return this.t.ratio}getOutput(){return this.t}recalculateCanvas(){return this.p=!0,this}C(){if(this.P){const t=h(this.P.referenceWidth),i=h(this.P.referenceHeight);if(t<=0||i<=0)return;this.t.canvas.forEach(s=>{s.width=Math.round(t/this.P.currentScale),s.height=Math.round(i/this.P.currentScale),this.P.setCanvasStyle&&(s.style.width=`${t}px`,s.style.height=`${i}px`)}),this.P.currentWaitedTime=0,this.P.currentOffsetTime=0}this.t.width=this.t.canvas[0].width,this.t.height=this.t.canvas[0].height,this.t.ratio=this.t.width/this.t.height,this.resize()}recalculateFPS(){try{const t=this;return t.M&&(window.cancelAnimationFrame(t.M),t.M=!1),Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){function i(){const i=(t.k()-s)/h;t.P.offsetTimeTarget=i,t.P.offsetTimeDelta=i/3,!1===t.M&&(t.O=!1,t.M=window.requestAnimationFrame(t.S.bind(t)))}const s=t.k(),h=3;let e=h;const a=function(t,i,s){for(var h;;){var e=t();if(o(e)&&(e=e.v),!e)return a;if(e.then){h=0;break}var a=s();if(a&&a.then){if(!o(a)){h=1;break}a=a.s}}var c=new n,u=r.bind(null,c,2);return(0===h?e.then(d):1===h?a.then(l):(void 0).then(function(){(e=t())?e.then?e.then(d).then(void 0,u):d(e):r(c,1,a)})).then(void 0,u),c;function l(i){a=i;do{if(!(e=t())||o(e)&&!e.v)return void r(c,1,a);if(e.then)return void e.then(d).then(void 0,u);o(a=s())&&(a=a.v)}while(!a||!a.then);a.then(l).then(void 0,u)}function d(t){t?(a=s())&&a.then?a.then(l).then(void 0,u):l(a):r(c,1,a)}}(function(){return e--},0,function(){return Promise.resolve(new Promise(t=>requestAnimationFrame(t))).then(function(){})});return a&&a.then?a.then(i):i()})}catch(t){return Promise.reject(t)}}resize(){return this.h&&this.h.resize&&this.h.resize(),this}switchScene(t,i){return t&&(this.j=t,this.A=i),this}k(){return window.performance?performance.now():Date.now()}S(t){if(!this.M)return;this.M=window.requestAnimationFrame(this.S.bind(this));let i=this.p&&(!this.F||!this._);i&&(this.C(),this.p=!1);for(let t=0;t<this.I;t++)this.T[t]=Math.max(this.T[t]-1,i?1:0);if(this.O||(this.O=t),this.D||(this.D=t),this.j&&!this.L&&(this.L=Promise.resolve(this.h?this.h.destroy():{}),this.L.then(i=>{this.j.callInit({run:this.N,scene:this.A,destroy:i},this),this.h=this.j,this.j=void 0,this.L=void 0,this.u=!1,this.l=this.h.currentTime(),this.D=t})),this.h&&(this.F&&(this._=!this._),!this.F||this._)){let i=this.h.currentTime(),s=this.h.clampTime(i-this.l);const h=this.h.shiftTime(s);if(s+=h,this.l=i+h,this.u){const i=0!==s||this.B;this.B=!1;const h=this.k();if(this.t.canvas[0].width)for(let t=0;t<this.I;t++)this.normContext(this.t.context[t]),this.h.initSprites(t);const e=this.h.isDrawFrame(s);if(Array.isArray(e))for(let t=0;t<this.I;t++)this.T[t]=Math.max(this.T[t],e[t],0);else for(let t=0;t<this.I;t++)this.T[t]=Math.max(this.T[t],e,0);if(i&&this.h.move(s),this.t.canvas[0].width)for(let t=0;t<this.I;t++)this.T[t]&&this.h.draw(t);if(this.P&&this.P.enabled){const s=t-this.O;if(this.P.currentWaitedTime<this.P.waitTime)this.P.currentWaitedTime+=s;else if(i){const t=this.P.offsetTimeTarget*(this.F?2:1),i=this.k()-h,e=(Math.abs(s-t)>Math.abs(i-t)?s:i)-t;Math.abs(e)<=this.P.offsetTimeDelta?this.P.currentOffsetTime=this.P.currentOffsetTime>=0?Math.max(0,this.P.currentOffsetTime-this.P.offsetTimeDelta):Math.min(0,this.P.currentOffsetTime+this.P.offsetTimeDelta):e<0&&this.P.currentScale>this.P.scaleLimitMin?(this.P.currentOffsetTime+=e,this.P.currentOffsetTime<=-this.P.offsetTimeLimitDown&&(this.P.currentScale=Math.max(this.P.scaleLimitMin,this.P.currentScale/this.P.scaleFactor),this.p=!0)):e>0&&this.P.currentScale<this.P.scaleLimitMax&&(this.P.currentOffsetTime+=e,this.P.currentOffsetTime>=this.P.offsetTimeLimitUp&&(this.P.currentScale=Math.min(this.P.scaleLimitMax,this.P.currentScale*this.P.scaleFactor),this.p=!0))}}}else{for(let t=0;t<this.I;t++)this.normContext(this.t.context[t]);this.u=this.h.callLoading({timePassed:t-this.O,totalTimePassed:t-this.D}),this.u&&(this.h.reset(),this.l=this.h.currentTime(),this.B=!0,this.P&&(this.P.currentWaitedTime=0))}}this.O=t}run(t){try{const i=this;return i.N=t||{},Promise.resolve(i.stop()).then(function(){function t(){return i.M=window.requestAnimationFrame(i.S.bind(i)),i}i.O=i.D=!1;const s=function(){if(i.P&&!i.P.offsetTimeTarget)return Promise.resolve(i.recalculateFPS()).then(function(){})}();return s&&s.then?s.then(t):t()})}catch(t){return Promise.reject(t)}}stop(){try{const t=this;return window.cancelAnimationFrame(t.M),t.M=null,Promise.resolve(t.h?Promise.resolve(t.h.destroy()).then(function(t){}):void 0)}catch(t){return Promise.reject(t)}}destroy(){try{const t=this;return Promise.resolve(t.stop()).then(function(){return t.i.forEach(t=>{t.n.removeEventListener(t.e,t.f)}),t.i=[],t})}catch(t){return Promise.reject(t)}}}class c{constructor(){this.Images={},this.count=0,this.loaded=0}static add(t,i){const s=this||c;for(const h in t)if(s.Images[h])i&&"function"==typeof i[h]&&i[h](h,s.Images[h]);else{if(s.Images[h]=new window.Image,s.Images[h].onload=function(){s.loaded++,i&&"function"==typeof i?s.isLoaded()&&i():i&&"function"==typeof i[h]&&i[h](h,s.Images[h]),s.resolve&&s.isLoaded()&&(s.resolve(),s.resolve=null)},"<svg"===t[h].substr(0,4)){const i=window.URL||window.webkitURL||window,e=new window.Blob([t[h]],{type:"image/svg+xml"});s.Images[h].src=i.createObjectURL(e)}else/^(https?:)?\/\//.test(t[h])&&(s.Images[h].onerror=()=>{const i=new window.Image;i.onload=s.Images[h].onload,s.Images[h]=i,s.Images[h].src=t[h]},s.Images[h].crossOrigin="anonymous"),s.Images[h].src=t[h];s.count++}return i&&"function"==typeof i&&s.isLoaded()&&i(),s.resolve&&s.isLoaded()&&(s.resolve(),s.resolve=null),s}static reset(){const t=this||c;return t.Images={},t.count=0,t.loaded=0,t}static getLoaded(){return(this||c).loaded}static getCount(){return(this||c).count}static isLoaded(){const t=this||c;return t.loaded===t.count}static getImage(t){return"object"==typeof t?t:(this||c).Images[t]}static isLoadedPromise(){const t=this||c;return!!t.isLoaded()||new Promise((i,s)=>{t.resolve=i})}}c.Images={},c.count=0,c.loaded=0;class u{constructor(t){this.W=[],this.$=[],this.U=0,this.X=0,this.Y=void 0===t?[]:Array.isArray(t)?t:[t]}addElement(t){return this.addElementForId(t),t}addElements(t){return this.addElementsForIds(t),t}addElementForId(t){let i=this.W.length,s=this.X;this.W[s]=t,this.$[s]="function"==typeof t,i===s&&i++;let h=this.X+1;for(;h!==i&&this.W[h];)h++;return this.X=h,this.U>s&&(this.U=s),s}addElementsForIds(t){let i=this.W.length;return i===this.X?(this.W=this.W.concat(t),this.X=this.W.length,t.forEach((t,s)=>{this.$[i+s]="function"==typeof t}),Array.from({length:t.length},(t,s)=>s+i)):t.map(t=>this.addElement(t))}getById(t){return this.W[t]}getIdByElement(t){return this.W.indexOf(t)}deleteByElement(t){const i=this.getIdByElement(t);i>=0&&this.deleteById(i)}deleteById(t){let i=this.W.length-1;if(i>0&&t===i){for(this.W[t]=null;i&&!this.W[i-1];)i--;this.W.length=i,this.$.length=i,this.X=Math.min(this.X,i),this.U=Math.min(this.U,i)}else this.W[t]&&(this.W[t]=null,this.X=Math.min(this.X,t),this.U===t&&(this.U=t+1))}isCanvasId(t){return void 0===t||!this.Y.length||this.Y.includes(t)}forEach(t,i=0){let s,h;const e=this.W.length;for(s=this.U;s<e;s++)if(h=this.W[s],h&&!1===t({elementId:s,layerId:i,element:h,isFunction:this.$[s],layer:this}))return}getElementsByTag(t){let i=[];return this.forEach(({element:s,isFunction:h})=>{if(!h){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}}),i}play(t="",i=0){this.forEach(({element:s,isFunction:h})=>!h&&s.play(t,i))}count(){let t=0;const i=this.W.length;for(let s=this.U;s<i;s++)this.W[s]&&t++;return t}clear(){this.W=[],this.$=[],this.U=0,this.X=0}}class l{constructor(){this.R=[]}addLayer(t){return this.R[this.R.length]=new u(t),this.R[this.R.length-1]}addLayers(t=1,i){let s=Array.from({length:t},t=>new u(i));return this.R=this.R.concat(s),s}addLayerForId(t){return this.R[this.R.length]=new u(t),this.R.length-1}addLayersForIds(t=1,i){const s=Array.from({length:t},(t,i)=>i+this.R.length);return this.R=this.R.concat(Array.from({length:t},t=>new u(i))),s}getById(t){return this.R[t]}forEach(t,i){let s;const h=this.R.length;for(s=0;s<h&&(!this.R[s].isCanvasId(i)||!1!==this.R[s].forEach(t,s));s++);}play(t="",i=0){this.forEach(({element:s,isFunction:h})=>!h&&s.play(t,i))}getElementsByTag(t){let i=[];return this.forEach(({element:s,isFunction:h})=>{if(!h){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}}),i}count(){return this.R.length}clear(){this.R=[]}}function d(){this.reset()}function f(t,i){return null==t||""===t?i:t}d.prototype.reset=function(){return this.m=[1,0,0,1,0,0],this},d.prototype.multiply=function(t){var i=this.m[1]*t.m[0]+this.m[3]*t.m[1],s=this.m[0]*t.m[2]+this.m[2]*t.m[3],h=this.m[1]*t.m[2]+this.m[3]*t.m[3],e=this.m[0]*t.m[4]+this.m[2]*t.m[5]+this.m[4],r=this.m[1]*t.m[4]+this.m[3]*t.m[5]+this.m[5];return this.m[0]=this.m[0]*t.m[0]+this.m[2]*t.m[1],this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this},d.prototype.invert=function(){var t=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),i=-this.m[1]*t,s=-this.m[2]*t,h=this.m[0]*t,e=t*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),r=t*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);return this.m[0]=this.m[3]*t,this.m[1]=i,this.m[2]=s,this.m[3]=h,this.m[4]=e,this.m[5]=r,this},d.prototype.rotate=function(t){var i=Math.cos(t),s=Math.sin(t),h=this.m[1]*i+this.m[3]*s,e=this.m[0]*-s+this.m[2]*i,r=this.m[1]*-s+this.m[3]*i;return this.m[0]=this.m[0]*i+this.m[2]*s,this.m[1]=h,this.m[2]=e,this.m[3]=r,this},d.prototype.translate=function(t,i){return this.m[4]+=this.m[0]*t+this.m[2]*i,this.m[5]+=this.m[1]*t+this.m[3]*i,this},d.prototype.scale=function(t,i){return this.m[0]*=t,this.m[1]*=t,this.m[2]*=i,this.m[3]*=i,this},d.prototype.transformPoint=function(t,i){var s=t;return[t=s*this.m[0]+i*this.m[2]+this.m[4],i=s*this.m[1]+i*this.m[3]+this.m[5]]},d.prototype.clone=function(){var t=new d;return t.m=this.m.slice(0),t};class m{constructor(t={}){this.type="timing",this.H=t,this.q=f(h(this.H.tickChunk),100/6),this.G=f(h(this.H.maxSkippedTickChunk),120),this.V=f(h(this.H.tickChunkTolerance),.1),this.totalTimePassed=0}init(){}currentTime(){return window.performance?performance.now():Date.now()}clampTime({timePassed:t}){const i=this.q?this.q*this.G:2e3;return t>i?i:t}shiftTime({timePassed:t}){return this.q?-t%this.q:0}get tickChunk(){return this.q}isChunked(){return this.q}hasOneChunkedFrame({timePassed:t}){return t>=this.q-this.V}calcFrames({timePassed:t}){return Math.min(this.G,Math.floor((t+this.V)/this.q))}}const v="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function p(t,i,s){if(!t.s){if(s instanceof y){if(!s.s)return void(s.o=p.bind(null,t,i));1&i&&(i=s.s),s=s.v}if(s&&s.then)return void s.then(p.bind(null,t,i),p.bind(null,t,2));t.s=i,t.v=s;const h=t.o;h&&h(t)}}const y=function(){function t(){}return t.prototype.then=function(i,s){const h=new t,e=this.s;if(e){const t=1&e?i:s;if(t){try{p(h,1,t(this.v))}catch(t){p(h,2,t)}return h}return this}return this.o=function(t){try{const e=t.v;1&t.s?p(h,1,i?i(e):e):s?p(h,1,s(e)):p(h,2,e)}catch(t){p(h,2,t)}},h},t}();function g(t){return t instanceof y&&1&t.s}class w{constructor(){this.K=new l,this.Z=0,this.J=c,this.middlewares=[].slice.call(arguments),this.middlewareByType("timing")||(this.middlewares=[m,...this.middlewares])}t(){return this.tt.getOutput()}set middlewares(t){this.it=e(t).map(t=>"function"==typeof t?new t:t).reduce((t,i)=>{for(let s of Object.keys(t))s in i&&t[s].push(i);return t.st.push(i),"enabled"in i||(i.enabled=!0),i.type&&(t[`t_${i.type}`]=i),t},{st:[],init:[],isDrawFrame:[],initSprites:[],fixedUpdate:[],update:[],draw:[],destroy:[],reset:[],resize:[],currentTime:[],clampTime:[],shiftTime:[],isChunked:[],hasOneChunkedFrame:[],calcFrames:[],tickChunk:[],additionalModifier:[]})}get middlewares(){return this.it.st}middlewareByType(t){const i=this.it.st.filter(i=>i.type==t);if(i.length)return i[i.length-1]}has(t){return t in this.it||this.it.st.filter(i=>t in i).length>0}do(t,i,s,h){let e=this.it[t]||this.it.st.filter(i=>t in i);return e=e.filter(t=>t.enabled),e.length?h(e,this.ht(i),s):s}map(t,i={}){return this.do(t,i,[],(i,s)=>i.map(i=>i[t](s)))}pipe(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.et=!1;for(let s of i)if(e=s[t](h,e),this.et)break;return e})}pipeBack(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.et=!1;for(let s=i.length-1;s>=0&&(e=i[s][t](h,e),!this.et);s--);return e})}pipeMax(t,i={},s){return this.do(t,i,s,(i,h)=>{let e=s;this.et=!1;for(let s of i){let i=s[t](h,e);if(e=Array.isArray(i)?Array.isArray(e)?e.map((t,s)=>Math.max(t,i[s])):i.map(t=>Math.max(t,e)):Array.isArray(e)?e.map((t,s)=>Math.max(t,i)):Math.max(i,e),this.et)break}return e})}pipeAsync(t,i={},s){const h=this;return this.do(t,i,s,function(i,e){try{let r,n=s;h.et=!1;const o=function(t,i,s){if("function"==typeof t[v]){var h,e,r,n=t[v]();if(function t(o){try{for(;!((h=n.next()).done||s&&s());)if((o=i(h.value))&&o.then){if(!g(o))return void o.then(t,r||(r=p.bind(null,e=new y,2)));o=o.v}e?p(e,1,o):e=o}catch(t){p(e||(e=new y),2,t)}}(),n.return){var o=function(t){try{h.done||n.return()}catch(t){}return t};if(e&&e.then)return e.then(o,function(t){throw o(t)});o()}return e}if(!("length"in t))throw new TypeError("Object is not iterable");for(var a=[],c=0;c<t.length;c++)a.push(t[c]);return function(t,i,s){var h,e,r=-1;return function n(o){try{for(;++r<t.length&&(!s||!s());)if((o=i(r))&&o.then){if(!g(o))return void o.then(n,e||(e=p.bind(null,h=new y,2)));o=o.v}h?p(h,1,o):h=o}catch(t){p(h||(h=new y),2,t)}}(),h}(a,function(t){return i(a[t])},s)}(i,function(i){return Promise.resolve(i[t](e,n)).then(function(t){n=t,h.et&&(r=1)})},function(){return r});return Promise.resolve(o&&o.then?o.then(function(){return n}):n)}catch(t){return Promise.reject(t)}})}value(t,i={}){let s=this.it[t]||this.it.st.filter(i=>t in i);if(s.filter(t=>t.enabled),!s.length)return;const e=s[s.length-1];return h(e[t],e,this.ht(i))}stopPropagation(){this.et=!0}currentTime(){return this.pipe("currentTime")}clampTime(t){return this.pipe("clampTime",{timePassed:t})}shiftTime(t){return this.pipe("shiftTime",{timePassed:t})}cacheClear(){this.rt=0,this.nt=0}viewport(){return this.tt?(this.rt||(this.rt=this.pipe("viewport",{},new d),this.nt=null),this.rt):new d}transformPoint(t,i,s=this.ot.scaleCanvas){return this.nt||(this.nt=this.viewport().clone().invert()),this.nt.transformPoint(t*s,i*s)}callInit(t,i){this.tt=i,this.resize();const s=this.value("images");s&&this.J.add(s),Promise.all(this.map("init",{parameter:t})).then(t=>this.at=!0)}get additionalModifier(){return this.ot}updateAdditionalModifier(){const t=this.t();this.ot=this.pipe("additionalModifier",{},{alpha:1,x:0,y:0,width:t.width,height:t.height,widthInPixel:t.width,heightInPixel:t.height,scaleCanvas:1,visibleScreen:{x:0,y:0,width:t.width,height:t.height},fullScreen:{x:0,y:0,width:t.width,height:t.height}})}resize(){const t=this.t();this.updateAdditionalModifier(),this.pipe("resize"),this.K.forEach(({element:i,isFunction:s})=>{s||i.resize(t,this.ot)})}destroy(){try{const t=this;return Promise.resolve(t.pipeAsync("destroy")).then(function(i){return t.at=!1,i})}catch(t){return Promise.reject(t)}}get timing(){return this.it.t_timing}get camera(){return this.it.t_camera}get control(){return this.it.t_control}get totalTimePassed(){return this.Z}ht(t){return Object.assign({engine:this.tt,scene:this,imageManager:this.J,layerManager:this.K,totalTimePassed:this.Z,output:this.tt&&this.t()},t)}callLoading(t){return this.J.isLoaded()&&this.at?(this.ct=this.value("endTime"),t.progress="Click to play",this.value("loading",t),!0):(t.progress=this.J.getCount()?this.J.getLoaded()/this.J.getCount():"Loading...",this.value("loading",t),!1)}fixedUpdate(t,i){this.map("fixedUpdate",{timePassed:t,lastCall:i})}isDrawFrame(t){return this.pipeMax("isDrawFrame",{timePassed:t},0!==t)}move(t){if(this.Z+=t,this.ut?this.reset():t<0?(t=this.Z,this.reset(),this.initSprites(),this.Z=t):this.ct&&this.ct<=this.Z&&(t-=this.Z-this.ct,this.Z=this.ct,this.map("end",{timePassed:t})),this.value("isChunked")){if(this.value("hasOneChunkedFrame",{timePassed:t})){const i=this.value("calcFrames",{timePassed:t})-1;for(let t=0;t<=i;t++)this.fixedUpdate(this.value("tickChunk"),t===i)}}else this.fixedUpdate(t,!0);this.map("update",{timePassed:t}),this.K.forEach(({element:i,isFunction:s,layer:h,elementId:e})=>{s||i.animate(t)&&h.deleteById(e)})}draw(t){this.map("draw",{canvasId:t});const i=this.t().context[t];i.save(),i.setTransform(...this.viewport().m),this.K.forEach(({layer:t,layerId:s,element:h,isFunction:e,elementId:r})=>{e?h(this.ht({layerId:s,elementId:r,layer:t,context:i}))&&t.deleteById(r):h.draw(i,this.ot)},t),i.restore()}initSprites(t){const i=this.t().context[t];this.K.forEach(({element:t,isFunction:s})=>{s||t.callInit(i,this.ot)},t),this.map("initSprites",{canvasId:t})}resetIntend(){this.ut=!0}reset(){this.Z=0,this.ut=!1;let t=this.pipe("reset",{engine:this.tt,scene:this,layerManager:this.K,imageManager:this.J},new l);if(Array.isArray(t)){const i=t;t=new l,i.forEach(i=>{t.addLayer().addElements(i)})}t&&(this.K=t)}}class M{constructor(t){this.duration=h(t)-0}run(t,i){return i-this.duration}}class b{constructor(){var t=[].slice.call(arguments);let i=0;"number"==typeof t[0]&&(i=t.shift()),this.sequences=t.map(t=>{Array.isArray(t)||(t=[t]);let s=i;return"number"==typeof t[0]&&(s=t.shift()),{position:0,timelapsed:-s,sequence:t.map(t=>"function"!=typeof t.run?"number"==typeof t?new M(t):{run:t}:t).filter(t=>"function"==typeof t.run),label:t.reduce((t,i,s)=>("string"==typeof i&&(t[i]=s-Object.keys(t).length),t),{}),enabled:!0}}),this.lastTimestamp=0,this.enabled=!0}reset(t=0){this.sequences.forEach(i=>{i.enabled=!0,i.position=0,i.timelapsed=t,i.sequence[0]&&i.sequence[0].reset&&i.sequence[0].reset(t)}),this.enabled=!0}play(t="",i=0){if(t){const s=this.sequences.reduce((s,h)=>(h.label.hasOwnProperty(t)?(s=!0,h.position=h.label[t],h.enabled=!0,h.timelapsed=i,h.sequence[h.position]&&h.sequence[h.position].reset&&h.sequence[h.position].reset()):s|=h.sequence.find(s=>s.play&&s.play(t,i))>=0,s),!1);return s&&(this.enabled=!0),s}return this.sequences.forEach(t=>t.enabled=!0),this.enabled=!0,!0}lt(t,i,s){let h=s;for(;i.sequence[i.position]&&h>=0;){if(i.timelapsed+=h,i.timelapsed<0)return-1;if(h=i.sequence[i.position].run(t,i.timelapsed),!0===h)h=0;else{if(!1===h)return-1;if(h===b.dt)return i.enabled=!1,this.enabled=!1,s;if(h===b.ft)return i.enabled=!1,s;if(h===b.vt)return!0}if(h>=0&&(i.position=(i.position+1)%i.sequence.length,i.sequence[i.position]&&i.sequence[i.position].reset&&i.sequence[i.position].reset(),i.timelapsed=0,0===i.position))return i.enabled=!1,h}return h}run(t,i,s){let h=i;if(s||(h=i-this.lastTimestamp,this.lastTimestamp=i),!this.enabled)return h;const e=this.sequences.length;let r=0,n=Infinity;for(let i=0;i<e;i++)if(this.sequences[i].enabled){const s=this.lt(t,this.sequences[i],h);if(!0===s)return!0;n=Math.min(n,s)}else r++;return r===e?(this.enabled=!1,h):n}}b.dt="F",b.ft="S",b.vt="R";class x{constructor(t){this.yt(this,this.gt(),t),this.wt=!0}yt(t,i,s){Object.keys(i).forEach(e=>{const r=i[e];t[e]="function"==typeof r?r(s[e],s,t):f(h(s[e]),r)})}Mt(){return{animation:(t,i)=>{let s=h(t);return Array.isArray(s)?new b(s):s},enabled:!0,isClickable:!1,tag:t=>Array.isArray(t)?t:t?[t]:[]}}gt(){return Object.assign({},this.Mt(),{x:0,y:0,rotation:(t,i)=>f(h(t),f(h(i.rotationInRadian),.017453292519943295*f(h(i.rotationInDegree),0))),scaleX:(t,i)=>f(h(t),f(h(i.scale),1)),scaleY:(t,i)=>f(h(t),f(h(i.scale),1)),alpha:1,compositeOperation:"source-over",color:"#fff"})}getElementsByTag(t){if("function"==typeof t){if(this.tag.filter(t).length)return[this]}else if((Array.isArray(t)?t:[t]).filter(t=>this.tag.includes(t)).length)return[this];return[]}animate(t){return!(!this.animation||!0!==this.animation.run(this,t,!0)||(this.enabled=!1,0))}play(t="",i=0){this.animation&&this.animation.play&&this.animation.play(t,i)}init(t,i){}callInit(t,i){this.wt&&(this.init(t,i),this.wt=!1)}resize(t,i){}bt(t,i,s,h,e){let r=!1;if(this.enabled&&this.isClickable){const n=this.width/2,o=this.height/2;t.save(),h?t.translate(this.x+n,this.y+o):t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.beginPath(),e?r=e(n,o):(t.rect(-n,-o,this.width,this.height),t.closePath(),r=t.isPointInPath(i,s)),t.restore()}return!!r&&this}detectDraw(t,i){}detect(t,i,s){return this.bt(t,i,s,!1,()=>(t.arc(0,0,1,Math.PI/2+this.rotation,2.5*Math.PI-this.rotation,!1),t.isPointInPath(i,s)))}draw(t,i){this.enabled&&(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.beginPath(),t.fillStyle=this.color,t.arc(0,0,1,Math.PI/2+this.rotation,2.5*Math.PI-this.rotation,!1),t.fill(),t.restore())}}class P extends x{constructor(t){super(t)}gt(){return Object.assign({},super.gt(),{sprite:[]})}getElementsByTag(t){let i=super.getElementsByTag(t);for(const s of this.sprite){const h=s.getElementsByTag(t);h&&(i=i.concat(h))}return i}animate(t){let i=super.animate(t),s=!1;if(this.enabled)for(const i of this.sprite)s=s||!0===i.animate(t);return this.animation?i:(s&&(this.enabled=!1),s)}play(t="",i=0){this.animation&&this.animation.play&&this.animation.play(t,i);for(const s of this.sprite)s.play&&s.play(t,i)}resize(t,i){for(const s of this.sprite)s.resize(t,i)}callInit(t,i){super.callInit(t,i);for(let s of this.sprite)s.callInit(t,i)}detectImage(t,i){if(this.enabled)for(const s of this.sprite)s.detectImage(t,i)}detect(t,i,s){if(this.enabled)for(const h of this.sprite){const e=h.detect(t,i,s);if(e)return e}return!1}draw(t,i){if(this.enabled){this.alpha<1&&((i=Object.assign({},i)).alpha*=this.alpha),t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation);for(const s of this.sprite)s.draw(t,i);t.restore()}}}class C extends P{constructor(t){super(t.self||{});let i=f(h(t.count),1);this.sprite=[];const s=t.class;for(let h=0;h<i;h++){let i={};for(let s in t)["self","class","count"].includes(s)||(i[s]="function"==typeof t[s]?t[s].call(t,h):t[s]);this.sprite[h]=new s(i)}}}class I extends x{constructor(t){super(t),this.xt=!1}gt(){return Object.assign({},super.gt(),{x:void 0,y:void 0,width:void 0,height:void 0,gridSize:void 0,darker:0,pixel:!1,clear:!1,norm:(t,i,s)=>f(h(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height)})}Pt(t){const i=t.widthInPixel,s=t.heightInPixel;this.Ct=document.createElement("canvas"),this.gridSize?(this.xt=this.gridSize,this.Ct.width=Math.round(this.xt),this.Ct.height=Math.round(this.xt)):(this.Ct.width=Math.ceil(i/this.scaleX),this.Ct.height=Math.ceil(s/this.scaleY)),this.It=this.Ct.getContext("2d"),this.It.globalCompositeOperation="source-over",this.It.globalAlpha=1}normalizeFullScreen(t){(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y),(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height)}resize(t,i){if(this.Ct&&this.xt!==this.gridSize){const t=this.Ct;this.Pt(i),this.It.globalCompositeOperation="copy",this.It.drawImage(t,0,0,t.width,t.height,0,0,this.Ct.width,this.Ct.height),this.It.globalCompositeOperation="source-over"}this.normalizeFullScreen(i)}detect(t,i,s){return this.bt(t,i,s,!1)}init(t,i){this.Pt(i),this.normalizeFullScreen(i)}draw(t,i){if(this.enabled&&this.alpha>0){this.gridSize&&this.xt!==this.gridSize&&this.resize(t,i);const s=this.alpha*i.alpha,h=this.width,e=this.height,r=this.Ct.width,n=this.Ct.height;if(s>0&&r&&n){this.It.globalCompositeOperation="copy",this.It.globalAlpha=1,this.It.drawImage(t.canvas,0,0,t.canvas.width,t.canvas.height,0,0,r,n),this.darker>0&&(this.It.globalCompositeOperation=this.clear?"source-atop":"source-over",this.It.fillStyle="rgba(0,0,0,"+this.darker+")",this.It.fillRect(0,0,r,n)),this.additionalBlur&&this.additionalBlur(r,n,i),this.clear&&(t.globalCompositeOperation="source-over",t.globalAlpha=1,t.clearRect(this.x,this.y,h,e)),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=s;const o=t.imageSmoothingEnabled;t.imageSmoothingEnabled=!this.pixel,t.drawImage(this.Ct,0,0,r,n,this.x,this.y,h,e),t.imageSmoothingEnabled=o}}else this.clear&&(this.x||(this.x=i.x),this.y||(this.y=i.y),this.width||(this.width=i.width),this.height||(this.height=i.height),t.clearRect(this.x,this.y,this.width,this.height))}}class T extends x{constructor(t){super(t),this.Tt=!1}gt(){return Object.assign({},super.gt(),{image:t=>c.getImage(h(t)),position:T.CENTER,frameX:0,frameY:0,frameWidth:0,frameHeight:0,width:void 0,height:void 0,norm:!1,normCover:!1,normToScreen:!1,clickExact:!1,color:"#FFF",tint:0})}resize(t,i){this.wt=!0}init(t,i){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height;this.Ft=this.normToScreen?this.normCover?Math.max(i.fullScreen.width/s,i.fullScreen.height/h):this.norm?Math.min(i.fullScreen.width/s,i.fullScreen.height/h):1:this.normCover?Math.max(i.width/s,i.height/h):this.norm?Math.min(i.width/s,i.height/h):1}kt(){return[this.tint,this.frameWidth||this.image.width,this.frameHeight||this.image.height,this.color,this.frameX,this.frameY].join(";")}Ot(t,i){return this.Ct||(this.Ct=document.createElement("canvas"),this.It=this.Ct.getContext("2d")),this.Ct.width=t,this.Ct.height=i,this.It}detectDraw(t,i){if(this.enabled&&this.isClickable&&this.clickExact){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height,e=(this.width?this.width:s)*this.Ft*this.scaleX,r=(this.height?this.height:h)*this.Ft*this.scaleY,n=this.position===T.LEFT_TOP,o=this.Ot(s,h);o.globalAlpha=1,o.globalCompositeOperation="source-over",o.fillStyle=i,o.fillRect(0,0,s,h),o.globalCompositeOperation="destination-atop",o.drawImage(this.image,this.frameX,this.frameY,s,h,0,0,s,h),t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.drawImage(this.Ct,0,0,s,h,n?0:-e/2,n?0:-r/2,e,r),t.restore(),this.Tt=!1}}detect(t,i,s){return this.enabled&&this.isClickable&&this.clickExact?"c":this.bt(t,i,s,!1)}draw(t,i){if(this.enabled&&this.image&&this.alpha>0){const s=this.frameWidth||this.image.width,h=this.frameHeight||this.image.height,e=(this.width?this.width:s)*this.Ft*this.scaleX,r=(this.height?this.height:h)*this.Ft*this.scaleY;t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha;const n=this.position!==T.LEFT_TOP;let o=this.image,a=this.frameX,c=this.frameY;if(this.tint){if(this.Tt!==this.kt()){const t=this.Ot(s,h);t.globalAlpha=1,t.globalCompositeOperation="source-over",t.clearRect(0,0,s,h),t.globalAlpha=this.tint,t.fillStyle=this.color,t.fillRect(0,0,s,h),t.globalAlpha=1,t.globalCompositeOperation="destination-atop",t.drawImage(this.image,this.frameX,this.frameY,s,h,0,0,s,h),this.Tt=this.kt()}o=this.Ct,a=0,c=0}let u=0,l=0;n&&(u=-e/2,l=-r/2),0==this.rotation?t.drawImage(o,a,c,s,h,this.x+u,this.y+l,e,r):(t.save(),t.translate(this.x,this.y),t.rotate(this.rotation),t.drawImage(o,a,c,s,h,u,l,e,r),t.restore())}}}T.LEFT_TOP=0,T.CENTER=1;class F extends x{constructor(t){super(t)}gt(){return Object.assign({},super.gt(),{text:void 0,font:"2em monospace",position:F.CENTER,color:void 0,borderColor:void 0,lineWidth:1})}detectDraw(t,i){this.enabled&&this.isClickable&&(t.save(),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),this.position||(t.textAlign="left",t.textBaseline="top"),t.font=this.font,t.fillStyle=i,t.fillText(this.text,0,0),t.restore())}detect(t,i){return"c"}draw(t,i){this.enabled&&(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.save(),this.position||(t.textAlign="left",t.textBaseline="top"),t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.font=this.font,this.color&&(t.fillStyle=this.color,t.fillText(this.text,0,0)),this.borderColor&&(t.strokeStyle=this.borderColor,t.lineWidth=this.lineWidth,t.strokeText(this.text,0,0)),t.restore())}}F.LEFT_TOP=0,F.CENTER=1;class k extends x{constructor(t){super(t),this.Et=void 0,this.St=!1}static getGradientImage(t,i,s){let h=t>>4,e=i>>4,r=s>>4;if(!k.jt){const t=16;k.jt=Array.from({length:t},i=>Array.from({length:t},i=>Array.from({length:t})))}return k.jt[h][e][r]||(k.jt[h][e][r]=k.generateGradientImage(h,e,r)),k.jt[h][e][r]}static generateGradientImage(t,i,s){let h=document.createElement("canvas");h.width=h.height=64;let e=h.getContext("2d");e.globalAlpha=1,e.globalCompositeOperation="source-over",e.clearRect(0,0,64,64);let r=e.createRadialGradient(32,32,0,32,32,32);return r.addColorStop(0,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",1)"),r.addColorStop(.3,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0.4)"),r.addColorStop(1,"rgba("+(16+(t<<4)-1)+","+(16+(i<<4)-1)+","+(16+(s<<4)-1)+",0)"),e.fillStyle=r,e.fillRect(0,0,64,64),h}resize(t,i){this.Et=void 0}draw(i,s){if(this.enabled){this.color&&this.color.r||(this.color=new t(this.color).toRgb()),this.Et!==this.scaleX&&(this.Et=this.scaleX,this.St=this.scaleX*s.widthInPixel/s.width>64);const{r:h,g:e,b:r}=this.color;i.globalCompositeOperation=this.compositeOperation,i.globalAlpha=this.alpha*s.alpha,i.imageSmoothingEnabled=this.St,i.drawImage(k.getGradientImage(h,e,r),0,0,64,64,this.x-this.scaleX/2,this.y-this.scaleY/2,this.scaleX,this.scaleY),i.imageSmoothingEnabled=!0}}}class O extends x{constructor(t){super(t)}gt(){return Object.assign({},super.gt(),{x:void 0,y:void 0,width:void 0,height:void 0,borderColor:void 0,color:void 0,lineWidth:1,clear:!1,norm:(t,i,s)=>f(h(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height),position:O.CENTER})}normalizeFullScreen(t){(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height),(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x,this.position===O.CENTER&&(this.x+=this.width/2)),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y,this.position===O.CENTER&&(this.y+=this.height/2))}resize(t,i){this.wt=!0}init(t,i){this.normalizeFullScreen(i)}detect(t,i,s){return this.bt(t,i,s,this.position===O.LEFT_TOP)}draw(t,i){if(this.enabled&&this.alpha>0)if(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,0===this.rotation&&this.position===O.LEFT_TOP)this.clear?t.clearRect(this.x,this.y,this.width,this.height):this.color&&(t.fillStyle=this.color,t.fillRect(this.x,this.y,this.width,this.height)),this.borderColor&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.borderColor,t.rect(this.x,this.y,this.width,this.height),t.stroke());else{let i=this.width/2,s=this.height/2;t.save(),this.position===O.LEFT_TOP?t.translate(this.x+i,this.y+s):t.translate(this.x,this.y),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),this.clear?t.clearRect(-i,-s,this.width,this.height):this.color&&(t.fillStyle=this.color,t.fillRect(-i,-s,this.width,this.height)),this.borderColor&&(t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.borderColor,t.rect(-i,-s,this.width,this.height),t.stroke()),t.restore()}}}O.LEFT_TOP=0,O.CENTER=1;var E={Callback:class extends x{constructor(t){"function"==typeof t&&(t={callback:t}),super(t),this.zt=0,this.At=0}gt(){return Object.assign({},this.Mt(),{callback:t=>void 0===typeof t?()=>{}:t})}animate(t){return this.enabled&&(this.zt+=t,this.At+=t),super.animate(t)}detect(t,i){}draw(t,i){this.enabled&&this.callback(t,this.zt,i,this),this.At=0}},Canvas:class extends P{constructor(t){super(t),this.xt=!1,this.T=2}gt(){return Object.assign({},super.gt(),{x:void 0,y:void 0,width:void 0,height:void 0,canvasWidth:void 0,canvasHeight:void 0,gridSize:void 0,norm:(t,i,s)=>f(h(t),void 0===s.x&&void 0===s.y&&void 0===s.width&&void 0===s.height),isDrawFrame:(t,i,s)=>f(t,!0)})}Pt(t){const i=t.widthInPixel,s=t.heightInPixel;this.Ct=document.createElement("canvas"),this.canvasWidth&&this.canvasHeight?(this.Ct.width=this.canvasWidth,this.Ct.height=this.canvasHeight):this.gridSize?(this.xt=this.gridSize,this.Ct.width=Math.round(this.xt),this.Ct.height=Math.round(this.xt)):(this.Ct.width=Math.round(i/this.scaleX),this.Ct.height=Math.round(s/this.scaleY)),this.It=this.Ct.getContext("2d")}normalizeFullScreen(t){(this.norm||void 0===this.x)&&(this.x=t.visibleScreen.x),(this.norm||void 0===this.y)&&(this.y=t.visibleScreen.y),(this.norm||void 0===this.width)&&(this.width=t.visibleScreen.width),(this.norm||void 0===this.height)&&(this.height=t.visibleScreen.height)}resize(t,i){if(this.Ct&&this.xt!==this.gridSize&&!this.canvasWidth){const t=this.Ct;this.Pt(i),this.It.globalCompositeOperation="copy",this.It.drawImage(t,0,0,t.width,t.height,0,0,this.Ct.width,this.Ct.height),this.It.globalCompositeOperation="source-over",this.T=2}this.normalizeFullScreen(i),super.resize(t,i)}detect(t,i,s){return this.bt(t,i,s,!1)}init(t,i){this.Pt(i),this.normalizeFullScreen(i)}draw(t,i){if(this.enabled){this.gridSize&&this.xt!==this.gridSize&&this.resize(i),this.T=Math.max(this.T-1,h(this.isDrawFrame,t,i));const s=this.width,e=this.height,r=s/2,n=e/2,o=this.Ct.width,a=this.Ct.height;if(this.T){this.It.textBaseline="middle",this.It.textAlign="center",this.It.globalAlpha=1,this.It.globalCompositeOperation="source-over",this.It.save();const t=i.cam;if(this.norm&&t){const i=Math.max(o,a)/2;this.It.translate(o/2,a/2),this.It.scale(i,i),this.It.scale(t.zoom,t.zoom),this.It.translate(-t.x,-t.y)}for(const t of this.sprite)t.draw(this.It,this.norm?Object.assign({},i,{alpha:1,widthInPixel:o,heightInPixel:a}):{alpha:1,x:0,y:0,width:o,height:a,widthInPixel:o,heightInPixel:a,visibleScreen:{x:0,y:0,width:o,height:a}});this.It.restore()}t.save(),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,t.translate(this.x+r,this.y+n),t.scale(this.scaleX,this.scaleY),t.rotate(this.rotation),t.drawImage(this.Ct,0,0,o,a,-r,-n,s,e),t.restore()}}},Circle:x,Emitter:C,FastBlur:I,Group:P,Image:T,Text:F,Particle:k,Path:class extends P{constructor(t){if(super(t),this.oldPath=void 0,this.path2D=new Path2D,this.polyfill)if("function"!=typeof Path2D){let t=document.getElementsByTagName("head")[0],i=document.createElement("script");i.type="text/javascript",i.src="https://cdn.jsdelivr.net/npm/canvas-5-polyfill@0.1.5/canvas.min.js",t.appendChild(i)}else{let t=document.createElement("canvas").getContext("2d");t.stroke(new Path2D("M0,0H1")),t.getImageData(0,0,1,1).data[3]&&(this.polyfill=!1)}}gt(){return Object.assign({},super.gt(),{path:void 0,color:void 0,borderColor:void 0,lineWidth:1,clip:!1,fixed:!1,polyfill:!0})}changeToPathInit(t,s){return i._t("string"==typeof t?i.path2shapes(t):t,"string"==typeof s?i.path2shapes(s):s)}changeToPath(t,s,h){return i.Dt(s.pathFrom,s.pathTo,t)}detect(t,i,s){return this.bt(t,i,s,!1,()=>t.isPath(this.path2D,i,s))}draw(t,s){if(this.enabled){const h=this.alpha*s.alpha;this.oldPath!==this.path&&(this.polyfill&&"string"==typeof this.path&&(this.path=i.path2shapes(this.path)),Array.isArray(this.path)?(this.path2D=new Path2D,this.path.forEach(t=>{this.path2D.moveTo(t[0][0],t[0][1]),t.forEach(t=>{this.path2D.bezierCurveTo(t[2],t[3],t[4],t[5],t[6],t[7])}),this.path2D.closePath()})):this.path2D=this.path instanceof Path2D?this.path:new Path2D(this.path),this.oldPath=this.path);let e=this.scaleX,r=this.scaleY;this.fixed&&(0==e&&(e=Number.EPSILON),0==r&&(r=Number.EPSILON)),t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=h,t.save(),t.translate(this.x,this.y),t.scale(e,r),t.rotate(this.rotation),this.color&&(t.fillStyle=this.color,t.fill(this.path2D)),t.save(),this.clip&&(t.clip(this.path2D),this.fixed&&(t.rotate(-this.rotation),t.scale(1/e,1/r),t.translate(-this.x,-this.y)));for(const i of this.sprite)i.draw(t,s);t.restore(),this.borderColor&&(t.strokeStyle=this.borderColor,t.lineWidth=this.lineWidth,t.stroke(this.path2D)),t.restore()}}},Rect:O,Scroller:class extends C{constructor(t){let i=h(t.text),s=Array.isArray(i)?i:[...i];super(Object.assign({},t,{class:F,count:s.length,text:t=>s[t],enabled:i=>" "!==s[i]&&h(t.enabled,i)}))}},StackBlur:class extends I{constructor(t){super(t),this.xt=!1,this.Lt=void 0}gt(){return Object.assign({},super.gt(),{onCanvas:!1,radius:void 0,radiusPart:void 0,radiusScale:!0})}normalizeFullScreen(t){this.norm&&this.onCanvas?(this.x=0,this.y=0,this.width=t.widthInPixel,this.height=t.heightInPixel):super.normalizeFullScreen(t)}resize(t,i){super.resize(t,i),this.radiusPart&&(this.radius=void 0)}additionalBlur(t,i,h){const e=this.It.getImageData(0,0,t,i);s(e,0,0,t,i,h.radius),this.It.putImageData(e,0,0)}detect(t,i,s){return this.bt(t,i,s,!1)}draw(t,i){if(this.enabled){void 0!==this.radius&&this.Lt===this.radiusPart||(this.radius=Math.round((i.widthInPixel+i.heightInPixel)/2/this.radiusPart),this.Lt=this.radiusPart);const h=Math.round(this.radius*(this.radiusScale&&(i.cam?i.cam.zoom:1)/i.scaleCanvas));if(h)if(this.onCanvas){void 0!==this.width&&void 0!==this.height||this.normalizeFullScreen(i);const e=Math.round(this.x),r=Math.round(this.y),n=Math.round(this.width),o=Math.round(this.height);this.imageData=t.getImageData(e,r,n,o),s(this.imageData,0,0,n-e,o-r,h),t.putImageData(this.imageData,e,r,0,0,n,o)}else i.radius=h,super.draw(t,i)}else super.draw(t,i)}},StarField:class extends O{constructor(t){super(t),this.Nt=[],this.Bt=[],this.Wt=[],this.$t=[],this.Ut=[],this.Xt=[],this.Yt=[],this.Rt=[],this.Ht=[]}gt(){return Object.assign({},super.gt(),{count:40,moveX:0,moveY:0,moveZ:0,lineWidth:void 0,highScale:!0,color:"#FFF"})}init(t,i){function s(t,i,s=-i){return void 0===t||t<i||t>=s?Math.random()*(s-i)+i:t}this.width=this.width||i.width,this.height=this.height||i.height,this.x=void 0===this.x?i.x:this.x,this.y=void 0===this.y?i.y:this.y,this.lineWidth=this.lineWidth||Math.min(i.height/i.heightInPixel,i.width/i.widthInPixel)/2,this.qt=this.width/2+this.x,this.Gt=this.height/2+this.y,this.Vt=Math.max(this.width,this.height)/2;for(let t=0;t<this.count;t++)this.Nt[t]=s(this.Nt[t],-this.width/2),this.Bt[t]=s(this.Bt[t],-this.height/2),this.Wt[t]=s(this.Wt[t],0,this.Vt)}moveStar(t,i,s){s&&(this.Rt[t]=!0);const h=this.width/2,e=this.height/2;let r=this.Nt[t]+this.moveX*i,n=this.Bt[t]+this.moveY*i,o=this.Wt[t]+this.moveZ*i;for(;r<-h;)r+=this.width,n=Math.random()*this.height-e,this.Rt[t]=!1;for(;r>h;)r-=this.width,n=Math.random()*this.height-e,this.Rt[t]=!1;for(;n<-e;)n+=this.height,r=Math.random()*this.width-h,this.Rt[t]=!1;for(;n>e;)n-=this.height,r=Math.random()*this.width-h,this.Rt[t]=!1;for(;o<=0;)o+=this.Vt,r=Math.random()*this.width-h,n=Math.random()*this.height-e,this.Rt[t]=!1;for(;o>this.Vt;)o-=this.Vt,r=Math.random()*this.width-h,n=Math.random()*this.height-e,this.Rt[t]=!1;const a=this.qt+r/o*h,c=this.Gt+n/o*e;if(this.Rt[t]=this.Rt[t]&&a>=this.x&&c>=this.y&&a<this.x+this.width&&c<this.y+this.height,s)this.Nt[t]=r,this.Bt[t]=n,this.Wt[t]=o,this.Xt[t]=a,this.Yt[t]=c;else{this.$t[t]=a,this.Ut[t]=c;let i=4*(1-this.Wt[t]/this.Vt);this.highScale||(i=Math.ceil(i)),this.Ht[t]=i}}animate(t){let i=super.animate(t);if(this.enabled&&void 0!==this.qt){let i=this.count;for(;i--;)this.moveStar(i,t/16,!0),this.Rt[i]&&this.moveStar(i,-5,!1)}return i}resize(t,i){this.wt=!0}detect(t,i,s){return this.bt(t,i,s,!1)}draw(t,i){if(this.enabled)if(t.globalCompositeOperation=this.compositeOperation,t.globalAlpha=this.alpha*i.alpha,0==this.moveY&&0==this.moveZ&&this.moveX<0){t.fillStyle=this.color;let i=this.count;for(;i--;)this.Rt[i]&&t.fillRect(this.Xt[i],this.Yt[i]-this.Ht[i]*this.lineWidth/2,this.$t[i]-this.Xt[i],this.Ht[i]*this.lineWidth)}else if(t.strokeStyle=this.color,this.highScale){let i=this.count;for(;i--;)this.Rt[i]&&(t.beginPath(),t.lineWidth=this.Ht[i]*this.lineWidth,t.moveTo(this.$t[i],this.Ut[i]),t.lineTo(this.Xt[i],this.Yt[i]),t.stroke(),t.closePath())}else{let i,s=5;for(;--s;){for(t.beginPath(),t.lineWidth=s*this.lineWidth,i=this.count;i--;)this.Rt[i]&&this.Ht[i]===s&&(t.moveTo(this.$t[i],this.Ut[i]),t.lineTo(this.Xt[i],this.Yt[i]));t.stroke(),t.closePath()}}}}};function S(t,i){return i.from+t*i.delta}function j(t,i){for(var s,h=[...i.values],e=h.length;e>1;)for(e--,s=0;s<e;s++)h[s]=h[s]+t*(h[s+1]-h[s]);return h[0]}function z(t,i,s){return i.colorFrom.mix(i.colorTo,100*t).toString()}function A(t,i,s){return s.changeToPath(t,i,s)}class _{constructor(t,i,s){this.initialized=!1,this.changeValues=[];for(let i in t){const s=t[i],e="rotationInDegree"===i?.017453292519943295*s:s,r="color"===i||"borderColor"===i,n="path"===i,o="function"==typeof e,a=!r&&Array.isArray(e),c="scale"===i?["scaleX","scaleY"]:"rotationInRadian"===i||"rotationInDegree"===i?["rotation"]:[i];for(const t of c)this.changeValues.push({name:t,to:a?e[e.length-1]:h(e,1,{}),bezier:!!a&&e,isColor:r,isPath:n,isFunction:!!o&&e,moveAlgorithm:r?z:n?A:a?j:S})}this.duration=f(h(i),0),this.ease=f(s,t=>t)}reset(){this.initialized=!1}init(i,s){for(var h,e=this.changeValues.length;e--;)(h=this.changeValues[e]).isFunction?(h.from=i[h.name],h.to=h.isFunction(h.from),h.isColor?(h.colorFrom=new t(h.from),h.colorTo=new t(h.to),h.moveAlgorithm=z):h.isPath?([h.pathFrom,h.pathTo]=i.changeToPathInit(h.from,h.to),h.moveAlgorithm=A):Array.isArray(h.to)?(h.values=[i[h.name],...h.to],h.moveAlgorithm=j):(h.delta=h.to-h.from,h.moveAlgorithm=S)):h.isColor?(h.colorFrom=new t(i[h.name]),h.colorTo=new t(h.to)):h.isPath?[h.pathFrom,h.pathTo]=i.changeToPathInit(i[h.name],h.to):h.bezier?h.values=[i[h.name],...h.bezier]:(h.from=i[h.name],h.delta=h.to-h.from)}run(t,i){if(this.initialized||(this.initialized=!0,this.init(t,i)),this.duration<=i){let i,s=this.changeValues.length;for(;s--;)i=this.changeValues[s],t[i.name]=i.to}else{let s,h=this.changeValues.length;const e=this.ease(i/this.duration);for(;h--;)s=this.changeValues[h],t[s.name]=s.moveAlgorithm(e,s,t)}return i-this.duration}}var D={Callback:class{constructor(t,i){this.callback=t,this.duration=f(h(i),void 0),this.initialized=!1}reset(){this.initialized=!1}run(t,i){let s;return void 0!==this.duration?(this.callback(t,Math.min(i,this.duration),!this.initialized),this.initialized=!0,i-this.duration):(s=this.callback(t,i,!this.initialized),this.initialized=!0,s)}},ChangeTo:_,End:class{constructor(){}run(t,i){return b.dt}},EndDisabled:class{constructor(){}run(t,i){return t.enabled=!1,b.dt}},Forever:class{constructor(){var t=[].slice.call(arguments);this.Aniobject=t[0]instanceof b?t[0]:new b(...t)}reset(t=0){this.Aniobject.reset&&this.Aniobject.reset(t)}play(t="",i=0){this.Aniobject.play&&this.Aniobject.play(t,i)}run(t,i,s){let h=i;for(;h>=0;){if(h=this.Aniobject.run(t,h,s),s=!0,!0===h)return!0;h>=0&&this.Aniobject.reset&&this.Aniobject.reset()}return h}},If:class{constructor(t,i,s){this.ifCallback=t,this.Aniobject=i,this.AniobjectElse=f(s,()=>0)}run(t,i){const s=h(this.ifCallback)?this.Aniobject:this.AniobjectElse;return s.run?s.run(t,i):s(t,i)}},Image:class{constructor(t,i){this.initialized=!1,this.image=h(t),this.durationBetweenFrames=f(h(i),0),Array.isArray(this.image)?this.count=this.image.length:(this.image=[this.image],this.count=1),this.duration=this.count*this.durationBetweenFrames}reset(){this.initialized=!1}run(t,i){if(this.initialized||(this.initialized=!0,this.current=-1),i>=this.duration)t.image=c.getImage(this.image[this.image.length-1]);else{let s=Math.floor(i/this.durationBetweenFrames);s!==this.current&&(this.current=s,t.image=c.getImage(this.image[this.current]))}return i-this.duration}},ImageFrame:class{constructor(t,i,s){this.initialized=!1,this.frameNumber=h(t),this.framesToRight=f(h(i),!0),this.durationBetweenFrames=f(h(s),0),Array.isArray(this.frameNumber)||(this.frameNumber=[this.frameNumber]),this.duration=this.frameNumber.length*this.durationBetweenFrames}run(t,i){let s=0;return s=i>=this.duration?this.frameNumber[this.frameNumber.length-1]:this.frameNumber[Math.floor(i/this.durationBetweenFrames)],this.framesToRight?t.frameX=t.frameWidth*s:t.frameY=t.frameHeight*s,i-this.duration}},Loop:class{constructor(t){var i=[].slice.call(arguments,1);this.Aniobject=i[0]instanceof b?i[0]:new b(...i),this.times=this.timesOrg=f(h(t),1)}reset(t=0){this.times=this.timesOrg,this.Aniobject.reset&&this.Aniobject.reset(t)}play(t="",i=0){this.times=this.timesOrg,this.Aniobject.play&&this.Aniobject.play(t,i)}run(t,i,s){let h=i;for(;h>=0&&this.times>0;){if(h=this.Aniobject.run(t,h,s),s=!0,!0===h)return!0;h>=0&&(this.times--,this.Aniobject.reset&&this.Aniobject.reset())}return h}},Move:class extends _{constructor(t,i,s,e){super({x:t,y:i},0,e),this.speed=h(s)||1}init(t,i){if(0==this.speed||this.targetX===t.x&&this.targetY===t.y)this.duration=0;else{let i=this.changeValues[0],s=this.changeValues[1];i.from=t.x,s.from=t.y,i.delta=i.to-i.from,s.delta=s.to-s.from;const h=Math.sqrt(i.delta*i.delta+s.delta*s.delta);this.duration=10*h/this.speed}super.init(t,i)}},Once:class{constructor(t,i){this.Aniobject=t,this.times=f(h(i),1)}run(t,i){if(this.times<=0)return i;{let s=this.Aniobject.run(t,i);return s>=0&&this.times--,s}}},Remove:class{constructor(){}run(t,i){return b.vt}},Sequence:b,Shake:class{constructor(t,i){this.initialized=!1,this.duration=h(i),this.shakeDiff=h(t),this.shakeDiffHalf=this.shakeDiff/2}reset(){this.initialized=!1}run(t,i){return this.initialized||(this.initialized=!0,this.x=t.x,this.y=t.y),i>=this.duration?(t.x=this.x,t.y=this.y):(t.x=this.x+Math.random()*this.shakeDiff-this.shakeDiffHalf,t.y=this.y+Math.random()*this.shakeDiff-this.shakeDiffHalf),i-this.duration}},ShowOnce:class{constructor(){this.showOnce=!0}run(t,i){return t.enabled=t.enabled&&this.showOnce,this.showOnce=!1,0}},State:class{constructor({states:t={},transitions:i={},default:s,delegateTo:h}={}){this.states=t,Object.keys(this.states).forEach(t=>{Array.isArray(this.states[t])&&(this.states[t]=new b(this.states[t]))}),this.transitions=i,this.delegateTo=h,this.currentStateName=s,this.currentState=this.states[s],this.isTransitioningToStateName=void 0}setState(t,i){if(t!==this.currentStateName){this.isTransitioningToStateName=t;const i=`${t.charAt(0).toUpperCase()}${t.slice(1)}`,s=[`${this.currentStateName}To${i}`,`${this.currentStateName}To`,`to${i}`].find(t=>this.transitions[t]);s?(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.transitions[s],this.currentState&&this.currentState.reset&&this.currentState.reset()):(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.states[this.currentStateName],this.currentState&&this.currentState.reset&&this.currentState.reset(),this.isTransitioningToStateName=void 0)}}play(t="",i=0){this.currentState.play&&this.currentState.play(t,i)}run(t,i,s){let h=i,e=s;if(this.currentState){if(h=this.currentState.run(t,h,e),!0===h)return!0;e=!0}if(h>=0||!this.currentState)if(this.isTransitioningToStateName){if(this.currentStateName=this.isTransitioningToStateName,this.currentState=this.states[this.currentStateName],this.currentState&&this.currentState.reset&&this.currentState.reset(),this.isTransitioningToStateName=void 0,h=this.currentState.run(t,h,e),!0===h)return!0}else this.currentState=void 0;return-1}},Stop:class{constructor(){}run(t,i){return b.ft}},StopDisabled:class{constructor(){}run(t,i){return t.enabled=!1,b.ft}},Wait:M,WaitDisabled:class{constructor(t){this.duration=f(h(t),0)}run(t,i){return t.enabled=i>=this.duration,i-this.duration}}};class L{constructor(t={}){this.type="camera",this.cam=Object.assign({zoom:1,x:0,y:0},t)}viewport({},t){return t.scale(this.cam.zoom,this.cam.zoom).translate(-this.cam.x,-this.cam.y)}viewportByCam({engine:t},i){const s=t.getWidth()/2,h=t.getHeight()/2,e=t.getRatio()>1?s:h;return(new d).translate(s,h).scale(e,e).scale(i.zoom,i.zoom).translate(-i.x,-i.y)}additionalModifier({},t){return t.cam=Object.assign({},this.cam),t}clampView({engine:t,scene:i,clampLimits:s},h){const e=s||{x1:i.additionalModifier.x,y1:i.additionalModifier.y,x2:i.additionalModifier.x+i.additionalModifier.width,y2:i.additionalModifier.y+i.additionalModifier.height},r=this.viewportByCam({engine:t},h).invert(),[n,o]=r.transformPoint(0,0),[a,c]=r.transformPoint(t.getWidth(),t.getHeight());return a-n<=e.x2-e.x1?n<e.x1?a<=e.x2&&(h.x+=e.x1-n):a>e.x2&&(h.x+=e.x2-a):n>e.x1?h.x+=e.x1-n:a<e.x2&&(h.x+=e.x2-a),c-o<=e.y2-e.y1?o<e.y1?c<=e.y2&&(h.y+=e.y1-o):c>e.y2&&(h.y+=e.y2-c):o>e.y1?h.y+=e.y1-o:c<e.y2&&(h.y+=e.y2-c),h}set zoom(t){this.cam.zoom=t}set camX(t){this.cam.x=t}set camY(t){this.cam.y=t}get zoom(){return this.cam.zoom}get camX(){return this.cam.x}get camY(){return this.cam.y}zoomToFullScreen({scene:t}){return Math.min(t.additionalModifier.fullScreen.width/t.additionalModifier.width,t.additionalModifier.fullScreen.height/t.additionalModifier.height)}zoomTo({scene:t,engine:i,cam:s,x1:h,y1:e,x2:r,y2:n}){const o=t.additionalModifier.scaleCanvas,a=this.viewportByCam({engine:i},s||this.cam).invert(),[c,u]=a.transformPoint(0,0),[l,d]=a.transformPoint(i.getWidth()*o,i.getHeight()*o),f=r-h,m=n-e,v={x:h+f/2,y:e+m/2,zoom:s.zoom*Math.max(Math.min((l-c)/f,(d-u)/m),Number.MIN_VALUE)};s?(s.x=v.x,s.y=v.y,s.zoom=v.zoom):this.cam=v}}class N{constructor(t={}){this.type="control",this.Kt={},this.toCam={},this.config=Object.assign({zoomMax:10,zoomMin:.5,zoomFactor:1.2,tween:2,callResize:!0},t)}init({scene:t}){this.h=t,this.toCam=Object.assign({},t.camera.cam)}mouseDown({event:t,position:[i,s],button:h}){this.Kt[h]=Object.assign({},this.Kt[h],{x:i,y:s,Zt:this.toCam.x,Jt:this.toCam.y,Qt:!0,ti:t.touches&&t.touches.length||1,ii:void 0,si:Date.now()})}mouseUp({event:t,position:[i,s],button:h,scene:e}){this.Kt[h]||(this.Kt[h]={});const r=this.Kt[h].Qt,n=t.changedTouches&&t.changedTouches.length||1,o=Math.max(this.Kt[h].ti,n);this.Kt[h].Qt=!1,this.Kt[h].ti-=n,!r||o>1?e.stopPropagation():Date.now()-this.Kt[h].si<300&&Math.abs(this.Kt[h].x-i)<5&&Math.abs(this.Kt[h].y-s)<5&&1===h||e.stopPropagation()}mouseOut({button:t}){this.Kt[t]&&(this.Kt[t].Qt=!1)}mouseMove({event:t,position:[i,s],button:h,scene:e}){if(!this.Kt[h]||!this.Kt[h].Qt||0===t.which&&!t.touches)return;const r=e.additionalModifier.scaleCanvas;if(t.touches&&t.touches.length>=2){const i=t.touches,s=Math.sqrt((i[0].pageX-i[1].pageX)*(i[0].pageX-i[1].pageX)+(i[0].pageY-i[1].pageY)*(i[0].pageY-i[1].pageY));void 0===this.Kt[h].ii?s>0&&(this.Kt[h].ii=s,this.Kt[h].hi=this.toCam.zoom):(this.toCam.zoom=Math.max(this.config.zoomMin,Math.min(this.config.zoomMax,this.Kt[h].hi*s/this.Kt[h].ii)),this.toCam=e.camera.clampView(arguments[0],this.toCam))}else{this.Kt[h].ii=void 0;const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,o]=t.transformPoint(this.Kt[h].x*r,this.Kt[h].y*r),[a,c]=t.transformPoint(i*r,s*r);this.toCam.x=this.Kt[h].Zt+n-a,this.toCam.y=this.Kt[h].Jt+o-c,this.toCam=e.camera.clampView(arguments[0],this.toCam)}}mouseWheel({event:t,position:[i,s],scene:h}){const e=h.additionalModifier.scaleCanvas,[r,n]=h.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(i*e,s*e);if((t.wheelDelta||-1*t.deltaY)/120>0){this.zoomIn();const[t,o]=h.camera.viewportByCam(arguments[0],this.toCam).invert().transformPoint(i*e,s*e);this.toCam.x-=t-r,this.toCam.y-=o-n,this.toCam=h.camera.clampView(arguments[0],this.toCam)}else this.zoomOut(arguments[0])}hasCamChanged(){const t=this.config.tween||1;return Math.abs(this.toCam.x-this.h.camera.cam.x)>=Number.EPSILON*t||Math.abs(this.toCam.y-this.h.camera.cam.y)>=Number.EPSILON*t||Math.abs(this.toCam.zoom-this.h.camera.cam.zoom)>=Number.EPSILON*t}fixedUpdate({scene:t,lastCall:i}){this.config.tween&&!this.ei&&this.hasCamChanged()&&(t.camera.cam.x+=(this.toCam.x-t.camera.cam.x)/this.config.tween,t.camera.cam.y+=(this.toCam.y-t.camera.cam.y)/this.config.tween,t.camera.cam.zoom+=(this.toCam.zoom-t.camera.cam.zoom)/this.config.tween,i&&(t.additionalModifier.cam=this.cam,this.config.callResize?t.resize():t.cacheClear()))}update({scene:t}){this.config.tween&&!this.ei||!this.hasCamChanged()||(this.ei=!1,t.camera.cam=Object.assign({},this.toCam),this.config.callResize?t.resize():t.cacheClear())}camInstant(){this.ei=!0}resize(t){this.toCam=t.scene.camera.clampView(t,this.toCam)}zoomToNorm(){return this.toCam.zoom=1,this}zoomIn(){return this.toCam.zoom=Math.min(this.config.zoomMax,this.toCam.zoom*this.config.zoomFactor),this}zoomOut(t){return this.toCam.zoom=Math.max(this.config.zoomMin,this.toCam.zoom/this.config.zoomFactor),t&&(this.toCam=this.h.camera.clampView(t,this.toCam)),this}zoomTo(t){t.cam=this.toCam,t.scene.camera.zoomTo(t)}}var B={Callback:L,Camera:L,CameraControl:N,CameraControlSecondButton:class extends N{mouseUp({event:t,position:[i,s],button:h,scene:e}){this.Kt[h]||(this.Kt[h]={});const r=this.Kt[h].Qt,n=t.changedTouches&&t.changedTouches.length||1,o=Math.max(this.Kt[h].ti,n);if(this.Kt[h].Qt=!1,this.Kt[h].ti-=n,!r||o>1)e.stopPropagation();else if((Date.now()-this.Kt[h].si>300||Math.abs(this.Kt[h].x-i)>=5||Math.abs(this.Kt[h].y-s)>=5)&&1===h){e.stopPropagation();const[r,n]=e.transformPoint(i,s),[o,a]=e.transformPoint(this.Kt[h].x,this.Kt[h].y);e.map("region",{event:t,x1:Math.min(o,r),y1:Math.min(a,n),x2:Math.max(o,r),y2:Math.max(a,n),fromX:o,fromY:a,toX:r,toY:n})}}mouseMove({event:t,position:[i,s],button:h,scene:e}){if(!this.Kt[h]||!this.Kt[h].Qt||0===t.which&&!t.touches)return;const r=e.additionalModifier.scaleCanvas;if(t.touches&&t.touches.length>=2){const n=t.touches,o=Math.sqrt((n[0].pageX-n[1].pageX)*(n[0].pageX-n[1].pageX)+(n[0].pageY-n[1].pageY)*(n[0].pageY-n[1].pageY));if(void 0===this.Kt[h].ii)o>0&&(this.Kt[h].ii=o,this.Kt[h].hi=this.toCam.zoom);else{this.toCam.zoom=Math.max(this.config.zoomMin,Math.min(this.config.zoomMax,this.Kt[h].hi*o/this.Kt[h].ii));const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,a]=t.transformPoint(this.Kt[h].x*r,this.Kt[h].y*r),[c,u]=t.transformPoint(i*r,s*r);this.toCam.x=this.Kt[h].Zt+n-c,this.toCam.y=this.Kt[h].Jt+a-u,this.toCam=e.camera.clampView(arguments[0],this.toCam)}}else{if(this.Kt[h].ii=void 0,2===h){const t=e.camera.viewportByCam(arguments[0],this.toCam).invert(),[n,o]=t.transformPoint(this.Kt[h].x*r,this.Kt[h].y*r),[a,c]=t.transformPoint(i*r,s*r);this.toCam.x=this.Kt[h].Zt+n-a,this.toCam.y=this.Kt[h].Jt+o-c,this.toCam=e.camera.clampView(arguments[0],this.toCam)}if(1===h&&e.has("regionMove")&&!(Date.now()-this.Kt[h].si<300&&Math.abs(this.Kt[h].x-i)<5&&Math.abs(this.Kt[h].y-s)<5)&&(!t.touches||1===t.touches.length)){const[r,n]=e.transformPoint(i,s),[o,a]=e.transformPoint(this.Kt[h].x,this.Kt[h].y);e.map("regionMove",{event:t,x1:Math.min(o,r),y1:Math.min(a,n),x2:Math.max(o,r),y2:Math.max(a,n),fromX:o,fromY:a,toX:r,toY:n})}}}},Click:class{constructor({doubleClickDetectInterval:t=350}={}){this.ri=t}mouseUp(t){const{scene:i,button:s}=t;1===s&&(i.has("doubleClick")?this.ni?(clearTimeout(this.ni),this.ni=0,i.map("doubleClick",t)):this.ni=setTimeout(()=>{this.ni=0,i.map("click",t)},this.ri):i.map("click",t))}},Element:class{constructor({doubleClickDetectInterval:t=350}={}){this.ri=t}isDrawFrame(){return this.oi?1:0}ai(t,i,s){i?t.has("doubleClickElement")?this.ni?(clearTimeout(this.ni),this.ni=0,t.map("doubleClickElement",s)):this.ni=setTimeout(()=>{this.ni=0,t.map("clickElement",s)},this.ri):t.map("clickElement",s):t.map("hoverElement",s)}ci(t,i,s){i?t.has("doubleClickNonElement")?this.ni?(clearTimeout(this.ni),this.ni=void 0,t.map("doubleClickNonElement",s)):this.ni=setTimeout(()=>{this.ni=void 0,t.map("clickNonElement",s)},this.ri):t.map("clickNonElement",s):t.map("hoverNonElement",s)}initSprites({scene:t,output:i,layerManager:s,canvasId:h}){if(this.oi=!1,this.ui||this.li){const e=!!this.ui,{mx:r,my:n}=this.ui||this.li,o=t.additionalModifier.scaleCanvas,a=i.context[h],c=Math.round(r/o),u=Math.round(n/o),[l,d]=t.transformPoint(r,n);a.save(),a.setTransform(...t.viewport().m);let f=0;if(s.forEach(({layerId:t,element:i,isFunction:s,elementId:h})=>{if(!s){const s=i.detect(a,c,u);if("c"===s)f="c";else if(s)return f={layerId:t,element:s,elementId:h},!1}}),a.restore(),"c"===f)this.oi=!0;else{this.ui=!1,this.li=!1;const i={mx:r,my:n,x:l,y:d};f?(Object.assign(i,f),this.ai(t,e,i)):this.ci(t,e,i)}}}draw({engine:t,scene:i,layerManager:s,output:h,canvasId:e}){if(!e&&this.oi){const r=!!this.ui,{mx:n,my:o}=this.ui||this.li,a=i.additionalModifier.scaleCanvas,c=h.context[e],u=Math.round(n/a),l=Math.round(o/a),[d,f]=i.transformPoint(n,o),m={mx:n,my:o,x:d,y:f},v=c.imageSmoothingEnabled;c.imageSmoothingEnabled=!1,c.clearRect(0,0,c.canvas.width,c.canvas.height),c.save(),c.setTransform(...i.viewport().m),s.forEach(({layerId:t,element:i,isFunction:s,elementId:h})=>{s||i.detectDraw(c,`rgb(${255&h}, ${(65280&h)>>8}, ${255&t})`)},0),c.restore(),c.imageSmoothingEnabled=v,t.normContext(c),this.ui=!1,this.li=!1;const p=c.getImageData(u,l,1,1).data;p[3]?(m.layerId=p[2],m.elementId=p[0]+(p[1]<<8),m.element=s.getById(m.layerId).getById(m.elementId),this.ai(i,r,m)):this.ci(i,r,m)}}mouseUp({scene:t,position:[i,s],button:h}){this.ui=1===h&&t.has("clickElement")&&{mx:i,my:s}}mouseMove({scene:t,position:[i,s]}){this.li=t.has("hoverElement")&&{mx:i,my:s}}},Event:class{constructor(){this.type="events"}di(t,i,s){f(s.value("preventDefault"),!0)&&i.preventDefault();const[h,e]=this.getMousePosition({event:i}),[r,n]=s.transformPoint(h,e);s.pipeBack(t,{event:i,position:[h,e],x:r,y:n,button:this.getMouseButton({event:i})})}events({scene:t}){return[t.has("mouseDown")&&[["touchstart","mousedown"],i=>this.di("mouseDown",i,t)],t.has("mouseUp")&&[["touchend","mouseup"],i=>this.di("mouseUp",i,t)],t.has("mouseOut")&&[["touchendoutside","mouseout"],i=>this.di("mouseOut",i,t)],t.has("mouseMove")&&[["touchmove","mousemove"],i=>this.di("mouseMove",i,t)],t.has("mouseWheel")&&[["wheel"],i=>this.di("mouseWheel",i,t)],f(t.value("preventDefault"),!0)&&[["contextmenu"],t=>t.preventDefault()]].filter(t=>t)}init({output:t,scene:i}){const s=t.canvas[0],h=i.map("events");this.i=h.filter(Array.isArray).reduce((t,i)=>(t.push.apply(t,i),t),[]).map(t=>Array.isArray(t)?t:[[t],s=>{f(i.value("preventDefault"),!0)&&s.preventDefault(),i.pipeBack(t,{event:s})}]).map(([t,i])=>t.map(t=>({n:s,e:t,f:i}))).reduce((t,i)=>(Array.isArray(i)?t.push.apply(t,i):t.push(i),t),[]),this.i.forEach(t=>{t.n.addEventListener(t.e,t.f,!0)})}destroy(){this.i.forEach(t=>{t.n.removeEventListener(t.e,t.f,!0)}),this.i=[]}getMousePosition({event:t}){let i;if(t.touches&&t.touches.length>0?i=t.targetTouches:t.changedTouches&&t.changedTouches.length>0&&(i=t.changedTouches),i){const s=t.target.getBoundingClientRect(),h=i.length;return i=Array.from(i),[i.reduce((t,i)=>t+i.pageX,0)/h-s.left,i.reduce((t,i)=>t+i.pageY,0)/h-s.top]}if(void 0===t.offsetX){const i=t.target.getBoundingClientRect();return[t.clientX-i.left,t.clientY-i.top]}return[t.offsetX,t.offsetY]}getMouseButton({event:t}){return t.touches?t.touches.length||t.changedTouches.length:f(t.buttons?t.buttons:[0,1,4,2][t.which],1)}},LoadingScreen:class{loading({output:t,progress:i}){const s=t.context[0],h="number"==typeof i?Math.max(1,i*t.height):t.height;s.globalCompositeOperation="source-over",s.globalAlpha=1,s.clearRect(0,0,t.width,t.height),s.fillStyle="#aaa",s.fillRect(0,t.height/2-h/2,t.width,h),s.font="20px Georgia",s.fillStyle="#fff",s.textAlign="left",s.textBaseline="bottom",s.fillText(isNaN(parseFloat(i))?i:"Loading "+Math.round(100*i)+"%",10+3*Math.random(),t.height-10+3*Math.random())}},Norm:class{viewport({engine:t},i){const s=t.getWidth()/2,h=t.getHeight()/2,e=t.getRatio()>1?s:h;return i.translate(s,h).scale(e,e)}additionalModifier({engine:t,output:i,scene:s}){s.cacheClear();const h={alpha:1,x:-1,y:-1,width:2,height:2,widthInPixel:i.width,heightInPixel:i.height,scaleCanvas:i.width/i.canvas[0].clientWidth},[e,r]=s.transformPoint(0,0,1),[n,o]=s.transformPoint(i.width,i.height,1);h.visibleScreen={x:e,y:r,width:n-e,height:o-r};const a=t.getWidth()/2,c=t.getHeight()/2,u=t.getRatio()>1?a:c,l=(new d).translate(a,c).scale(u,u).invert(),[f,m]=l.transformPoint(0,0,1),[v,p]=l.transformPoint(i.width,i.height,1);return h.fullScreen={x:f,y:m,width:v-f,height:p-m},h}},TimingAudio:class extends m{constructor(t={}){super(t),this.G=Number.POSITIVE_INFINITY,this.fi=null,this.mi=null,this.vi=!1,this.pi=this.H.audioElement}get audioElement(){return this.pi}init(){if(this.pi)return"function"==typeof MediaController&&(this.pi.controller=new MediaController,this.vi=!0),this.pi.preload="auto",new Promise(t=>{let i=()=>{this.pi.removeEventListener("canplaythrough",i);let s=this.pi.play();s&&s.catch(t=>{}),t()};this.pi.addEventListener("canplaythrough",i),this.pi.load()})}endTime(){return this.pi?1e3*this.pi.duration:Number.POSITIVE_INFINITY}currentTime(){let t=super.currentTime();if(this.pi){if(this.pi.ended&&this.pi.duration)return 1e3*this.pi.duration;const i=1e3*this.pi.currentTime;if(this.vi){if(null===this.fi)return this.fi=t,this.mi=i,i;if("playing"===this.pi.controller.playbackState){if(i===this.mi)return this.mi+Math.min(260,t-this.fi);if(i-this.mi<500&&i>this.mi&&t-this.fi<350)return this.fi=this.fi+(i-this.mi),this.mi=i,this.mi+t-this.fi}return this.fi=t,this.mi=i,this.mi}return i}return t}clampTime({timePassed:t}){return t}shiftTime(){return 0}},TimingDefault:m};export{D as Animations,a as Engine,c as ImageManager,B as Middleware,w as Scene,E as Sprites};
